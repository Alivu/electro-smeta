<!DOCTYPE html>
<html lang="ru">
<head>
<script src="price-data.js"></script>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106281592', 'ym');

    ym(106281592, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<meta charset="UTF-8">
<noscript><div><img src="https://mc.yandex.ru/watch/106281592" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Open Graph для соцсетей и мессенджеров -->
<meta property="og:title" content="ЭлектроСмета — профессиональный расчет от Electric_Group">
<meta property="og:description" content="Прайс-лист и смета для электромонтажных работ. Быстро, удобно, для братьев.">
<meta property="og:image" content="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-512x512.png">
<meta property="og:url" content="https://electro-smeta.vercel.app">
<meta property="og:type" content="website">
<meta property="og:site_name" content="ЭлектроСмета">

<!-- Для Twitter (опционально) -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ЭлектроСмета">
<meta name="twitter:description" content="Профессиональный расчет смет для электриков">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Alivu/electro-smeta/main//-512x512.png">


    

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
       
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-title" content="ЭлектроСмета">
    <meta name="application-name" content="ЭлектроСмета">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <!-- s -->
    <link rel="apple-touch-icon" sizes="180x180" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-16x16.png">
    <link rel="icon" type="image/png" sizes="48x48" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-96x96.png">
        <link rel="icon" type="image/png" sizes="128x128" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-128x128.png">
        <link rel="icon" type="image/png" sizes="144x144" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-192x192.png">
        <link rel="icon" type="image/png" sizes="384x384" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-512x512.png">
    <link rel="shortcut icon" 
          href="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-32x32.png">
 <!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
    
    <title>профессиональный расчет от Electric_Group для Братьев</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    
    <style>
		#editorBtn {
    display: none !important;
}

/* Класс для показа кнопки */
#editorBtn.show-editor {
    display: flex !important;
}
        /* Общие стили */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            
            /* Переменная для масштабирования */
            --scale-factor: 1;
        }
        
.estimate-scale-container {
    overflow: auto !important;
    max-height: calc(100vh - 300px) !important;
    width: 100% !important;
    -webkit-overflow-scrolling: touch !important;
    position: relative !important;
    left: 0 !important;
    right: 0 !important;
    display: block !important;  /* Убираем flex */
    justify-content: flex-start !important; /* Сбрасываем центрирование */
}
        
        /* Новые стили для коэффициентов и скидок */
        .coefficient-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .discount-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .comment-badge {
            display: inline-block;
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: normal;
            cursor: pointer;
        }
        
		.row-modifiers {
			margin-top: 3px;
			font-size: 11px;
			color: #666;
			display: flex;
			flex-wrap: wrap;
			gap: 3px;
			min-height: 20px; /* Фиксированная минимальная высота */
		}
		.estimate-table td.price-cell,
		.estimate-table td.quantity-cell {
			vertical-align: middle;
		}
        
        .row-modifier {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        
/* ========== ПАНЕЛЬ ГЛОБАЛЬНЫХ НАСТРОЕК ========== */
.global-modifiers-panel {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}
        
        .global-modifier-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .global-modifier-item label {
            font-size: 13px;
            color: #ecf0f1;
        }
        
        .global-modifier-item input {
            width: 70px;
            padding: 5px;
            border: none;
            border-radius: 4px;
            text-align: center;
            background: white;
        }
        
        .global-modifier-item input[type="text"] {
            width: 150px;
        }
        
        /* Кнопки масштабирования */
        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        
        .zoom-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .zoom-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .zoom-reset {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* Модальное окно для коэффициента/скидки */
        .row-settings-modal {
            max-width: 400px;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .settings-tab {
            padding: 8px 15px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .settings-tab.active {
            background: var(--secondary);
            color: white;
        }
        
        .settings-content {
            display: none;
        }
        
        .settings-content.active {
            display: block;
        }
        
        .settings-field {
            margin-bottom: 15px;
        }
        
        .settings-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .settings-field input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .settings-field small {
            color: #666;
            font-size: 11px;
            display: block;
            margin-top: 3px;
        }
        
        .row-total-preview {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: bold;
            text-align: right;
            border-left: 4px solid var(--secondary);
        }
        
        .base-price {
            font-size: 12px;
            color: #666;
            margin-right: 10px;
        }
        
        /* Другие ваши существующие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* Шапка */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-: 5px;
            padding-: 10px;
            border-: 1px solid var(--secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo-icon {
            color: var(--secondary);
            font-size: 1.3rem;
        }

        .logo-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Панель навигации */
        .nav-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-: 5px;
            padding: 5px;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: var(--shadow);
        }

        /* Вкладки */
        .tabs {
            display: flex;
            flex: 1;
            min-width: 200px;
            height: 40px;
        }

        .tab {
            flex: 1;
            padding: 12px 12px;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        /* Контейнер контента */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
            min-height: 500px;
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

        /* Вкладка 1: Прайс-лист */
        .price-header {
            background: linear-gradient(100deg, #1a237e 20%, #283593 100%);
            color: white;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        @media (min-width: 768px) {
            .price-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .price-header h2 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            position: relative;
            width: 100%;
            height: 31px;
            top: -2px;
        }

        @media (min-width: 768px) {
            .search-box {
                width: 300px;
            }
        }

        .search-box input {
            width: 100%;
            padding: 5px 10px 5px 30px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .search-box input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .price-list-container {
            height: calc(100vh - 250px);
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }

        .price-section {
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .section-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 6px 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .section-content.expanded {
            max-height: 5000px;
        }

        .price-item {
            display: grid;
            grid-template-columns: 50px 1fr 60px 80px;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .price-item:hover {
            background: #f0f7ff;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .item-number {
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            background: #f0f8ff;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .item-name {
            font-size: 0.85rem;
            word-break: break-word;
            line-height: 1.3;
        }

        .item-unit {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .item-price {
            text-align: right;
            font-weight: 600;
            color: var(--success);
            font-size: 0.85rem;
        }

/* Вкладка 2: Смета */
.estimate-table-container {
    height: calc(100vh - 300px);
    max-height: 500px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 15px;
}

.estimate-table th,
.estimate-table td {
    padding: 8px 6px;
    font-size: 0.85rem;
}

.estimate-table td.unit-cell,
.estimate-table td.total-cell,
.estimate-table td.price-id-cell {
    border: 1px solid #ddd;              /* Рамка как у полей ввода */
    border-radius: 3px;                  /* Скругленные углы */
    padding: 6px 8px;                    /* Внутренние отступы */
    background: white;                   /* Белый фон */
    height: 34px;                        /* Фиксированная высота (32px поле + 2px рамка) */
    min-height: 34px;                    /* Минимальная высота */
    line-height: 18px;                   /* Межстрочный интервал для вертикального центрирования */
    box-sizing: border-box;              /* Padding входит в общую ширину/высоту */
    vertical-align: middle;              /* Вертикальное выравнивание по центру */
    text-align: center;                  /* Горизонтальное выравнивание по центру */
    font-size: 0.85rem;                  /* Размер шрифта */
    min-height: 34px;                    /* Минимальная высота (дублирует height) */
    max-height: 34px;                    /* Максимальная высота */
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); /* Внутренняя тень как у полей ввода */
}
/* Колонка "Код" - дополнительные стили */
.estimate-table td.price-id-cell {
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    font-weight: 600;                    /* Полужирный шрифт */
    color: var(--secondary);             /* Цвет из переменной CSS (синий) */
    background: #f8f9fa;                 /* Светло-серый фон */
}

/* Колонка "Ед. изм." - дополнительные стили */
.estimate-table td.unit-cell {
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    color: #555;                         /* Темно-серый цвет текста */
}
        
/* Колонка "Сумма, руб." - дополнительные стили */
.estimate-table td.total-cell {
    width: 110px;                        /* Фиксированная ширина */
    min-width: 110px;                    /* Минимальная ширина */
    max-width: 110px;                    /* Максимальная ширина */
    font-weight: 600;                    /* Полужирный шрифт */
    color: var(--success);               /* Цвет из переменной CSS (зеленый) */
    background: #f8fff9;                 /* Светло-зеленый фон */
    border-color: #c3e6cb;               /* Зеленая рамка */
}

/* ========== ПРАВИЛЬНЫЕ ШИРИНЫ ДЛЯ ВСЕХ КОЛОНОК ========== */

/* Колонка 1: "Код" - заголовок и ячейки */
.estimate-table th:nth-child(1),         /* Первый th (заголовок) */
.estimate-table td:nth-child(1) {        /* Первые td всех строк */
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* Колонка 3: "Ед. изм." - заголовок и ячейки */
.estimate-table th:nth-child(3),         /* Третий th (заголовок) */
.estimate-table td:nth-child(3) {        /* Третьи td всех строк */
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* ========== УВЕЛИЧЕНИЕ КОЛОНКИ "ЦЕНА" ========== */
.estimate-table th:nth-child(4),
.estimate-table td:nth-child(4) {
    width: 80px !important;
    min-width: 80px !important;
    max-width: 80px !important;
    white-space: nowrap !important;
    overflow: visible !important;
    text-align: center;
    padding: 6px 6px !important;
}

/* Увеличить поле ввода цены */
.price-input {
    width: 80px !important;
    min-width: 80px !important;
    padding: 6px 4px !important;
    font-size: 0.9rem !important;
    margin-left: -6px !important
   
}

/* Колонка 5: "Кол-во" - заголовок и ячейки */
.estimate-table th:nth-child(5),         /* Пятый th (заголовок) */
.estimate-table td:nth-child(5) {        /* Пятые td всех строк */
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
    padding: 6px 6px;                    /* Внутренние отступы */
}

            /* Увеличить поле Количества */
.quantity-input {
    width: 70px !important;
    min-width: 70px !important;
    padding: 6px 4px !important;
    font-size: 0.9rem !important;
    margin-left: -6px !important
}

/* Колонка 6: "Сумма, руб." - заголовок и ячейки */
.estimate-table th:nth-child(6),         /* Шестой th (заголовок) */
.estimate-table td:nth-child(6) {        /* Шестые td всех строк */
    width: 110px;                        /* Фиксированная ширина */
    min-width: 110px;                    /* Минимальная ширина */
    max-width: 110px;                    /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* Колонка 7: "Действия" - заголовок и ячейки (корзина) */
.estimate-table th:nth-child(7),         /* Седьмой th (заголовок) */
.estimate-table td:nth-child(7) {        /* Седьмые td всех строк */
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* ========== МОБИЛЬНАЯ ВЕРСИЯ (экраны до 767px) ========== */
@media (max-width: 767px) {
    /* Уменьшаем размеры для ячеек "Код", "Ед. изм.", "Сумма" */
    .estimate-table td.price-id-cell,
    .estimate-table td.unit-cell,
    .estimate-table td.total-cell {
        padding: 4px 6px;                /* Меньшие отступы */
        font-size: 0.8rem;               /* Меньший шрифт */       
    }
    
    /* Колонка "Код" - уменьшенные размеры */
    .estimate-table td.price-id-cell {
        width: 40px;                     /* Уже на мобильных */
        min-width: 40px;
        max-width: 40px;
        text-align: center;                  /* Выравнивание по центру */
    }
      

    /* Колонка "Ед. изм." - уменьшенные размеры */
    .estimate-table td.unit-cell {
        width: 70px;                     /* Уже на мобильных */
        min-width: 70px;
        max-width: 70px;
    }
    
    /* Колонка "Сумма, руб." - уменьшенные размеры */
    .estimate-table td.total-cell {
        width: 90px;                     /* Уже на мобильных */
        min-width: 90px;
        max-width: 90px;
    }
    
    /* Колонка 1: "Код" - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(1),
    .estimate-table td:nth-child(1) {
        width: 40px;                     /* Уже на мобильных */
        min-width: 40px;
        max-width: 40px;
        text-align: center;                  /* Выравнивание по центру */
    
    }
    
    /* Колонка 3: "Ед. изм." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(3),
    .estimate-table td:nth-child(3) {
        width: 70px;                     /* Уже на мобильных */
        min-width: 70px;
        max-width: 70px;
    }
    
    /* Колонка 4: "Цена, руб." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(4),
    .estimate-table td:nth-child(4) {
        width: 80px;                     /* Уже на мобильных */
        min-width: 80px;
        max-width: 80px;
    }
    
    /* Колонка 5: "Кол-во" - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(5),
    .estimate-table td:nth-child(5) {
        width: 60px;                     /* Уже на мобильных */
        min-width: 60px;
        max-width: 60px;
    }
    
    /* Колонка 6: "Сумма, руб." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(6),
    .estimate-table td:nth-child(6) {
        width: 90px;                     /* Уже на мобильных */
        min-width: 90px;
        max-width: 90px;
    }
}

        .estimate-table {
            width: 100%;
            border-collapse: collapse;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 30px;
            line-height: 22px;
            overflow: hidden;
            min-width: 1050px;
        }

        .estimate-table thead {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .estimate-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .estimate-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .estimate-table tbody tr:hover {
            background: #f9f9f9;
        }

        .estimate-table tbody tr.material-row {
            background-color: #fff8e1;
        }

        .estimate-table td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }

        .search-cell {
            position: relative;
            min-width: 150px;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .dropdown-item {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .dropdown-item:hover {
            background: #f0f7ff;
        }

        .number-input {
            width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .unit-cell, .price-cell, .total-cell {
            font-weight: 500;
            text-align: center;
        }

        .total-cell {
            color: var(--success);
            font-weight: 600;
        }

        .actions-cell {
            text-align: center;
            width: 40px;
        }

        .delete-row {
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .estimate-totals {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .total-row:last-child {
            margin-bottom: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .total-value {
            font-weight: 600;
            color: var(--success);
        }

        /* Кнопки */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
            background: var(--secondary);
            color: white;
            text-decoration: none;
            user-select: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-info {
            background: #17a2b8;
        }

        /* Управление */
        .estimate-controls {
            display: flex;
            gap: 8px;
        }

        .dropdown-controls {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 160px;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #333;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Адаптивность для мобильных */
        @media (max-width: 767px) {
            .container {
                padding: 2px 2px;
            }
            
            .header {
                min-height: 20px !important;
                padding: 2px 0;
                margin-bottom: 2px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .logo {
                transform: none !important;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px !important;
            }
    
            .logo-text {
                font-size: 0.8rem !important;
                text-align: center !important;
                display: block !important;
                vertical-align: middle !important;
            }
            
            .nav-panel {
                flex-direction: column !important;
                align-items: stretch !important;
                padding: 0 !important;
                margin: 0 !important;
                gap: 0 !important;
                row-gap: 0 !important;
            }
            
            .tabs {
                width: 100%;
                height: 32px !important;
            }
            
            .tab {
                padding: 6px 8px !important;
                font-size: 0.8rem !important;
            }
            
            .btn {
                padding: 6px 10px !important;
                font-size: 0.8rem !important;
            }
            
            .estimate-controls {
                display: grid;
                grid-template-columns: 50% 50%;
                gap: 0;
                margin-bottom: 1px;
            }
            
            .estimate-controls .btn {
                border-radius: 0;
                margin: 0;
                padding: 8px 2px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                font-size: 0.75rem !important;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 32px !important;
                min-height: 32px !important;
                line-height: 1 !important;
            }
            
            #printPriceBtn {
                font-size: 0.7rem !important;
                padding: 8px 1px !important;
            }
            
            .btn i {
                font-size: 0.8rem !important;
                margin-right: 3px !important;
            }
            
            .dropdown-toggle {
                min-width: 100%;
                justify-content: center;
            } 
            .price-item {
                grid-template-columns: 35px minmax(100px, 1fr) 45px 60px;
                gap: 6px;
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .item-number {
                font-size: 0.8rem;
            }
            
            .item-name {
                font-size: 0.8rem;
            }
            
            .item-unit {
                font-size: 0.75rem;
            }
            
            .item-price {
                font-size: 0.8rem;
            }
            
            .price-list-container {
                height: calc(100vh - 200px);
            }
            
            .estimate-table-container {
                height: calc(100vh - 250px);
                padding: 10px;
            }
            
            .estimate-table th,
            .estimate-table td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }

    /* Уменьшение колонки Код */
    .estimate-table th:nth-child(1),
    .estimate-table td:nth-child(1) {
        width: 40px;
        min-width: 40px;
        max-width: 40px;
        padding: 6px 2px;
        font-size: 0.75rem;
        border-left: 2px solid #f8f9fa;
        padding-left: 6px !important;
        text-indent: 2px;
        border-left: 1px solid #ddd;
        border-right: 1px solid #ddd;
    }

            
            .search-input {
                font-size: 0.8rem;
                padding: 5px 6px;
            }
            
            .number-input {
                width: 50px;
                padding: 4px;
                font-size: 0.8rem;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                padding: 15px;
                max-height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .price-item {
                grid-template-columns: 35px 1fr 35px 60px;
                gap: 4px;
                padding: 5px 6px;
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        /* Исправления для iOS */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        .no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .estimate-table td.price-id-cell,
        .estimate-table td.unit-cell,
        .estimate-table td.total-cell {
            margin-top: 10px !important;
            margin-bottom: 10px !important;
            display: inline-block !important;
        }

        @media (max-width: 767px) {   
            .estimate-table td.price-id-cell {
                text-align: center;
            }
            .estimate-table th:nth-child(1),
            .estimate-table td:nth-child(1) {
                text-indent: -3px;
            }  
            
            .stats-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(90deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 10px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.85rem;
                z-index: 9999;
                border-top: 3px solid #3498db;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            }

            .stats-left {
                display: flex;
                gap: 20px;
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 500;
            }

            .stat-item i {
                color: #3498db;
                font-size: 1rem;
            }

            .stat-item strong {
                color: #f1c40f;
                font-weight: 700;
            }

            .like-btn {
                background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
                font-weight: 600;
                transition: all 0.3s;
                box-shadow: 0 2px 5px rgba(39, 174, 96, 0.3);
            }

            .like-btn:hover {
                background: linear-gradient(90deg, #219653 0%, #27ae60 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4);
            }

            .like-btn.liked {
                background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
                cursor: not-allowed;
            }

            @media (max-width: 767px) {
                .stats-bar {
                    flex-direction: row !important;
                    padding: 6px 8px !important;
                    height: 40px !important;
                }
                
                .stats-left {
                    display: flex !important;
                    gap: 8px !important;
                    flex: 1 !important;
                    overflow-x: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                    padding-right: 5px !important;
                }
                
                .stat-item {
                    flex-shrink: 0 !important;
                    font-size: 0.7rem !important;
                    gap: 3px !important;
                    white-space: nowrap !important;
                }
                
                .stat-item i {
                    font-size: 0.8rem !important;
                }
                
                .stat-item strong {
                    font-size: 0.75rem !important;
                }
                
                @media (max-width: 350px) {
                    .stat-item:nth-child(1) span:not(strong),
                    .stat-item:nth-child(2) span:not(strong) {
                        display: none !important;
                    }
                    
                    .stat-item {
                        gap: 2px !important;
                    }
                }
                
                .like-btn {
                    width: auto !important;
                    padding: 4px 10px !important;
                    font-size: 0.75rem !important;
                    flex-shrink: 0 !important;
                    margin-left: auto !important;
                }
                
                .stats-bar > div > button[onclick*="location.reload"] {
                    display: none !important;
                }
            }

            @media (max-width: 480px) {
                .stats-bar {
                    padding: 5px 6px !important;
                    height: 38px !important;
                }
                
                .stats-left {
                    gap: 6px !important;
                }
                
                .stat-item {
                    font-size: 0.65rem !important;
                }
                
                .stat-item i {
                    font-size: 0.75rem !important;
                }
                
                .like-btn {
                    padding: 3px 8px !important;
                    font-size: 0.7rem !important;
                }
            }
        }

        /* Стили для иконки приложения */
        .app-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 12px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .app-icon:hover {
            transform: scale(1.05);
        }

        @media (max-width: 767px) {
            .app-icon {
                width: 48px;
                height: 48px;
                margin-right: 4px;
            }
            
            .logo-icon {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .app-icon {
                width: 40px;
                height: 40px;
                margin-right: 2px;
            }
            
            .logo-icon {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 767px) {
            .price-item {
                grid-template-columns: 38px minmax(150px, 1fr) 40px 56px !important;
                gap: 4px !important;
                padding: 8px 10px !important;
                font-size: 0.85rem !important;
            }
            
            .item-name {
                font-size: 0.82rem !important;
                line-height: 1.3 !important;
                word-break: break-word !important;
            }
            
            .item-unit {
                font-size: 0.75rem !important;
                white-space: nowrap !important;
                min-width: 45px !important;
                text-align: center !important;
            }
            
            .item-price {
                font-size: 0.85rem !important;
                font-weight: 600 !important;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) {
            .price-item {
                grid-template-columns: 45px minmax(150px, 1fr) 55px 85px !important;
                gap: 10px !important;
                padding: 10px 12px !important;
            }
        }

        @media (max-width: 480px) {
            .price-item {
                grid-template-columns: 30px minmax(80px, 1fr) 40px 56px !important;
                gap: 2px !important;
                padding: 6px 8px !important;
                font-size: 0.78rem !important;
            }
        }

        .item-number.video-available {
            cursor: pointer;
            position: relative;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .item-number.video-available::after {
            content: '🎬';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 12px;
            background: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .video-available-code {
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
            text-decoration: underline dotted;
            position: relative;
        }
        
        .video-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 767px) {
            .item-number.video-available::after {
                right: 2px !important;
                width: 14px;
                height: 14px;
                font-size: 10px;
                top: -6px;
                right: -6px;
            }
        }

/* ========== АДАПТАЦИЯ ПАНЕЛИ ГЛОБАЛЬНЫХ НАСТРОЕК ========== */
@media (max-width: 767px) {
  
    .global-modifier-item {
        width: 100% !important;
        justify-content: space-between !important;
        background: rgba(255,255,255,0.15) !important;
        padding: 8px 12px !important;
    }
    
    .global-modifier-item label {
        font-size: 14px !important;
        white-space: nowrap !important;
    }
    
    .global-modifier-item input {
        width: 120px !important;
        height: 36px !important;
        font-size: 16px !important;
    }
    
    .global-modifier-item input[type="text"] {
        width: 180px !important;
    }
    
    .zoom-controls {
        width: 100% !important;
        justify-content: center !important;
        margin-left: 0 !important;
        margin-top: 5px !important;
    }
}

/* ========== ИСПРАВЛЕНИЕ МАСШТАБИРОВАНИЯ ========== */
:root {
    --min-zoom: 0.5;
    --max-zoom: 1.5;
}

.estimate-scale-container {
    overflow: auto !important;
    max-height: calc(100vh - 300px) !important;
    width: 100% !important;
}

/* ========== МАСШТАБИРОВАНИЕ СМЕТЫ ========== */
.estimate-scalable {
    transform: scale(var(--scale-factor, 1));
    transform-origin: 0 0 !important;  /* Всегда от левого верхнего угла */
    width: fit-content !important;
    min-width: 100% !important;
    transition: transform 0.2s ease !important;
    margin: 0 !important;
    padding: 0 !important;
    display: inline-block !important;
    position: relative !important;
    left: 0 !important;
    top: 0 !important;
}
/* ========== ИСПРАВЛЕНИЕ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ ========== */
@media (max-width: 767px) {
    /* Основной контейнер с прокруткой */
    .estimate-scale-container {
        max-height: calc(100vh - 250px) !important;
        -webkit-overflow-scrolling: touch !important;
        overflow-x: auto !important;
        overflow-y: auto !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        position: relative !important;
    }
    
    /* Масштабируемый контент */
    .estimate-scalable {
        transform: scale(var(--scale-factor, 1)) !important;
        transform-origin: 0 0 !important;
        width: fit-content !important;
        min-width: 100% !important;
        display: inline-block !important;
        margin: 0 !important;
        padding: 0 !important;
        transition: transform 0.2s ease !important;
        will-change: transform !important;
        -webkit-transform: scale(var(--scale-factor, 1)) !important;
        -webkit-transform-origin: 0 0 !important;
    }
    
    /* Контейнер сметы */
    #estimate-tab {
        overflow: visible !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    
    /* Контейнер таблицы */
    .estimate-table-container {
        padding: 0 !important;
        margin: 0 !important;
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
    }
    
    /* Таблица */
    .estimate-table {
        min-width: 800px !important;
        margin: 0 !important;
        border-collapse: collapse !important;
    }
    
    /* Убираем лишние display: flex */
    .estimate-scale-container {
        display: block !important;
        justify-content: flex-start !important;
    }
}
/* Фиксированная ширина таблицы */
.estimate-table {
    min-width: 800px !important;  /* Минимальная ширина для мобильных */
    width: auto !important;
    table-layout: auto !important;
}

/* Разрешаем перенос для названия при необходимости */
.estimate-table td.search-cell {
    white-space: normal !important;
    word-break: break-word !important;
}
/* ========== АДАПТАЦИЯ ПАНЕЛИ ГЛОБАЛЬНЫХ НАСТРОЕК ========== */
@media (max-width: 767px) {
    .global-modifiers-panel {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
        padding: 8px !important;
    }
    
    .global-modifier-item {
        width: 100% !important;
        justify-content: space-between !important;
        background: rgba(255,255,255,0.15) !important;
        padding: 8px 12px !important;
    }
    
    .global-modifier-item label {
        font-size: 14px !important;
        white-space: nowrap !important;
    }
    
    .global-modifier-item input {
        width: 120px !important;
        height: 36px !important;
        font-size: 16px !important;
    }
    
    .global-modifier-item input[type="text"] {
        width: 180px !important;
    }
    
    .zoom-controls {
        width: 100% !important;
        justify-content: center !important;
        margin-left: 0 !important;
        margin-top: 5px !important;
    }
}
/* Скрытие панели */
.global-modifiers-panel.hidden {
    display: none !important;
}
@media (max-width: 767px) {
    #toggleGlobalPanel {
        padding: 8px 10px !important;
        font-size: 0.8rem !important;
        min-height: 32px !important;
        touch-action: manipulation; /* Улучшает отзывчивость на тач */
    }
}


/* ========== ЗАГОЛОВКИ ТАБЛИЦЫ СМЕТЫ ========== */

.estimate-table thead tr {
    background: var(--primary) !important;  /* Темно-синий фон */
    height: 30px !important;  /* Общая высота заголовка */
}

.estimate-table th {
    color: white !important;
    font-weight: 600 !important;
    padding: 0 6px !important;  /* Убираем вертикальные отступы, только горизонтальные */
    font-size: 10px !important;
    white-space: nowrap !important;
	    /* Выравнивание по центру вертикали */
    vertical-align: middle !important;
    line-height: 1 !important;  /* Убираем лишний межстрочный интервал */
    
    /* Для flex-выравнивания если потребуется */
    display: table-cell !important;
}

/* Индивидуальные ширины колонок */
.estimate-table th:nth-child(1) {  /* Код */
    width: 30px !important;
	
    text-align: center !important;
}

.estimate-table th:nth-child(2) {  /* Наименование */
    text-align: left !important;
}

.estimate-table th:nth-child(3) {  /* Ед. изм. */
    width: 70px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(4) {  /* Цена, руб. */
    width: 80px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(5) {  /* Кол-во */
    width: 60px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(6) {  /* Сумма, руб. */
    width: 110px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(7) {  /* Кнопка удалить */
    width: 40px !important;
    text-align: center !important;
}

/* ========== АДАПТАЦИЯ ДЛЯ МОБИЛЬНЫХ ========== */
@media (max-width: 767px) {
    .estimate-table thead tr {
        height: 32px !important;  /* Чуть ниже на мобильных */
    }
    .estimate-table th {
        font-size: 9px !important;
        padding: 0 3px !important;
    }
    
    .estimate-table th:nth-child(1) { width: 35px !important; }
    .estimate-table th:nth-child(3) { width: 45px !important; }
    .estimate-table th:nth-child(4) { width: 60px !important; }
    .estimate-table th:nth-child(5) { width: 40px !important; }
    .estimate-table th:nth-child(6) { width: 70px !important; }
    }
}
/* ========== АДАПТАЦИЯ ШАПКИ ДЛЯ ТЕЛЕФОНА ========== */
@media (max-width: 767px) {
    .global-modifiers-panel {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 6px !important;
        padding: 6px !important;
    }
    
    .global-modifier-item {
        width: 100% !important;
        justify-content: space-between !important;
        padding: 6px 8px !important;
    }
    
    .global-modifier-item input {
        width: 100px !important;
    }
    
    .global-modifier-item input[type="text"] {
        width: 160px !important;
    }
    
    .zoom-controls {
        width: 100% !important;
        justify-content: center !important;
        margin-left: 0 !important;
        margin-top: 5px !important;
    }
}
/* ========== АДАПТАЦИЯ СМЕТЫ ДЛЯ ТЕЛЕФОНА ========== */
@media (max-width: 767px) {
    /* Контейнер с прокруткой */
    .estimate-scale-container {
        max-height: calc(100vh - 250px) !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    /* Уменьшаем шрифты еще больше */
    .estimate-table {
        font-size: 8px !important;
        min-width: 600px !important; /* Минимальная ширина для горизонтального скролла */
    }
    
    .estimate-table th {
        padding: 3px 2px !important;
        font-size: 8px !important;
    }
    
    .estimate-table td {
        padding: 2px 1px !important;
        font-size: 8px !important;
        height: 28px !important;
        min-height: 28px !important;
    }
    
    /* Поля ввода на телефоне */
    .estimate-table input {
        height: 22px !important;
        font-size: 8px !important;
        padding: 1px !important;
    }
    
    /* Колонки на телефоне */
    .estimate-table .price-id-cell {
        width: 30px !important;
        min-width: 30px !important;
        padding: 1px 6 !important;
    }
    
    .estimate-table .unit-cell {
        width: 35px !important;
        min-width: 35px !important;
    }
    
    .estimate-table .total-cell {
        width: 60px !important;
        min-width: 60px !important;
    }
    
    .estimate-table th:nth-child(4),
    .estimate-table td:nth-child(4) {
        width: 50px !important;
        min-width: 50px !important;
    }
    
    .estimate-table th:nth-child(5),
    .estimate-table td:nth-child(5) {
        width: 35px !important;
        min-width: 35px !important;
    }
    
    .estimate-table th:nth-child(6),
    .estimate-table td:nth-child(6) {
        width: 60px !important;
        min-width: 60px !important;
    }
    
/* Наименование на телефоне - УМЕНЬШЕНО */

    
    /* Значки коэффициентов */
    .row-modifiers span {
        font-size: 6px !important;
        padding: 1px 2px !important;
        height: 12px !important;
        line-height: 10px !important;
    }
    
    /* Итоги на телефоне */
    .estimate-totals {
        padding: 5px !important;
    }
    
    .estimate-totals .total-row {
        font-size: 8px !important;
        margin-bottom: 2px !important;
    }
    
    .estimate-totals .total-row:last-child {
        font-size: 10px !important;
        padding-top: 3px !important;
    }
}


/* ========== ВЫПАДАЮЩЕЕ МЕНЮ ========== */

/* Контейнер меню */
.dropdown-menu {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    background: white !important;
    border: 1px solid #ddd !important;
    border-radius: 6px !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
    min-width: 220px !important;
    z-index: 9999 !important;
    margin-top: 5px !important;
    padding: 5px 0 !important;
    font-size: 12px !important;
}

/* Элементы меню */
.dropdown-menu .dropdown-item {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    padding: 8px 15px !important;
    color: #333 !important;
    text-decoration: none !important;
    transition: background 0.2s !important;
    border: none !important;
    background: none !important;
    width: 100% !important;
    text-align: left !important;
    cursor: pointer !important;
    font-size: 12px !important;
}

/* Иконки в меню */
.dropdown-menu .dropdown-item i {
    width: 18px !important;
    color: #3498db !important;
    font-size: 14px !important;
}

/* Разделитель */
.dropdown-menu .dropdown-divider {
    height: 1px !important;
    background: #eee !important;
    margin: 5px 0 !important;
}

/* Адаптация для мобильных */
@media (max-width: 767px) {
    .dropdown-menu {
        position: fixed !important;
        top: auto !important;
        left: 5% !important;
        right: 5% !important;
        bottom: 10px !important;
        max-height: 70vh !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        border-radius: 10px !important;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2) !important;
    }
    
    .dropdown-menu .dropdown-item {
        padding: 12px 15px !important;
        font-size: 14px !important;
    }
}
/* ========== ЗАГОЛОВКИ ТАБЛИЦЫ СМЕТЫ ========== */
.estimate-table thead tr {
    background: var(--primary) !important;  /* Темно-синий фон */
    height: 40px !important;  /* Общая высота заголовка */
}

.estimate-table th {
    color: white !important;
    font-weight: 600 !important;
    padding: 0 6px !important;  /* Убираем вертикальные отступы, только горизонтальные */
    font-size: 11px !important;
    white-space: nowrap !important;
    
    /* Выравнивание по центру вертикали */
    vertical-align: middle !important;
    line-height: 1 !important;  /* Убираем лишний межстрочный интервал */
    
    /* Для flex-выравнивания если потребуется */
    display: table-cell !important;
}

/* Индивидуальные ширины колонок */
.estimate-table th:nth-child(1) {  /* Код */
    width: 40px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(2) {  /* Наименование */
    text-align: left !important;
}

.estimate-table th:nth-child(3) {  /* Ед. изм. */
    width: 70px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(4) {  /* Цена, руб. */
    width: 80px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(5) {  /* Кол-во */
    width: 60px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(6) {  /* Сумма, руб. */
    width: 110px !important;
    text-align: center !important;
}

.estimate-table th:nth-child(7) {  /* Кнопка удалить */
    width: 40px !important;
    text-align: center !important;
}

/* ========== МОБИЛЬНАЯ ВЕРСИЯ ========== */
@media (max-width: 767px) {
    .estimate-table thead tr {
        height: 32px !important;  /* Чуть ниже на мобильных */
    }
    
    .estimate-table th {
        font-size: 9px !important;
        padding: 0 3px !important;
    }
}

/* Исправление ширины наименования */
.estimate-table th:nth-child(2),
.estimate-table td:nth-child(2) {
    min-width: 620px !important;
}
.estimate-table td:nth-child(2) input {
    min-width: 580px !important;
}

/* ========== СТИЛИ ДЛЯ СКРЫТИЯ ПАНЕЛИ ========== */
.global-modifiers-panel.hidden {
    display: none !important;
}

/* Когда панель скрыта, следующий за ней контейнер сметы занимает больше места */
.global-modifiers-panel.hidden + .estimate-scale-container {
    max-height: calc(100vh - 250px) !important;
}

/* Анимация */
.global-modifiers-panel {
    transition: all 0.3s ease;
    margin-bottom: 15px; /* Добавляем отступ снизу */
}

/* На мобильных устройствах */
@media (max-width: 767px) {
    .global-modifiers-panel.hidden + .estimate-scale-container {
        max-height: calc(100vh - 220px) !important;
    }
    
    /* Убедимся, что панель всегда сверху */
    .global-modifiers-panel {
        order: 1;
    }
    
    .estimate-scale-container {
        order: 2;
    }
    
    .estimate-totals {
        order: 3;
    }
}
/* ========== ФИНАЛЬНЫЕ ИСПРАВЛЕНИЯ ДЛЯ МОБИЛЬНЫХ ========== */
@media (max-width: 767px) {
    /* Исправляем позиционирование */
    body {
        overflow-x: hidden;
        position: relative;
    }
    
    .container {
        padding: 2px;
        overflow-x: hidden;
        max-width: 100%;
    }
    
    #estimate-tab {
        padding: 0;
        margin: 0;
        overflow: visible;
    }
    
    .global-modifiers-panel {
        margin: 5px !important;
        width: auto !important;
    }
    
    /* Гарантируем, что контейнер для скролла занимает всю ширину */
    .estimate-scale-container {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        left: 0 !important;
        right: 0 !important;
    }
    
    /* Убираем transform-баги на мобильных */
    .estimate-scalable {
        transform: scale(var(--scale-factor, 1)) !important;
        transform-origin: 0 0 !important;
        will-change: transform; /* Оптимизация производительности */
    }
	.estimate-table th:nth-child(2),
	.estimate-table td:nth-child(2) {
    min-width: 360px !important;  /* Было 250px */
    max-width: 420px !important;
    white-space: normal !important;
    word-break: break-word !important;
}

.estimate-table td:nth-child(2) input {
    min-width: 360px !important;  /* Было 250px */
    max-width: 420px !important;
    font-size: 9px !important;   /* Уменьшаем шрифт */
}
}
/* ========== СТИЛИ ДЛЯ КНОПКИ ВХОДА ========== */
#googleLoginBtn {
    display: flex; /* Кнопка видна по умолчанию */
}

/* Классы для скрытия */
#googleLoginBtn.forced-hidden,
#googleLoginBtn.google-login-hidden {
    display: none !important;
}

		/* ========== СТИЛИ ДЛЯ СПИСКА СМЕТ ========== */
.estimate-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
    cursor: pointer;
}

.estimate-item:hover {
    background: #f0f7ff;
}

.estimate-item.selected {
    background: #e3f2fd;
    border-left: 4px solid #3498db;
}

.estimate-item-info {
    flex: 1;
}

.estimate-item-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.estimate-item-meta {
    font-size: 0.8rem;
    color: #666;
    display: flex;
    gap: 15px;
}

.estimate-item-actions {
    display: flex;
    gap: 8px;
}

.estimate-item-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s;
}

.estimate-edit-btn {
    color: #3498db;
}

.estimate-edit-btn:hover {
    background: #e3f2fd;
    transform: scale(1.1);
}

.estimate-delete-btn {
    color: #e74c3c;
}

.estimate-delete-btn:hover {
    background: #ffebee;
    transform: scale(1.1);
}

.empty-estimates {
    text-align: center;
    color: #666;
    padding: 30px;
    font-style: italic;
}

		/* ========== СТИЛИ ДЛЯ GOOGLE DRIVE ФАЙЛОВ ========== */
.google-drive-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
    cursor: pointer;
}

.google-drive-item:hover {
    background: #f0f7ff;
}

.google-drive-item.selected {
    background: #e3f2fd;
    border-left: 4px solid #3498db;
}

.google-drive-item-info {
    flex: 1;
}

.google-drive-item-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.google-drive-item-name i {
    color: #3498db;
}

.google-drive-item-meta {
    font-size: 0.8rem;
    color: #666;
    display: flex;
    gap: 15px;
}

.google-drive-item-actions {
    display: flex;
    gap: 8px;
}

.google-drive-item-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s;
}

.google-drive-edit-btn {
    color: #3498db;
}

.google-drive-edit-btn:hover {
    background: #e3f2fd;
    transform: scale(1.1);
}

.google-drive-delete-btn {
    color: #e74c3c;
}

.google-drive-delete-btn:hover {
    background: #ffebee;
    transform: scale(1.1);
}

.empty-drive-files {
    text-align: center;
    color: #666;
    padding: 30px;
    font-style: italic;
}
		.google-drive-item-meta {
    display: flex;
    gap: 15px;
    font-size: 0.8rem;
    color: #666;
    flex-wrap: wrap;
}

.google-drive-item-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.google-drive-item-meta i {
    font-size: 0.75rem;
    color: #3498db;
}
		.btn-sm {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-sm:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-info {
    background: #00acc1;
    color: white;
}
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <div class="container">
<!-- Шапка -->
<div class="header">
    <div class="logo">
        <!-- Ваша иконка с GitHub -->
        <img src="https://raw.githubusercontent.com/Alivu/electro-smeta/main/Icon/icon-48x48.png" 
             alt="ЭлектроСмета" 
             class="app-icon"
             id="appLogoIcon">
        <i class="fas fa-bolt logo-icon" id="fallbackIcon" style="display: none;"></i>
        <span class="logo-text">𝔼𝕝𝕖𝕜𝕥𝕣𝕠𝕊𝕞𝕖𝕥𝕒 @𝔼𝕝𝕖𝕔𝕥𝕣𝕚𝕔_𝔾𝕣𝕠𝕦𝕡 +𝟟𝟫𝟞𝟛𝟝𝟡𝟠𝟜𝟠𝟜𝟞</span>
    </div>
</div>
        
<!-- Панель навигации -->
<div class="nav-panel">
    <!-- Вкладки -->
    <div class="tabs">
        <button class="tab active" id="priceTabBtn">
            <i class="fas fa-file-invoice-dollar"></i> Прайс-лист
        </button>
        <button class="tab" id="estimateTabBtn">
            <i class="fas fa-calculator"></i> Смета
            <span id="estimateCounter" style="
                background: #6c757d; 
                color: white; 
                padding: 2px 6px; 
                border-radius: 10px; 
                font-size: 0.75rem; 
                margin-left: 5px;
            ">0</span>
        </button>
    </div>
    
<!-- Управление -->
<div class="estimate-controls">
    <!-- Кнопка скрытия панели -->
    <button class="btn btn-info" id="toggleGlobalPanel" style="margin-right: 5px;">
        <i class="fas fa-eye-slash"></i> <span id="togglePanelText">Скрыть панель</span>
    </button>
    
    <!-- Меню управления сметой -->
    <div class="dropdown-controls">
        <button class="btn btn-success dropdown-toggle" id="controlsDropdown">
            <i class="fas fa-bars"></i> Управление
            <i class="fas fa-chevron-down" style="margin-left: 8px;"></i>
        </button>
        <div class="dropdown-menu" id="controlsMenu">
<!-- БЛОК ПОЛЬЗОВАТЕЛЯ (экстремально компактный) -->
<div id="googleUserBlock" style="display: none; padding: 2px 6px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; margin-bottom: 2px; border-radius: 2px;">
    <div style="display: flex; align-items: center; gap: 3px;">
        <i class="fas fa-user-circle" style="font-size: 13px;"></i>
        <span id="googleUserEmail" style="font-weight: 500; font-size: 11px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
        <button id="googleLogoutBtn" style="background: none; border: none; color: white; cursor: pointer; font-size: 11px; padding: 1px; display: flex; align-items: center;" title="Выйти">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</div>
<button class="dropdown-item" id="editorBtn">
    <i class="fas fa-edit"></i> Редактор прайс-листа
</button>
            
            <!-- Кнопка входа Google (видна когда не вошел) -->
            <button class="dropdown-item" id="googleLoginBtn" style="display: flex;">
                <i class="fab fa-google"></i> Войти через Google
            </button>
            <div class="dropdown-divider" id="googleLoginDivider"></div>
            
            <button class="dropdown-item" id="refreshEstimateBtn">
                <i class="fas fa-sync-alt"></i> Обновить смету
            </button>
            
            <button class="dropdown-item" id="addRowBtn">
                <i class="fas fa-plus"></i> Добавить строку
            </button>
            <button class="dropdown-item" id="addMaterialBtn">
                <i class="fas fa-box"></i> Добавить материал
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="saveEstimateBtn">
                <i class="fas fa-save"></i> Сохранить смету
            </button>
            <button class="dropdown-item" id="loadEstimateBtn">
                <i class="fas fa-folder-open"></i> Загрузить смету
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="saveAsPdfBtn">
                <i class="fas fa-file-pdf"></i> Сохранить в PDF
            </button>
            <button class="dropdown-item" id="printEstimateBtn">
                <i class="fas fa-print"></i> Печать сметы
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" onclick="window.open('https://github.com/Alivu/electro-smeta/raw/main/Price_Electric_GrouP.pdf', '_blank')">
                <i class="fas fa-download"></i> Прайс-лист
            </button>
            
            <!-- Кнопка возврата -->
            <button class="dropdown-item" onclick="window.open('https://alivu.github.io/', '_blank')">
                <i class="fas fa-home"></i> Домой
            </button>
        </div>
    </div>
</div>	
	</div>
        <!-- Вкладка 1: Прайс-лист -->
        <div class="tab-content active" id="price-tab">
            <div class="price-header">
                <h2><i class="fas fa-list"></i> Прайс-лист электромонтажных работ ЧР</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="priceSearch" placeholder="Поиск по прайс-листу..." autocomplete="off">
                </div>
            </div>
            
            <div class="price-list-container" id="priceList">
                <!-- Прайс-лист будет загружен здесь -->
            </div>
        </div>
        
        <!-- Вкладка 2: Смета -->
        <div class="tab-content" id="estimate-tab">
            <!-- Панель глобальных настроек -->
            <div class="global-modifiers-panel">
                <div class="global-modifier-item">
                    <label><i class="fas fa-percentage"></i> Скидка %:</label>
                    <input type="number" id="globalDiscount" min="0" max="100" step="0.1" value="0" placeholder="0%">
                </div>
                <div class="global-modifier-item">
                    <label><i class="fas fa-calculator"></i> Коэф.:</label>
                    <input type="number" id="globalCoefficient" min="0.1" step="0.1" value="1" placeholder="1.0">
                </div>
                <div class="global-modifier-item">
                    <label><i class="fas fa-comment"></i> Коммент.:</label>
                    <input type="text" id="globalComment" placeholder="Общий комментарий...">
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut" title="Уменьшить"><i class="fas fa-search-minus"></i></button>
                    <span id="zoomPercent" style="color: white; font-size: 13px; padding: 0 5px;">100%</span>
                    <button class="zoom-btn" id="zoomIn" title="Увеличить"><i class="fas fa-search-plus"></i></button>
                    <button class="zoom-reset" id="zoomReset" title="Сбросить масштаб"><i class="fas fa-undo-alt"></i> 100%</button>
                </div>
            </div>
            
            <div class="estimate-scale-container" id="estimateScaleContainer">
                <div class="estimate-scalable" id="estimateScalable" style="transform: scale(1);">
                    <div class="estimate-table-container" style="max-height: none; height: auto; padding: 0;">
                        <table class="estimate-table">
                            <thead>
                                <tr>
                                    <th width="30">Код</th>
                                    <th>Наименование</th>
                                    <th width="50">Ед. изм.</th>
                                    <th width="60">Цена, руб.</th>
                                    <th width="50">Кол-во</th>
                                    <th width="90">Сумма, руб.</th>
                                    <th width="30"></th>
                                </tr>
                            </thead>
                            <tbody id="estimateTable">
                                <!-- Строки сметы будут загружены здесь -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="estimate-totals">
                <div class="total-row" id="baseTotalRow" style="font-size: 0.9rem; color: #666;">
                    <span>Базовая сумма:</span>
                    <span class="total-value" id="baseTotalAmount">0</span>
                </div>
                <div class="total-row" id="discountRow" style="font-size: 0.9rem; color: #e74c3c; display: none;">
                    <span>Скидка <span id="discountPercent">0</span>%:</span>
                    <span class="total-value" id="discountAmount">-0</span>
                </div>
                <div class="total-row" id="coefficientRow" style="font-size: 0.9rem; color: #3498db; display: none;">
                    <span>Коэффициент <span id="coefficientValue">1</span>:</span>
                    <span class="total-value" id="coefficientAdjustment">0</span>
                </div>
                <div class="total-row" id="globalCommentRow" style="font-size: 0.9rem; color: #f39c12; font-style: italic; display: none;">
                    <span colspan="2" id="globalCommentText"></span>
                </div>
                <div class="total-row" style="font-size: 1.2rem; font-weight: 700; color: var(--primary); padding-top: 10px; border-top: 2px solid #ddd; margin-top: 5px;">
                    <span>ИТОГО:</span>
                    <span class="total-value" id="totalAmount">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для материалов -->
    <div class="modal" id="materialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> Добавление материала</h3>
                <button class="close-modal" id="closeMaterialModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="materialName">Наименование материала:</label>
                    <input type="text" id="materialName" class="form-control" placeholder="Например: Кабель ВВГнг 3х1,5" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialUnit">Единица измерения:</label>
                    <select id="materialUnit" class="form-control">
                        <option value="шт.">шт.</option>
                        <option value="м/п">м/п</option>
                        <option value="м">м</option>
                        <option value="комплект">комплект</option>
                        <option value="упаковка">упаковка</option>
                        <option value="рулон">рулон</option>
                        <option value="кг">кг</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена за единицу, руб.:</label>
                    <input type="number" id="materialPrice" class="form-control" placeholder="0" min="0" step="0.01" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialQuantity">Количество:</label>
                    <input type="number" id="materialQuantity" class="form-control" placeholder="1" min="1" step="1" value="1" autocomplete="off">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="addMaterialToEstimate" style="width: 100%;">
                        <i class="fas fa-plus-circle"></i> Добавить в смету
                    </button>
                </div>
            </div>
        </div>
    </div>
    
<!-- Модальное окно для печати -->
<div class="modal" id="printModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="padding: 10px 15px;">
            <h3 style="font-size: 1.1rem; margin: 0;"><i class="fas fa-print"></i> Печать сметы</h3>
            <button class="close-modal" id="closePrintModal" style="font-size: 1.3rem;">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 15px;">
            <!-- ИСПОЛНИТЕЛЬ - компактно -->
            <div style="background: #f0f8ff; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #3498db;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-building" style="font-size: 0.9rem;"></i> Исполнитель
                </h4>
                <div style="display: grid; gap: 8px;">
                    <input type="text" id="executorName" class="form-control" placeholder="Организация / ИП" style="font-size: 0.85rem; padding: 6px 8px;">
                    <input type="text" id="executorInn" class="form-control" placeholder="ИНН" style="font-size: 0.85rem; padding: 6px 8px;">
                    <input type="text" id="executorPhone" class="form-control" placeholder="Телефон" style="font-size: 0.85rem; padding: 6px 8px;">
                </div>
            </div>
            
<!-- ЛОГОТИП - компактно с фиксированной высотой -->
<div style="background: #FFFFFF; border-radius: 6px; margin-bottom: 0; border-left: 3px solid #f39c12; padding: 0; overflow: hidden;">
    <h4 style="margin: 8px 0 4px 8px; font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
        <i class="fas fa-image" style="font-size: 0.9rem;"></i> Логотип
    </h4>
    
    <div style="padding: 0 8px 8px 8px;">
        <input type="file" id="logoUpload" accept="image/*" style="font-size: 0.8rem; padding: 3px; width: 100%; margin-bottom: 5px;">
        
        <!-- Контейнер для предпросмотра с фиксированной высотой 100px -->
        <div id="logoPreview" style="display: none; height: 100px; overflow: hidden; text-align: center; margin: 5px 0; background: #f9f9f9; border-radius: 4px;">
            <img id="logoImage" style="max-height: 100px; max-width: 100px; object-fit: contain;">
        </div>
        
        <div style="display: flex; gap: 8px; min-height: 32px;">
            <button class="btn btn-sm btn-info" id="clearLogoBtn" style="display: none; font-size: 0.8rem; padding: 4px 10px;">
                <i class="fas fa-times"></i> Удалить
            </button>
            <button class="btn btn-sm btn-primary" id="saveLogoToDriveBtn" style="display: none; font-size: 0.8rem; padding: 4px 10px;">
                <i class="fab fa-google-drive"></i> Сохранить
            </button>
            <button class="btn btn-sm btn-success" id="loadLogoFromDriveBtn" style="display: none; font-size: 0.8rem; padding: 4px 10px;">
                <i class="fas fa-download"></i> Загрузить
            </button>
        </div>
    </div>
</div>
            
            <!-- ЗАКАЗЧИК - компактно -->
            <div style="background: #f9f9f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #27ae60;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-user" style="font-size: 0.9rem;"></i> Заказчик
                </h4>
                <div style="display: grid; gap: 8px;">
                    <input type="text" id="clientName" class="form-control" placeholder="Клиент (ФИО или организация)" style="font-size: 0.85rem; padding: 6px 8px;">
                    <input type="text" id="clientContacts" class="form-control" placeholder="Контакты клиента" style="font-size: 0.85rem; padding: 6px 8px;">
                </div>
            </div>
            
            <!-- ПРОЕКТ - компактно -->
            <div style="background: #f0f0f0; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #f39c12;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-project-diagram" style="font-size: 0.9rem;"></i> Проект
                </h4>
                <div style="display: grid; gap: 8px;">
                    <input type="text" id="projectName" class="form-control" placeholder="Название объекта" style="font-size: 0.85rem; padding: 6px 8px;">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="estimateNumber" class="form-control" placeholder="№ сметы" value="СМ-001" style="font-size: 0.85rem; padding: 6px 8px; flex: 1;">
                        <input type="date" id="estimateDate" class="form-control" style="font-size: 0.85rem; padding: 6px 8px; width: 130px;">
                    </div>
                </div>
            </div>
            
            <!-- ПРИМЕЧАНИЯ - компактно -->
            <div style="background: #f9f9f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-sticky-note" style="font-size: 0.9rem;"></i> Примечания
                </h4>
                <textarea id="notes" class="form-control" rows="2" placeholder="Условия оплаты, гарантии..." style="font-size: 0.85rem; padding: 6px 8px;"></textarea>
            </div>
            
            <!-- КНОПКИ -->
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <button class="btn btn-success" id="saveExecutorData" style="flex: 1; font-size: 0.9rem; padding: 8px;">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button class="btn btn-info" id="generatePrint" style="flex: 1; font-size: 0.9rem; padding: 8px;">
                    <i class="fas fa-file-pdf"></i> Сформировать
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно для загрузки смет -->
<div class="modal" id="loadModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-folder-open"></i> Загрузить смету</h3>
            <button class="close-modal" id="closeLoadModal">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Список сохраненных смет -->
            <div id="savedEstimatesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Сметы будут загружены сюда -->
            </div>
            
            <!-- Кнопки действий -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #ddd; padding-top: 15px;">
                <button class="btn btn-success" id="loadSelectedEstimateBtn" style="display: none;">
                    <i class="fas fa-download"></i> Загрузить выбранное
                </button>
                <button class="btn btn-secondary" id="cancelLoadModalBtn" style="background: #6c757d;">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>
</div>
    
    <!-- НОВОЕ: Модальное окно для настройки строки (коэффициент/скидка/комментарий) -->
    <div class="modal" id="rowSettingsModal">
        <div class="modal-content row-settings-modal">
            <div class="modal-header">
                <h3><i class="fas fa-sliders-h"></i> Настройки позиции</h3>
                <button class="close-modal" id="closeRowSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="coefficient">Коэффициент</button>
                    <button class="settings-tab" data-tab="discount">Скидка</button>
                    <button class="settings-tab" data-tab="comment">Комментарий</button>
                </div>
                
                <div class="settings-content active" id="coefficientTab">
                    <div class="settings-field">
                        <label>Коэффициент:</label>
                        <input type="number" id="rowCoefficient" min="0.1" step="0.1" value="1.0">
                        <small>Умножает цену на указанное значение (например, 1.5 = +50%)</small>
                    </div>
                    <div class="settings-field">
                        <label>Комментарий к коэффициенту:</label>
                        <input type="text" id="rowCoeffComment" placeholder="Например: Демонтаж">
                    </div>
                </div>
                
                <div class="settings-content" id="discountTab">
                    <div class="settings-field">
                        <label>Скидка %:</label>
                        <input type="number" id="rowDiscount" min="0" max="100" step="0.1" value="0">
                        <small>Процент скидки на эту позицию</small>
                    </div>
                    <div class="settings-field">
                        <label>Комментарий к скидке:</label>
                        <input type="text" id="rowDiscountComment" placeholder="Например: Акция">
                    </div>
                </div>
                
                <div class="settings-content" id="commentTab">
                    <div class="settings-field">
                        <label>Комментарий к позиции:</label>
                        <input type="text" id="rowComment" placeholder="Любой текст...">
                        <small>Будет добавлен к наименованию</small>
                    </div>
                </div>
                
                <div class="row-total-preview" id="rowTotalPreview">
                    Итоговая сумма: 0 руб.
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="applyRowSettings" style="flex: 1;">Применить</button>
                    <button class="btn btn-danger" id="clearRowSettings" style="flex: 1;">Очистить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ========== ВЕСЬ ВАШ СУЩЕСТВУЮЩИЙ JAVASCRIPT КОД ПОЛНОСТЬЮ СОХРАНЁН ==========

// ========== ЗАГРУЗКА ВЕРСИИ ИЗ SW.js ==========
let APP_VERSION = '1.0.0'; // значение по умолчанию

// Функция загрузки версии из Service Worker
async function loadVersionFromSW() {
  try {
    console.log('🔍 Загружаю версию из Service Worker...');
    const response = await fetch('sw.js?t=' + Date.now());
    const swCode = await response.text();
    const versionMatch = swCode.match(/const APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
    
    if (versionMatch && versionMatch[1]) {
      APP_VERSION = versionMatch[1];
      console.log(`✅ Версия загружена: ${APP_VERSION}`);
    }
  } catch (error) {
    console.error('❌ Ошибка загрузки версии:', error);
    // Если нет интернета - оставляем версию из localStorage
    const savedVersion = localStorage.getItem('app_version');
    if (savedVersion) {
      APP_VERSION = savedVersion;
      console.log(`📴 Офлайн режим: использую сохраненную версию ${APP_VERSION}`);
    }
  }
  return APP_VERSION;
}

// Функция для получения сообщения из Service Worker - С ОТЛАДКОЙ
async function getVersionMessageFromSW() {
  try {
    const response = await fetch('sw.js?t=' + Date.now());
    const swCode = await response.text();
    
    console.log('🔍 Первые 500 символов sw.js:', swCode.substring(0, 500));
    
    // Пробуем разные варианты поиска
    const patterns = [
      /message:\s*['"]([^'"]+)['"]/,
      /message:\s*['"](.+?)['"]/,
      /VERSION_NOTIFICATION.*?message:\s*['"]([^'"]+)['"]/s
    ];
    
    for (let i = 0; i < patterns.length; i++) {
      const match = swCode.match(patterns[i]);
      if (match && match[1]) {
        console.log(`✅ Паттерн ${i+1} сработал:`, match[1]);
        return match[1];
      }
    }
    
    console.log('❌ Сообщение в SW не найдено');
    return null;
  } catch (error) {
    console.error('❌ Ошибка загрузки сообщения из SW:', error);
    return null;
  }
}

// ========== УВЕДОМЛЕНИЕ В ЦЕНТРЕ СО ЗВУКОМ ==========
function showCenterNotification(message) {
    const isMobile = window.innerWidth <= 767;
    
    // 1. ВИБРАЦИЯ (только на мобильных)
    if (isMobile && 'vibrate' in navigator) {
        // Короткая вибрация: 100ms вибрация, 50ms пауза, 100ms вибрация
        navigator.vibrate([100, 50, 100]);
    }
    
    // 2. ЗВУКОВОЕ УВЕДОМЛЕНИЕ
    playNotificationSound();
    
    // 3. СОЗДАЕМ УВЕДОМЛЕНИЕ (стиль как был)
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: ${isMobile ? '20px' : '25px 30px'};
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 9999;
        max-width: ${isMobile ? '90vw' : '500px'};
        width: ${isMobile ? '85%' : '80%'};
        text-align: center;
        animation: centerNotifyIn 0.4s ease-out;
        border: 2px solid rgba(255,255,255,0.1);
        font-size: ${isMobile ? '16px' : '18px'};
        font-weight: 500;
        line-height: 1.4;
        white-space: pre-line;
    `;
    
// Добавляем бренд Electric Group сверху
if (isMobile) {
    // Для мобильных - компактно
    notification.innerHTML = `
        <div style="
            font-size: 18px;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        ">
            <i class="fas fa-bolt" style="vertical-align: middle;"></i>
            <span style="vertical-align: middle;">Electric Group</span>
            <i class="fas fa-bolt" style="vertical-align: middle;"></i>
        </div>
        
        <div style="
            height: 1px;
            background: linear-gradient(90deg, transparent, #f1c40f, transparent);
            margin: 0px 0 2px;
        "></div>
        
<div style="display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px; margin-top: 2px;">
    <span>${message}</span>
</div>
    `;
} else {
    // Для десктопа - стандартно
    notification.innerHTML = `
        <div style="
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        ">
            <i class="fas fa-bolt" style="vertical-align: middle;"></i>
            <span style="vertical-align: middle;">Electric Group</span>
            <i class="fas fa-bolt" style="vertical-align: middle;"></i>
        </div>
        
        <div style="
            height: 1px;
            background: linear-gradient(90deg, transparent, #f1c40f, transparent);
            margin: 0px 0 3px;
        "></div>
        
<div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 3px;">
    <span>${message}</span>
</div>
    `;
}
    document.body.appendChild(notification);
    
    // Анимации
    if (!document.querySelector('#center-notify-style')) {
        const style = document.createElement('style');
        style.id = 'center-notify-style';
        style.textContent = `
            @keyframes centerNotifyIn {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes centerNotifyOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Автоскрытие через 5 секунд (увеличил для длинных сообщений)
    setTimeout(() => {
        notification.style.animation = 'centerNotifyOut 0.4s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 400);
    }, 3000);
    
    // Закрытие по клику
    notification.addEventListener('click', function() {
        notification.style.animation = 'centerNotifyOut 0.4s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 400);
    });
}

// ========== ФУНКЦИЯ ВОСПРОИЗВЕДЕНИЯ ЗВУКА ==========
function playNotificationSound() {
    try {
        // Создаем AudioContext для современных браузеров
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Настраиваем звук (приятный "динь")
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Частота
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            
            // Настраиваем громкость (fade in/out)
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            // Подключаем
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Воспроизводим
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
            
            // Автоматически закрываем контекст
            setTimeout(() => {
                if (audioContext.state !== 'closed') {
                    audioContext.close();
                }
            }, 1000);
            
        } else {
            // Fallback для старых браузеров - используем HTML5 Audio
            fallbackSound();
        }
    } catch (error) {
        console.log('Не удалось воспроизвести звук:', error);
        fallbackSound();
    }
}

// ========== РЕЗЕРВНЫЙ ЗВУК (HTML5 Audio) ==========
function fallbackSound() {
    try {
        // Создаем короткий бип с помощью Web Audio API или простого beep
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        
    } catch (error) {
        console.log('Звук недоступен');
    }
}

// ========== ОСНОВНАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ВЕРСИИ ==========
async function initializeVersion() {
  // ========== СНАЧАЛА ПРОВЕРЯЕМ ИНТЕРНЕТ ==========
  if (!navigator.onLine) {
    console.log('📴 Офлайн режим обнаружен!');
    
    // Загружаем версию из localStorage
    const savedVersion = localStorage.getItem('app_version');
    if (savedVersion) {
      APP_VERSION = savedVersion;
      console.log(`📴 Использую сохраненную версию: ${APP_VERSION}`);
    }
    
    // Показываем офлайн-уведомление
    setTimeout(() => {
      showCenterNotification('📴 Офлайн-режим');
    }, 1500);
    
    // Показываем версию в интерфейсе
    document.addEventListener('DOMContentLoaded', function() {
      const logo = document.querySelector('.logo-text');
      if (logo) {
        logo.innerHTML = `𝔼𝕝𝕖𝕜𝕥𝕣𝕠𝕊𝕞𝕖𝕥𝕒 
          <span style="color:#3498db; font-weight:bold">v${APP_VERSION}</span> 
          @𝔼𝕝𝕖𝕔𝕥𝕣𝕚𝕔_𝔾𝕣𝕠𝕦𝕡`;
      }
    });
    
    return; // Выходим из функции, НЕ пытаемся загрузить sw.js
  }
  
  // ========== ЕСЛИ ЕСТЬ ИНТЕРНЕТ - ТОЛЬКО ТОГДА ГРУЗИМ SW ==========
  await loadVersionFromSW();
  const savedVersion = localStorage.getItem('app_version');
  
  if (savedVersion !== APP_VERSION) {
    console.log(`🔄 ОБНОВЛЕНИЕ: ${savedVersion || 'нет'} → ${APP_VERSION}`);
    localStorage.setItem('app_version', APP_VERSION);
    
    // Получаем сообщение из Service Worker
    const swMessage = await getVersionMessageFromSW();
    
    // Формируем текст уведомления
    let notificationText = `🎉 Обновлено до версии ${APP_VERSION}!`;
    
    // Если есть сообщение из SW, добавляем его
    if (swMessage) {
      notificationText = `${notificationText}\n\n📢 ${swMessage}`;
    }
    
    // ========== ПОДСВЕТКА КНОПКИ "ОБНОВИТЬ СМЕТУ" ==========
    const refreshBtn = document.getElementById('refreshEstimateBtn');
    if (refreshBtn) {
        refreshBtn.innerHTML = `
            <i class="fas fa-bolt" style="color: #f39c12;"></i> 
            Новая версия ${APP_VERSION}
            <span style="
                margin-left: 8px; 
                background: #e74c3c; 
                color: white; 
                padding: 2px 6px; 
                border-radius: 10px; 
                font-size: 0.7em;
                font-weight: bold;
            ">
                NEW
            </span>
        `;
        
        refreshBtn.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        refreshBtn.style.color = 'white';
        refreshBtn.style.fontWeight = 'bold';
        refreshBtn.style.border = 'none';
        
        refreshBtn.dataset.oldVersion = savedVersion || 'нет';
        refreshBtn.dataset.newVersion = APP_VERSION;
    }
    
    // Показываем уведомление через 1 секунду
    setTimeout(() => {
        showCenterNotification(notificationText);
    }, 1000);
  }
  
  // Показываем версию в интерфейсе
  document.addEventListener('DOMContentLoaded', function() {
    const logo = document.querySelector('.logo-text');
    if (logo) {
      logo.innerHTML = `𝔼𝕝𝕖𝕜𝕥𝕣𝕠𝕊𝕞𝕖𝕥𝕒 
        <span style="color:#3498db; font-weight:bold">v${APP_VERSION}</span> 
        @𝔼𝕝𝕖𝕔𝕥𝕣𝕚𝕔_𝔾𝕣𝕠𝕦𝕡`;
    }
  });
}

// Запускаем
initializeVersion();
// ========== КОНЕЦ БЛОКА ВЕРСИОНИРОВАНИЯ ==========
        // Проверяем iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        // Обработчик для кнопки "Скачать PDF" в окне печати
// Обработчик для кнопки "Скачать PDF" в окне печати
window.addEventListener('message', function(event) {
    if (event.data.action === 'savePDFFromPrint') {
        // Заполняем поля исполнителя
        if (document.getElementById('executorName')) {
            document.getElementById('executorName').value = event.data.data.executorName || 'ЭлектроСмета';
        }
        if (document.getElementById('executorInn')) {
            document.getElementById('executorInn').value = event.data.data.executorInn || '';
        }
        if (document.getElementById('executorPhone')) {
            document.getElementById('executorPhone').value = event.data.data.executorPhone || '+7 (963) 598-48-46';
        }
        
        // Заполняем поля клиента
        if (document.getElementById('clientName')) {
            document.getElementById('clientName').value = event.data.data.clientName || '';
        }
        if (document.getElementById('clientContacts')) {
            document.getElementById('clientContacts').value = event.data.data.clientContacts || '';
        }
        if (document.getElementById('projectName')) {
            document.getElementById('projectName').value = event.data.data.projectName || '';
        }
        
        // Заполняем поля документа
        if (document.getElementById('estimateNumber')) {
            document.getElementById('estimateNumber').value = event.data.data.estimateNumber || 'СМ-001';
        }
        if (document.getElementById('estimateDate')) {
            document.getElementById('estimateDate').value = event.data.data.estimateDate || new Date().toISOString().split('T')[0];
        }
        if (document.getElementById('notes')) {
            document.getElementById('notes').value = event.data.data.notes || '';
        }
        
        // Сохраняем логотип, если он передан
        if (event.data.data.logoDataUrl) {
            localStorage.setItem('companyLogo', event.data.data.logoDataUrl);
            logoDataUrl = event.data.data.logoDataUrl;
            
            // Обновляем предпросмотр логотипа если он открыт
            const logoImg = document.getElementById('logoImage');
            const logoPreview = document.getElementById('logoPreview');
            if (logoImg) logoImg.src = event.data.data.logoDataUrl;
            if (logoPreview) logoPreview.style.display = 'block';
        }
        
        // Закрываем окно печати
        if (event.source) event.source.close();
        
        // Открываем PDF модальное окно
        setTimeout(() => {
            saveAsPDF();
        }, 300);
    }
    // ДОБАВЬТЕ ЭТОТ БЛОК для прайс-листа:
    if (event.data.action === 'savePriceAsPDF') {
        // Закрываем окно печати
        if (event.source) event.source.close();
        
        // Запускаем создание PDF прайс-листа
        setTimeout(() => {
            createPricePDF();
        }, 300);
    }
});
// Новая функция для создания PDF прайс-листа
function createPricePDF() {
    // Проверяем библиотеки
    if (!checkPDFLibraries()) return;
    
    // Показываем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 9999;
        font-size: 16px;
    `;
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание PDF прайс-листа...';
    document.body.appendChild(loadingDiv);
    
    // Получаем дату
    const today = new Date().toLocaleDateString('ru-RU');
    const hijri = getHijriDate();
    
    // Создаем массив страниц
    const sectionsPerPage = 2; // Максимум 2 раздела на страницу
    const pages = [];
    let currentPage = [];
    let currentPageHeight = 0;
    const maxPageHeight = 250; // мм на странице A4
    
    // Разбиваем на страницы
    priceData.forEach((section, index) => {
        // Примерная высота раздела (в мм)
        const sectionHeight = 10 + (section.items.length * 3);
        
        if (currentPageHeight + sectionHeight > maxPageHeight && currentPage.length > 0) {
            pages.push([...currentPage]);
            currentPage = [section];
            currentPageHeight = sectionHeight;
        } else {
            currentPage.push(section);
            currentPageHeight += sectionHeight;
        }
        
        // Если это последний раздел, добавляем оставшуюся страницу
        if (index === priceData.length - 1 && currentPage.length > 0) {
            pages.push([...currentPage]);
        }
    });
    
    console.log(`Создано ${pages.length} страниц PDF`);
    
    // Создаем PDF документ
    const pdf = new jspdf.jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });
    
    // Создаем контейнер для каждой страницы
    let pageIndex = 0;
    
    function renderPage(pageSections, pageNum, totalPages) {
        return new Promise((resolve) => {
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = `
                position: fixed;
                left: -9999px;
                top: -9999px;
                width: 210mm;
                padding: 15mm;
                background: white;
                font-family: Arial, sans-serif;
                font-size: 10px;
            `;
            
            // Генерируем контент для страницы
            let pdfContent = `
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                    <h1 style="margin: 0 0 5px 0; font-size: 20px; color: #2c3e50;">Прайс-лист Электрика 29.12.2026г</h1>
                    <div style="font-size: 11px;">
                        <strong>Дата:</strong> ${today} 
                        <span style="margin-left: 10px; background: #f8f9fa; padding: 2px 6px; border-radius: 2px; font-size: 10px;">
                            <i class="fas fa-mosque"></i> ${hijri.day} ${hijri.month} ${hijri.year} г.х.
                        </span>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 5px;">
                        Страница ${pageNum} из ${totalPages}
                    </div>
                </div>
            `;
            
            // Добавляем разделы для этой страницы
            pageSections.forEach(section => {
                pdfContent += `
                    <div style="margin-bottom: 12px; page-break-inside: avoid;">
                        <h2 style="background: #2c3e50; color: white; padding: 6px 10px; margin: 0 0 6px 0; border-radius: 3px; font-size: 12px;">
                            ${section.section}
                        </h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9px; line-height: 1.2;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 7%; text-align: center; font-weight: bold;">Код</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 60%; font-weight: bold;">Наименование работ</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 8%; text-align: center; font-weight: bold;">Ед.</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 15%; text-align: right; font-weight: bold;">Цена, руб.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${section.items.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: center; font-weight: bold; color: #3498db; font-size: 8.5px;">${item.id}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 4px; font-size: 8.5px; line-height: 1.1;">${item.name}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: center; font-size: 8.5px;">${item.unit}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: right; font-weight: bold; color: #27ae60; font-size: 8.5px;">${formatCurrency(item.price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            // Добавляем футер только на последней странице
            if (pageNum === totalPages) {
                pdfContent += `
                    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 8px; color: #666; text-align: center;">
                        <div style="margin-bottom: 3px;">
                            <strong>Контакты: https://alivu.github.io/
                        </div>
                        <div>
                            Прайс-лист сформирован в приложении "ЭлектроСмета" от Electric_Group для Братьев<br>
                            Дата формирования: ${new Date().toLocaleString('ru-RU')}
                        </div>
                    </div>
                `;
            } else {
                // На промежуточных страницах добавляем "продолжение следует"
                pdfContent += `
                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666; font-style: italic;">
                        продолжение следует...
                    </div>
                `;
            }
            
            tempContainer.innerHTML = pdfContent;
            document.body.appendChild(tempContainer);
            
// Даем время на рендеринг
setTimeout(() => {
    html2canvas(tempContainer, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        windowWidth: tempContainer.scrollWidth,  // Добавить
        windowHeight: tempContainer.scrollHeight  // Добавить
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 0.95); // Увеличил качество
        
        // ПОЛУЧАЕМ РЕАЛЬНЫЕ РАЗМЕРЫ
        const imgWidth = 210; // Вся ширина A4 (210мм)
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Создаем PDF с правильной ориентацией
        const pdf = new jspdf.jsPDF({
            orientation: imgHeight > imgWidth ? 'portrait' : 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        // Добавляем изображение на всю страницу
        pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
        
        // Сохраняем
        pdf.save(`Смета_${estimateNumber}.pdf`);
        
        // Удаляем временный контейнер
        document.body.removeChild(tempContainer);
        loadingDiv.remove();
        
        resolve();
    }).catch(error => {
        console.error('Ошибка при создании PDF:', error);
        document.body.removeChild(tempContainer);
        loadingDiv.remove();
        resolve();
    });
}, 500); // Увеличил время до 500ms
        });
    }
    
    // Рендерим все страницы последовательно
    async function renderAllPages() {
        for (let i = 0; i < pages.length; i++) {
            await renderPage(pages[i], i + 1, pages.length);
            pageIndex++;
        }
        
        // Сохранение
        const todayStr = new Date().toLocaleDateString('ru-RU').replace(/\//g, '-');
        pdf.save(`Прайс-лист_${todayStr}.pdf`);
        
        // Очистка
        document.body.removeChild(loadingDiv);
        
        showNotification(`PDF прайс-листа сохранен! (${pages.length} стр.)`);
    }
    
    // Запускаем рендеринг
    renderAllPages().catch(error => {
        console.error('Ошибка при создании PDF:', error);
        document.body.removeChild(loadingDiv);
        showNotification('Ошибка при создании PDF прайс-листа');
    });
}
        
        // Проверяем загрузку библиотек PDF
function checkPDFLibraries() {
    if (typeof jspdf === 'undefined') {
        console.error('jsPDF не загружен!');
        alert('Библиотека jsPDF не загружена. Пожалуйста, обновите страницу.');
        return false;
    }
    if (typeof html2canvas === 'undefined') {
        console.error('html2canvas не загружен!');
        alert('Библиотека html2canvas не загружена. Пожалуйста, обновите страницу.');
        return false;
    }
    return true;
}
        
        // Функция для iOS - отложенная инициализация
        function initForIOS() {
            console.log('Инициализация для iOS');
            
            // Исправляем скролл
            document.body.style.overflow = 'auto';
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // Исправляем фокус
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Предотвращаем масштабирование при фокусе
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    e.preventDefault();
                }
            }, {passive: false});
        }







		
        // Глобальные переменные
        let estimateData = [];
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        let nextMaterialId = 1000;
        
        // НОВЫЕ ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        let currentRowIndex = -1; // Индекс текущей редактируемой строки
        let zoomFactor = 1.0; // Коэффициент масштабирования
        const MIN_ZOOM = 0.5; // Минимальный масштаб (50%)
        const MAX_ZOOM = 1.5; // Максимальный масштаб (150%)
        
// ========== МУСУЛЬМАНСКИЕ ПРАЗДНИКИ ==========
const islamicHolidays = [
    { month: 1, day: 10, name: 'День Ашура' },
    { month: 3, day: 12, name: 'Мавлид ан-Наби (день рождения Пророка ﷺ)' },
    { month: 7, day: 27, name: 'Ляйлят аль-Мирадж (Ночь Вознесения)' },
    { month: 8, day: 15, name: 'Ляйлят аль-Бараа (Ночь Освобождения)' },
    { month: 9, name: 'Рамадан', isRamadan: true },
    { month: 10, day: 1, name: 'Ид аль-Фитр (Ураза-байрам)' },
    { month: 12, day: 10, name: 'Ид аль-Адха (Курбан-байрам)' },
    { month: 12, days: [8,9,10,11,12,13], name: 'Дни Ташрика' }
];

// ========== ФУНКЦИЯ ПОЛУЧЕНИЯ ДАТЫ ХИДЖРЫ ==========
async function getHijriDate() {
    try {
// Получаем текущую дату
const today = new Date();
const day = today.getDate().toString().padStart(2, '0');
const month = (today.getMonth() + 1).toString().padStart(2, '0');
const year = today.getFullYear();

// Запрашиваем с правильной датой
const response = await fetch(`https://api.aladhan.com/v1/gToH?date=${day}-${month}-${year}&adjustment=0`);
        const data = await response.json();
        
        if (data.code === 200) {
            const hijri = data.data.hijri;
            
            // Функция для очистки арабских диакритических знаков
            function cleanArabicText(text) {
                if (!text) return '';
                
                return text
                    .replace(/[ʿʾʼˈ]/g, "'")
                    .replace(/[ā]/g, 'a')
                    .replace(/[ū]/g, 'u')
                    .replace(/[ī]/g, 'i')
                    .replace(/[ḍ]/g, 'd')
                    .replace(/[ḥ]/g, 'h')
                    .replace(/[Ḥ]/g, 'H')
                    .replace(/[ṣ]/g, 's')
                    .replace(/[Ṣ]/g, 'S')
                    .replace(/[ṭ]/g, 't')
                    .replace(/[Ṭ]/g, 'T')
                    .replace(/[ẓ]/g, 'z')
                    .replace(/[Ẓ]/g, 'Z')
                    .replace(/[ḏ]/g, 'd')
                    .replace(/[Ḏ]/g, 'D')
                    .trim();
            }
            
            const monthRaw = hijri.month.en;
            const monthCleaned = cleanArabicText(monthRaw);
            
            const hijriMonths = {
                "Muharram": "Мухаррам",
                "Safar": "Сафар",
                "Rabi al-Awwal": "Раби аль-авваль",
                "Rabi' al-Awwal": "Раби аль-авваль",
                "Rabi al-Akhir": "Раби ас-сани",
                "Rabi' al-Akhir": "Раби ас-сани",
                "Rabi al-Thani": "Раби ас-сани",
                "Rabi' al-Thani": "Раби ас-сани",
                "Jumada al-Awwal": "Джумада аль-уля",
                "Jumada al-Ula": "Джумада аль-уля",
                "Jumada' al-Awwal": "Джумада аль-уля",
                "Jumada al-Thani": "Джумада ас-сания",
                "Jumada al-Akhira": "Джумада ас-сания",
                "Jumada' al-Thani": "Джумада ас-сания",
                "Rajab": "Раджаб",
                "Sha'ban": "Шаабан",
                "Shaaban": "Шаабан",
                "Ramadan": "Рамадан",
                "Shawwal": "Шавваль",
                "Dhu al-Qi'dah": "Зуль-каада",
                "Dhu'l-Qi'dah": "Зуль-каада",
                "Dhu al-Qadah": "Зуль-каада",
                "Dhu'l-Qadah": "Зуль-каада",
                "Dhul-Qa'dah": "Зуль-каада",
                "Dhul-Qadah": "Зуль-каада",
                "Dhu al-Hijjah": "Зуль-хиджа",
                "Dhu'l-Hijjah": "Зуль-хиджа",
                "Dhul-Hijjah": "Зуль-хиджа"
            };
            
            let monthRu = hijriMonths[monthCleaned] || hijriMonths[monthRaw];
            
            if (!monthRu) {
                const monthLower = monthCleaned.toLowerCase();
                
                if (monthLower.includes("sha") && monthLower.includes("ban")) {
                    monthRu = "Шаабан";
                } else if (monthLower.includes("rabi") && monthLower.includes("awwal")) {
                    monthRu = "Раби аль-авваль";
                } else if (monthLower.includes("rabi") && (monthLower.includes("akhir") || monthLower.includes("thani"))) {
                    monthRu = "Раби ас-сани";
                } else if (monthLower.includes("jumada") && monthLower.includes("awwal")) {
                    monthRu = "Джумада аль-уля";
                } else if (monthLower.includes("jumada") && (monthLower.includes("akhir") || monthLower.includes("thani"))) {
                    monthRu = "Джумада ас-сания";
                } else if (monthLower.includes("dhu") && monthLower.includes("qi'dah")) {
                    monthRu = "Зуль-каада";
                } else if (monthLower.includes("dhu") && monthLower.includes("hijjah")) {
                    monthRu = "Зуль-хиджа";
                }
            }
            
            if (!monthRu) {
                monthRu = monthCleaned;
                console.warn("Не найден перевод для месяца:", monthRaw, "->", monthCleaned);
            }
            
            const result = {
                year: parseInt(hijri.year),
                month: monthRu,
                monthIndex: parseInt(hijri.month.number),
                day: parseInt(hijri.day),
                display: `${hijri.day} ${monthRu} ${hijri.year} г.х.`
            };            
            return result;
        }
    } catch (error) {
        console.error('Ошибка получения даты Хиджры:', error);
    }
    
    return {
        year: 1447,
        month: 'Шаабан',
        monthIndex: 8,
        day: 4,
        display: '4 Шаабан 1447 г.х.'
    };
}

// ========== СИСТЕМА УВЕДОМЛЕНИЙ (ИСПРАВЛЕННАЯ) ==========
const notificationSystem = {
    getTimeGreeting: function() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Доброе утро! Да благословит вас Аллах в этот день! 🌅';
        if (hour >= 12 && hour < 18) return 'Добрый день! Мир вам и милость Аллаха! ☀️';
        if (hour >= 18 && hour < 23) return 'Добрый вечер! Да примет Аллах ваши дела! 🌆';
        return 'Доброй ночи! Да охранит вас Аллах до утра! 🌙';
    },
    
    getFridayReminder: function() {
        const now = new Date();
        const isFriday = now.getDay() === 5;
        const hour = now.getHours();
        
        if (!isFriday) return null;
        
        if (hour >= 12 && hour < 15) {
            return '🕌 Не пропустите Джума-намаз! Время коллективной молитвы.';
        }
        
        if (hour >= 15 && hour < 18) {
            return '🕋 Последний час пятницы - особое время для дуа! Не упустите!';
        }
        
        return 'Пятница - лучший день недели! Совершите больше благих дел! 📿';
    },
    
    getHolidayMessage: async function() {
        try {
            const hijri = await getHijriDate();
            
            for (let holiday of islamicHolidays) {
                if (holiday.month === hijri.monthIndex) {
                    if (holiday.isRamadan && hijri.monthIndex === 9) {
                        return `🌙 Благословенный месяц Рамадан! Да примет Аллах ваш пост и молитвы!`;
                    }
                    
                    if (holiday.day && hijri.day === holiday.day) {
                        return `🎉 ${holiday.name}! С праздником! Да примет Аллах ваше поклонение!`;
                    }
                    
                    if (holiday.days && holiday.days.includes(hijri.day)) {
                        return `📿 ${holiday.name} (${hijri.day} день). Запрещено поститься в эти дни!`;
                    }
                }
            }
        } catch (error) {
            console.error('Ошибка при проверке праздника:', error);
        }
        
        return null;
    },
    
    getPromoMessage: function() {
        const promos = [
            '📱 Подпишитесь на @Electric_Group в Telegram!',
            '⭐ Оставьте отзыв о приложении ЭлектроСмета!',
            '☎️ Сохраните мой +79635984846 для консультаций',
            '💡 Новые функции в разработке! Следите за обновлениями!',
            '🤝 Рекомендуйте нас коллегам-электрикам!'
        ];
        return promos[Math.floor(Math.random() * promos.length)];
    },
    
    getNextNotification: async function() {
        const fridayMsg = this.getFridayReminder();
        if (fridayMsg) return fridayMsg;
        
        const holidayMsg = await this.getHolidayMessage();
        if (holidayMsg) return holidayMsg;
        
        const timeMsg = this.getTimeGreeting();
        
        const shouldShowPromo = Math.random() < 0.3;
        if (shouldShowPromo) {
            return `${timeMsg}\n\n${this.getPromoMessage()}`;
        }
        
        return timeMsg;
    }
};

// ========== ФУНКЦИИ ДЛЯ ОТОБРАЖЕНИЯ ХИДЖРЫ ==========
async function displayHijriDate() {
    const hijri = await getHijriDate();
    const hijriElement = document.createElement('div');
    hijriElement.id = 'hijri-date';
    hijriElement.style.cssText = `
        text-align: center;
        margin: 5px 0;
        font-size: 0.9rem;
        color: #2c3e50;
        font-weight: 500;
        padding: 5px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 5px;
        border: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 28px;
        line-height: 1;
        box-sizing: border-box;
    `;
    
    const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    const today = new Date();
    const dayOfWeek = daysOfWeek[today.getDay()];

    hijriElement.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap; line-height: 1;">
            <div style="display: flex; align-items: center; white-space: nowrap;">
                <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 6px; font-size: 0.95em;"></i>
                <span>${dayOfWeek} ${today.toLocaleDateString('ru-RU')}</span>
            </div>
            <span style="color: #ddd; margin: 0 5px;">|</span>
            <div style="display: flex; align-items: center; white-space: nowrap;">
                <i class="fas fa-mosque" style="color: #27ae60; margin-right: 6px; font-size: 0.95em;"></i>
                <span>${hijri.display}</span>
            </div>
        </div>
    `;
    
    const header = document.querySelector('.header');
    if (header && header.parentNode) {
        header.parentNode.insertBefore(hijriElement, header.nextSibling);
    }
    
    await adaptHijriDateForMobile();
}

async function adaptHijriDateForMobile() {
    const hijriElement = document.getElementById('hijri-date');
    if (!hijriElement) return;
    
    const hijri = await getHijriDate();
    const today = new Date();
    const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    
    if (window.innerWidth <= 767) {
        hijriElement.style.fontSize = '0.75rem';
        hijriElement.style.padding = '4px';
        hijriElement.style.minHeight = '24px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 4px; font-size: 0.85em;"></i>
                    <span style="font-size: 0.95em;">${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 3px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 4px; font-size: 0.85em;"></i>
                    <span style="font-size: 0.95em;">${hijri.display}</span>
                </div>
            </div>
        `;
    } else if (window.innerWidth <= 992) {
        hijriElement.style.fontSize = '0.85rem';
        hijriElement.style.padding = '5px';
        hijriElement.style.minHeight = '26px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 5px; font-size: 0.9em;"></i>
                    <span>${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 4px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 5px; font-size: 0.9em;"></i>
                    <span>${hijri.display}</span>
                </div>
            </div>
        `;
    } else {
        hijriElement.style.fontSize = '0.9rem';
        hijriElement.style.padding = '5px';
        hijriElement.style.minHeight = '28px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 6px; font-size: 0.95em;"></i>
                    <span>${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 5px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 6px; font-size: 0.95em;"></i>
                    <span>${hijri.display}</span>
                </div>
            </div>
        `;
    }
}

// ========== ИНИЦИАЛИЗАЦИЯ ИСЛАМСКИХ ФУНКЦИЙ ==========
async function initializeIslamicFeatures() {
    await displayHijriDate();
    window.addEventListener('resize', () => adaptHijriDateForMobile());
    
    setTimeout(async () => {
        const message = await notificationSystem.getNextNotification();
        if (message) showNotification(message);
    }, 1000);
    
    setInterval(async () => {
        const message = await notificationSystem.getNextNotification();
        if (message) showNotification(message);
    }, 2 * 60 * 60 * 1000);
    
    setInterval(() => {
        const now = new Date();
        if (now.getDay() === 5 && now.getHours() === 11) {
            showNotification('🕌 Напоминание: Джума-намаз скоро! Приготовьтесь к коллективной молитве.');
        }
        if (now.getDay() === 5 && now.getHours() === 15) {
            showNotification('🕋 Сейчас последний час пятницы! Особое время для принятия дуа!');
        }
    }, 60 * 1000);
}
// ========== КОНЕЦ ИНИЦИАЛИЗАЦИИ ==========
        // Функция форматирования валюты
function formatCurrency(amount) {
    if (isNaN(amount)) return '0';
    // Убираем parseFloat и toFixed, используем настройки для отображения копеек
    return new Intl.NumberFormat('ru-RU', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

function showNotification(message) {
    // Определяем мобильное устройство
    const isMobile = window.innerWidth <= 767;
    
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        ${isMobile ? 
            'bottom: 20px; left: 15px; right: 15px;' :  // НА МОБИЛЬНЫХ: внизу, на всю ширину
            'top: 10px; right: 10px;'                    // НА ДЕСКТОПЕ: вверху справа
        }
        background: #27ae60;
        color: white;
        padding: ${isMobile ? '12px 15px' : '10px 15px'};
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: 500;
        ${isMobile ? 
            'max-width: calc(100vw - 30px); width: auto;' :  // НА МОБИЛЬНЫХ: адаптивная ширина
            'max-width: 370px;'                              // НА ДЕСКТОПЕ: фиксированная ширина
        }
        animation: ${isMobile ? 'slideInUp 0.3s ease-out' : 'slideIn 0.3s ease-out'};
        word-wrap: break-word;
        word-break: break-word;  /* ВАЖНО для мобильных */
        line-height: 1.4;
        text-align: ${isMobile ? 'center' : 'left'};
        font-size: ${isMobile ? '14px' : '13px'};
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; ${isMobile ? 'justify-content: center;' : ''} gap: 8px;">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
// Автоматическое скрытие через 5 секунд
setTimeout(() => {
    notification.style.animation = isMobile ? 'slideOutDown 0.3s ease-out' : 'slideOut 0.3s ease-out';
    setTimeout(() => {
        if (notification.parentNode) {
            document.body.removeChild(notification);
        }
    }, 300);
}, 5000); // 5 секунд для всех устройств
    
    // Добавляем CSS анимации для мобильных
    if (!document.querySelector('#notification-animations')) {
        const style = document.createElement('style');
        style.id = 'notification-animations';
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            @keyframes slideInUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutDown {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// Установка даты по умолчанию
function setupDate() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('estimateDate');
    if (dateInput) {
        dateInput.value = today;
    }
}

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, начинаем инициализацию');
            
            // Для iOS применяем исправления
            if (isIOS) {
                console.log('Обнаружен iOS, применяем исправления');
                initForIOS();
                
                // Задержка для iOS чтобы все успело загрузиться
                setTimeout(initializeApp, 100);
            } else {
                initializeApp();
            }
        });

async function initializeApp() { // ← ДОБАВЬТЕ async
    console.log('Инициализация приложения');
    
    initializeEstimateData();
    renderPriceList();
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    setupEventListeners();
    setupDate();
    await initializeIslamicFeatures(); // ← ДОБАВЬТЕ await
    showTab('price');
    
    // Загружаем сохраненный масштаб
    loadZoomFactor();
    
    console.log('Приложение инициализировано');
}

function initializeEstimateData() {
    // Создаем 50 пустых строк для сметы с новыми полями
    estimateData = Array(50).fill().map((_, i) => ({
        id: i + 1,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false,
        
        // НОВЫЕ ПОЛЯ
        coefficient: 1.0,
        coeffComment: "",
        discount: 0,
        discountComment: "",
        rowComment: "",
        
        // Кэшируем исходные значения для расчетов
        originalPrice: 0
    }));
}
        // Функции для вкладок
        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем нужную вкладку
            const tabContent = document.getElementById(`${tabName}-tab`);
            const tabBtn = document.getElementById(`${tabName}TabBtn`);
            
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            if (tabBtn) {
                tabBtn.classList.add('active');
            }
        }

        // Рендеринг прайс-листа (обновленная версия с видео)
        function renderPriceList() {
            console.log('Рендеринг прайс-листа с видео-функционалом');
            const priceListContainer = document.getElementById('priceList');
            
            if (!priceListContainer) {
                console.error('Контейнер прайс-листа не найден!');
                return;
            }
            
            priceListContainer.innerHTML = '';
            
            priceData.forEach(section => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'price-section';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    ${section.section}
                    <i class="fas fa-chevron-down"></i>
                `;
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'section-content';
                
// Раскрываем первую секцию по умолчанию (убрано)
// if (section.section.includes("① Монтажные работы")) {
//     itemsContainer.classList.add('expanded');
//     sectionHeader.querySelector('i').className = 'fas fa-chevron-up';
// }
                
                section.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'price-item';
                    itemElement.dataset.id = item.id;
                    
                    // Создаем номер с возможностью клика для видео
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'item-number';
                    numberDiv.textContent = item.id;
                    
                    // Добавляем обработчик клика на номер
                    numberDiv.addEventListener('click', function(e) {
                        e.stopPropagation(); // Предотвращаем всплытие события
                        playVideoByNumber(item.id);
                    });
                    
                    // Создаем остальные элементы
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'item-name';
                    nameDiv.textContent = item.name;
                    
                    const unitDiv = document.createElement('div');
                    unitDiv.className = 'item-unit';
                    unitDiv.textContent = item.unit;
                    
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'item-price';
                    priceDiv.textContent = formatCurrency(item.price);
                    
                    // Добавляем все элементы
                    itemElement.appendChild(numberDiv);
                    itemElement.appendChild(nameDiv);
                    itemElement.appendChild(unitDiv);
                    itemElement.appendChild(priceDiv);
                    
                    // Добавляем обработчик для добавления в смету (на всю строку, кроме номера)
                    itemElement.addEventListener('click', function(e) {
                        // Если кликнули не на номере - добавляем в смету
                        if (!e.target.classList.contains('item-number')) {
                            addToEstimate(item);
                            showNotification(`Добавлено: ${item.name.substring(0, 80)}...`);
                        }
                    });
                    
                    itemsContainer.appendChild(itemElement);
                    
                    // Асинхронно проверяем наличие видео и обновляем класс
                    checkVideoExists(item.id).then(exists => {
                        if (exists) {
                            numberDiv.classList.add('video-available');
                        }
                    });
                });
                
                // Обработчик раскрытия/скрытия секции
                sectionHeader.addEventListener('click', function() {
                    const isExpanded = itemsContainer.classList.contains('expanded');
                    const icon = this.querySelector('i');
                    
                    if (isExpanded) {
                        itemsContainer.classList.remove('expanded');
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        itemsContainer.classList.add('expanded');
                        icon.className = 'fas fa-chevron-up';
                    }
                });
                
                sectionElement.appendChild(sectionHeader);
                sectionElement.appendChild(itemsContainer);
                priceListContainer.appendChild(sectionElement);
            });
            
            console.log('Прайс-лист с видео-функционалом отрендерен');
        }

        // НОВАЯ ФУНКЦИЯ: Расчет итога строки с учетом коэффициента и скидки
        function calculateRowTotal(row) {
            if (!row.priceId && !row.isMaterial && !row.name) return 0;
            
            // Сохраняем оригинальную цену при первом расчете
            if (row.originalPrice === 0 && row.price > 0) {
                row.originalPrice = row.price;
            }
            
            // Используем оригинальную цену для расчетов, если она есть
            const basePrice = row.originalPrice > 0 ? row.originalPrice : row.price;
            let priceWithCoeff = basePrice * (row.coefficient || 1.0);
            let total = priceWithCoeff * (row.quantity || 1);
            
            // Применяем скидку (в процентах)
            if (row.discount && row.discount > 0) {
                total = total * (1 - row.discount / 100);
            }
            
            return total;
        }

        // НОВАЯ ФУНКЦИЯ: Формирование отображаемого имени с комментариями
        function getDisplayName(row) {
            let displayName = row.name || '';
            
            // Добавляем комментарий к коэффициенту
            if (row.coefficient && row.coefficient !== 1.0 && row.coeffComment) {
                displayName += ` (${row.coeffComment})`;
            } else if (row.coefficient && row.coefficient !== 1.0) {
                displayName += ` (коэф. ${row.coefficient})`;
            }
            
            // Добавляем комментарий к скидке
            if (row.discount && row.discount > 0 && row.discountComment) {
                displayName += ` [${row.discountComment} -${row.discount}%]`;
            } else if (row.discount && row.discount > 0) {
                displayName += ` [скидка ${row.discount}%]`;
            }
            
            // Добавляем общий комментарий
            if (row.rowComment) {
                displayName += ` — ${row.rowComment}`;
            }
            
            return displayName;
        }
        // НОВАЯ ФУНКЦИЯ: Расчет итога строки с учетом коэффициента и скидки
        function calculateRowTotal(row) {
            if (!row.priceId && !row.isMaterial && !row.name) return 0;
            
            // Сохраняем оригинальную цену при первом расчете
            if (row.originalPrice === 0 && row.price > 0) {
                row.originalPrice = row.price;
            }
            
            // Используем оригинальную цену для расчетов, если она есть
            const basePrice = row.originalPrice > 0 ? row.originalPrice : row.price;
            let priceWithCoeff = basePrice * (row.coefficient || 1.0);
            let total = priceWithCoeff * (row.quantity || 1);
            
            // Применяем скидку (в процентах)
            if (row.discount && row.discount > 0) {
                total = total * (1 - row.discount / 100);
            }
            
            return total;
        }

        // НОВАЯ ФУНКЦИЯ: Формирование отображаемого имени с комментариями
        function getDisplayName(row) {
            let displayName = row.name || '';
            
            // Добавляем комментарий к коэффициенту
            if (row.coefficient && row.coefficient !== 1.0 && row.coeffComment) {
                displayName += ` (${row.coeffComment})`;
            } else if (row.coefficient && row.coefficient !== 1.0) {
                displayName += ` (коэф. ${row.coefficient})`;
            }
            
            // Добавляем комментарий к скидке
            if (row.discount && row.discount > 0 && row.discountComment) {
                displayName += ` [${row.discountComment} -${row.discount}%]`;
            } else if (row.discount && row.discount > 0) {
                displayName += ` [скидка ${row.discount}%]`;
            }
            
            // Добавляем общий комментарий
            if (row.rowComment) {
                displayName += ` — ${row.rowComment}`;
            }
            
            return displayName;
        }

// ========== ИСПРАВЛЕННАЯ ФУНКЦИЯ РЕНДЕРИНГА ТАБЛИЦЫ СМЕТЫ ==========
function renderEstimateTable() {
    const tableBody = document.getElementById('estimateTable');
    if (!tableBody) {
        console.error('Таблица сметы не найдена!');
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Получаем ВСЕ строки из estimateData
    const allRows = estimateData;
    console.log(`Рендеринг ${allRows.length} строк сметы с коэффициентами`);
    
    // Рендерим ВСЕ строки
    allRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        if (row.isMaterial) {
            tr.classList.add('material-row');
        }
        
        // ========== ИСПРАВЛЕННАЯ ЯЧЕЙКА С КОДОМ ==========
        const priceIdCell = document.createElement('td');
        priceIdCell.className = 'price-id-cell';
        priceIdCell.style.cssText = `
            text-align: center;
            vertical-align: middle;
            height: 36px;
            padding: 2px 4px;
        `;
        
        if (row.priceId && !isNaN(parseInt(row.priceId))) {
            // Создаем контейнер для номера и иконки
            const numberContainer = document.createElement('div');
            numberContainer.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
                width: 100%;
                height: 32px;
            `;
            
            // Создаем кликабельный номер
            const numberSpan = document.createElement('span');
            numberSpan.textContent = row.priceId;
            numberSpan.style.cssText = `
                cursor: pointer;
                color: ${videoLinks[row.priceId] ? '#e74c3c' : '#3498db'};
                font-weight: bold;
                text-decoration: ${videoLinks[row.priceId] ? 'underline' : 'none'};
                text-decoration-style: dotted;
                padding: 2px 4px;
                display: inline-block;
                line-height: 1;
            `;
            
            // Добавляем обработчик клика
            numberSpan.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`👆 Клик по номеру в смете: ${row.priceId}`);
                playVideoByNumber(row.priceId);
                return false;
            };
            
            numberSpan.ontouchstart = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`👆 Touch по номеру в смете: ${row.priceId}`);
                playVideoByNumber(row.priceId);
                return false;
            };
            
            numberContainer.appendChild(numberSpan);
            
            // Добавляем иконку видео если есть
            if (videoLinks[row.priceId]) {
                const videoIcon = document.createElement('i');
                videoIcon.className = 'fas fa-video';
                videoIcon.style.cssText = `
                    margin-left: 2px;
                    font-size: 10px;
                    color: #e74c3c;
                    pointer-events: none;
                `;
                numberContainer.appendChild(videoIcon);
            }
            
            priceIdCell.appendChild(numberContainer);
        } else {
            priceIdCell.textContent = row.priceId || '';
            priceIdCell.style.lineHeight = '32px';
        }
        
        // ========== ИСПРАВЛЕННАЯ ЯЧЕЙКА С НАИМЕНОВАНИЕМ ==========
        const nameCell = document.createElement('td');
        nameCell.className = 'search-cell';
        nameCell.style.cssText = `
            position: relative;
            height: 36px;
            padding: 2px 4px;
        `;
        
        const nameContainer = document.createElement('div');
        nameContainer.style.cssText = `
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            height: 32px;
            width: 100%;
            gap: 4px;
        `;
        
        // Основное поле ввода
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'search-input';
        searchInput.dataset.row = index;
        searchInput.value = row.name || '';
        searchInput.placeholder = row.isMaterial ? 'Материал...' : 'Начните вводить название...';
        searchInput.autocomplete = 'off';
        searchInput.style.cssText = `
            flex: 1;
            height: 28px;
            padding: 0 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            line-height: 28px;
            box-sizing: border-box;
        `;
        
        // Контейнер для значков коэффициентов/скидок
        const badgesContainer = document.createElement('div');
        badgesContainer.className = 'row-modifiers';
        badgesContainer.style.cssText = `
            display: flex;
            flex-wrap: nowrap;
            gap: 2px;
            height: 28px;
            align-items: center;
        `;
        
        // Добавляем значки если есть модификаторы
        if (row.coefficient && row.coefficient !== 1.0) {
            const coeffBadge = document.createElement('span');
            coeffBadge.className = 'coefficient-badge';
            coeffBadge.title = row.coeffComment || `Коэффициент ${row.coefficient}`;
            coeffBadge.textContent = `×${row.coefficient}`;
            coeffBadge.style.cssText = `
                display: inline-block;
                background: #3498db;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: normal;
                cursor: pointer;
                height: 20px;
                line-height: 16px;
                white-space: nowrap;
            `;
            badgesContainer.appendChild(coeffBadge);
        }
        
        if (row.discount && row.discount > 0) {
            const discBadge = document.createElement('span');
            discBadge.className = 'discount-badge';
            discBadge.title = row.discountComment || `Скидка ${row.discount}%`;
            discBadge.textContent = `-${row.discount}%`;
            discBadge.style.cssText = `
                display: inline-block;
                background: #e74c3c;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: normal;
                cursor: pointer;
                height: 20px;
                line-height: 16px;
                white-space: nowrap;
            `;
            badgesContainer.appendChild(discBadge);
        }
        
        if (row.rowComment) {
            const commentBadge = document.createElement('span');
            commentBadge.className = 'comment-badge';
            commentBadge.title = row.rowComment;
            commentBadge.innerHTML = '<i class="fas fa-comment"></i>';
            commentBadge.style.cssText = `
                display: inline-block;
                background: #f39c12;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: normal;
                cursor: pointer;
                height: 20px;
                line-height: 16px;
                white-space: nowrap;
            `;
            badgesContainer.appendChild(commentBadge);
        }
        
        nameContainer.appendChild(searchInput);
        nameContainer.appendChild(badgesContainer);
        
        // Добавляем выпадающий список
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.id = `dropdown-${index}`;
        dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        `;
        
        nameCell.appendChild(nameContainer);
        nameCell.appendChild(dropdown);
        
        // Ячейка единицы измерения
        const unitCell = document.createElement('td');
        unitCell.className = 'unit-cell';
        unitCell.textContent = row.unit || '';
        unitCell.style.cssText = `
            text-align: center;
            vertical-align: middle;
            height: 36px;
            padding: 2px 4px;
            line-height: 32px;
        `;
        
        // Ячейка цены
        const priceCell = document.createElement('td');
        priceCell.className = 'price-cell';
        priceCell.style.cssText = `
            padding: 2px;
            height: 36px;
            vertical-align: middle;
        `;
        priceCell.innerHTML = `
            <input type="number" class="number-input price-input" 
                   data-row="${index}" 
                   value="${row.price || ''}" 
                   min="0" step="0.01"
                   style="width: 100%; height: 32px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 0.85rem; box-sizing: border-box;">
        `;
        
        // Ячейка количества
        const quantityCell = document.createElement('td');
        quantityCell.className = 'quantity-cell';
        quantityCell.style.cssText = `
            padding: 2px;
            height: 36px;
            vertical-align: middle;
        `;
        quantityCell.innerHTML = `
            <input type="number" class="number-input quantity-input" 
                   data-row="${index}" 
                   value="${row.quantity || 1}" 
                   min="1" step="1"
                   style="width: 100%; height: 32px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 0.85rem; box-sizing: border-box;">
        `;
        
        // Ячейка суммы
        const totalCell = document.createElement('td');
        totalCell.className = 'total-cell';
        totalCell.style.cssText = `
            cursor: pointer;
            text-align: center;
            vertical-align: middle;
            height: 36px;
            padding: 2px 4px;
            font-weight: 600;
            color: #27ae60;
            line-height: 32px;
        `;
        totalCell.title = 'Нажмите для настройки коэффициента/скидки';
        totalCell.dataset.row = index;
        totalCell.textContent = formatCurrency(row.total);
        
        totalCell.addEventListener('click', function(e) {
            e.stopPropagation();
            const rowIndex = parseInt(this.dataset.row);
            if (estimateData[rowIndex] && (estimateData[rowIndex].priceId || estimateData[rowIndex].name)) {
                openRowSettings(rowIndex);
            } else {
                showNotification('Сначала выберите позицию');
            }
        });
        
        // Ячейка действий
        const actionsCell = document.createElement('td');
        actionsCell.className = 'actions-cell';
        actionsCell.style.cssText = `
            text-align: center;
            vertical-align: middle;
            height: 36px;
            padding: 2px 4px;
            line-height: 32px;
        `;
        actionsCell.innerHTML = `<i class="fas fa-trash delete-row" data-row="${index}" style="color: #e74c3c; cursor: pointer; font-size: 1rem;"></i>`;
        
        // Добавляем все ячейки в строку
        tr.appendChild(priceIdCell);
        tr.appendChild(nameCell);
        tr.appendChild(unitCell);
        tr.appendChild(priceCell);
        tr.appendChild(quantityCell);
        tr.appendChild(totalCell);
        tr.appendChild(actionsCell);
        
        tableBody.appendChild(tr);
    });
    
    // Настраиваем обработчики событий для всех новых строк
    setupRowEventListeners();
}
        // НОВАЯ ФУНКЦИЯ: Открытие модального окна настроек строки
        function openRowSettings(rowIndex, activeTab = 'coefficient') {
            const row = estimateData[rowIndex];
            if (!row || (!row.priceId && !row.isMaterial && !row.name)) {
                showNotification('Сначала выберите позицию');
                return;
            }
            
            currentRowIndex = rowIndex;
            
            // Заполняем поля
            document.getElementById('rowCoefficient').value = row.coefficient || 1.0;
            document.getElementById('rowCoeffComment').value = row.coeffComment || '';
            document.getElementById('rowDiscount').value = row.discount || 0;
            document.getElementById('rowDiscountComment').value = row.discountComment || '';
            document.getElementById('rowComment').value = row.rowComment || '';
            
            // Обновляем предпросмотр суммы
            updateRowPreview();
            
            // Переключаем вкладку
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === activeTab) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.settings-content').forEach(content => {
                content.classList.remove('active');
                document.getElementById(`${activeTab}Tab`).classList.add('active');
            });
            
            // Показываем модальное окно
            document.getElementById('rowSettingsModal').style.display = 'flex';
        }

        // НОВАЯ ФУНКЦИЯ: Обновление предпросмотра суммы в модальном окне
        function updateRowPreview() {
            if (currentRowIndex === -1) return;
            
            const row = estimateData[currentRowIndex];
            const coeff = parseFloat(document.getElementById('rowCoefficient').value) || 1.0;
            const discount = parseFloat(document.getElementById('rowDiscount').value) || 0;
            const quantity = row.quantity || 1;
            
            // Используем оригинальную цену или текущую
            const basePrice = row.originalPrice > 0 ? row.originalPrice : row.price;
            let priceWithCoeff = basePrice * coeff;
            let total = priceWithCoeff * quantity;
            
            if (discount > 0) {
                total = total * (1 - discount / 100);
            }
            
            const previewEl = document.getElementById('rowTotalPreview');
            previewEl.innerHTML = `
                <span class="base-price">база: ${formatCurrency(basePrice)} руб.</span>
                Итог: ${formatCurrency(total)} руб.
            `;
        }

        // НОВАЯ ФУНКЦИЯ: Применение настроек строки
        function applyRowSettings() {
            if (currentRowIndex === -1) {
                document.getElementById('rowSettingsModal').style.display = 'none';
                return;
            }
            
            const row = estimateData[currentRowIndex];
            
            // Сохраняем оригинальную цену если еще не сохранена
            if (row.originalPrice === 0 && row.price > 0) {
                row.originalPrice = row.price;
            }
            
            // Обновляем поля
            row.coefficient = parseFloat(document.getElementById('rowCoefficient').value) || 1.0;
            row.coeffComment = document.getElementById('rowCoeffComment').value;
            row.discount = parseFloat(document.getElementById('rowDiscount').value) || 0;
            row.discountComment = document.getElementById('rowDiscountComment').value;
            row.rowComment = document.getElementById('rowComment').value;
            
            // Пересчитываем итог строки
            row.total = calculateRowTotal(row);
            
            // Обновляем отображение
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            
            document.getElementById('rowSettingsModal').style.display = 'none';
            showNotification('Настройки применены');
        }

        // НОВАЯ ФУНКЦИЯ: Очистка настроек строки
        function clearRowSettings() {
            if (currentRowIndex === -1) return;
            
            const row = estimateData[currentRowIndex];
            
            // Сбрасываем поля
            row.coefficient = 1.0;
            row.coeffComment = '';
            row.discount = 0;
            row.discountComment = '';
            row.rowComment = '';
            
            // Восстанавливаем оригинальную цену если была
            if (row.originalPrice > 0) {
                row.price = row.originalPrice;
            }
            
            // Пересчитываем итог
            row.total = row.price * row.quantity;
            
            // Обновляем отображение
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            
            // Скрываем модальное окно
            document.getElementById('rowSettingsModal').style.display = 'none';
            showNotification('Настройки сброшены');
        }

        // НОВАЯ ФУНКЦИЯ: Обновление глобальных итогов с учетом глобальных настроек
        function updateTotals() {
            // Базовая сумма всех строк
            const baseTotal = estimateData.reduce((sum, row) => sum + row.total, 0);
            document.getElementById('baseTotalAmount').textContent = formatCurrency(baseTotal);
            
            // Получаем глобальные настройки
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            const globalCoeff = parseFloat(document.getElementById('globalCoefficient').value) || 1.0;
            const globalComment = document.getElementById('globalComment').value;
            
            let finalTotal = baseTotal;
            
            // Применяем глобальный коэффициент
            if (globalCoeff !== 1.0) {
                finalTotal = finalTotal * globalCoeff;
                document.getElementById('coefficientRow').style.display = 'flex';
                document.getElementById('coefficientValue').textContent = globalCoeff;
                document.getElementById('coefficientAdjustment').textContent = 
                    formatCurrency(finalTotal - baseTotal);
            } else {
                document.getElementById('coefficientRow').style.display = 'none';
            }
            
            // Применяем глобальную скидку
            if (globalDiscount > 0) {
                const discountAmount = finalTotal * (globalDiscount / 100);
                finalTotal = finalTotal - discountAmount;
                
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountPercent').textContent = globalDiscount;
                document.getElementById('discountAmount').textContent = '-' + formatCurrency(discountAmount);
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
            
            // Показываем глобальный комментарий
            if (globalComment) {
                document.getElementById('globalCommentRow').style.display = 'flex';
                document.getElementById('globalCommentText').innerHTML = 
                    `<i class="fas fa-comment"></i> ${globalComment}`;
            } else {
                document.getElementById('globalCommentRow').style.display = 'none';
            }
            
            document.getElementById('totalAmount').textContent = formatCurrency(finalTotal);
        }

        // НОВЫЕ ФУНКЦИИ ДЛЯ МАСШТАБИРОВАНИЯ
        function loadZoomFactor() {
            const savedZoom = localStorage.getItem('estimate_zoom');
            if (savedZoom) {
                zoomFactor = parseFloat(savedZoom);
                if (zoomFactor < MIN_ZOOM) zoomFactor = MIN_ZOOM;
                if (zoomFactor > MAX_ZOOM) zoomFactor = MAX_ZOOM;
            }
            applyZoom();
        }
        
        function saveZoomFactor() {
            localStorage.setItem('estimate_zoom', zoomFactor.toString());
        }
        
function applyZoom() {
    const scalable = document.getElementById('estimateScalable');
    const zoomPercent = document.getElementById('zoomPercent');
    
    if (scalable) {
        // Применяем масштабирование
        scalable.style.transform = `scale(${zoomFactor})`;
        
        // Обновляем отображение процентов
        if (zoomPercent) {
            zoomPercent.textContent = Math.round(zoomFactor * 100) + '%';
        }
        
        // Сохраняем значение
        saveZoomFactor();
        
        console.log('Масштаб применен:', zoomFactor);
    } else {
        console.error('Элемент estimateScalable не найден!');
    }
}
        
 function zoomIn() {
    if (zoomFactor < MAX_ZOOM) {
        zoomFactor = Math.min(zoomFactor + 0.1, MAX_ZOOM); // Увеличил шаг до 0.1
        applyZoom();
        console.log('Zoom In:', zoomFactor);
    } else {
        console.log('Максимальный масштаб достигнут');
    }
}

function zoomOut() {
    if (zoomFactor > MIN_ZOOM) {
        zoomFactor = Math.max(zoomFactor - 0.1, MIN_ZOOM); // Увеличил шаг до 0.1
        applyZoom();
        console.log('Zoom Out:', zoomFactor);
    } else {
        console.log('Минимальный масштаб достигнут');
    }
}

function zoomReset() {
    zoomFactor = 1.0;
    applyZoom();
    console.log('Zoom Reset');
}

function setupEventListeners() {
    console.log('Настройка обработчиков событий');
    
    // Вкладки
    document.getElementById('priceTabBtn').addEventListener('click', function() {
        showTab('price');
    });
    
    document.getElementById('estimateTabBtn').addEventListener('click', function() {
        showTab('estimate');
    });
    
    // Поиск по прайс-листу
    const priceSearch = document.getElementById('priceSearch');
    if (priceSearch) {
        priceSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const allItems = document.querySelectorAll('.price-item');
            
            allItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'grid';
                    // Раскрываем родительскую секцию
                    const section = item.closest('.price-section');
                    if (section) {
                        const content = section.querySelector('.section-content');
                        content.classList.add('expanded');
                        section.querySelector('i').className = 'fas fa-chevron-up';
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Выпадающее меню управления
    const dropdownBtn = document.getElementById('controlsDropdown');
    const menu = document.getElementById('controlsMenu');
    
    if (dropdownBtn && menu) {
        dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('show');
        });
        
        // Закрытие меню при клике вне его
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-controls')) {
                menu.classList.remove('show');
            }
        });
        
        // Кнопки меню
        document.getElementById('addRowBtn').addEventListener('click', function() {
            addEmptyRow();
            updateEstimateCounter();
            menu.classList.remove('show');
        });
        
        document.getElementById('addMaterialBtn').addEventListener('click', function() {
            showMaterialModal();
            menu.classList.remove('show');
        });
        
        // ОБНОВЛЕНИЕ СМЕТЫ И ПРОВЕРКА ВЕРСИЙ
        document.getElementById('refreshEstimateBtn').addEventListener('click', async function() {
            try {
                const swResponse = await fetch('sw.js?t=' + Date.now());
                const swCode = await swResponse.text();
                const versionMatch = swCode.match(/const APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
                
                if (!versionMatch) {
                    showNotification('❌ Не удалось проверить версию');
                    menu.classList.remove('show');
                    return;
                }
                
                const currentSWVersion = versionMatch[1];
                const myVersion = localStorage.getItem('app_version') || '1.0.0';
                
                if (currentSWVersion === myVersion) {
                    if (confirm('У вас актуальная версия!\n\nХотите очистить все данные сметы?')) {
                        localStorage.removeItem('electroEstimates');
                        showNotification('✅ Данные сметы очищены');
                    }
                    menu.classList.remove('show');
                    return;
                }
                
                const updateConfirmed = confirm(
                    `🎉 ДОСТУПНО ОБНОВЛЕНИЕ!\n\n` +
                    `Ваша версия: ${myVersion}\n` +
                    `Новая версия: ${currentSWVersion}\n\n` +
                    `Обновить сейчас?`
                );
                
                if (updateConfirmed) {
                    try {
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        if ('serviceWorker' in navigator) {
                            const reg = await navigator.serviceWorker.getRegistration();
                            if (reg) await reg.unregister();
                            
                            if ('caches' in window) {
                                const cacheNames = await caches.keys();
                                for (const cacheName of cacheNames) {
                                    await caches.delete(cacheName);
                                }
                            }
                        }
                        
                        showNotification('🔄 Загружаем новую версию...');
                        
                    } catch (error) {
                        console.error('Ошибка очистки:', error);
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Ошибка проверки обновления:', error);
                showNotification('❌ Ошибка при проверке обновлений');
            }
            
            menu.classList.remove('show');
        });
        
        document.getElementById('saveEstimateBtn').addEventListener('click', function() {
            saveEstimate();
            menu.classList.remove('show');
        });
        
        document.getElementById('loadEstimateBtn').addEventListener('click', function() {
            showLoadModal();
            menu.classList.remove('show');
        });
        
        document.getElementById('printEstimateBtn').addEventListener('click', function() {
            showPrintModal();
            menu.classList.remove('show');
        });
        
        document.getElementById('saveAsPdfBtn').addEventListener('click', function() {
            saveAsPDF();
            menu.classList.remove('show');
        });
    }
    
    // Модальные окна
    document.getElementById('closeMaterialModal').addEventListener('click', function() {
        document.getElementById('materialModal').style.display = 'none';
    });
    
    document.getElementById('closePrintModal').addEventListener('click', function() {
        document.getElementById('printModal').style.display = 'none';
    });
    
    document.getElementById('closeLoadModal').addEventListener('click', function() {
        document.getElementById('loadModal').style.display = 'none';
    });
    
    document.getElementById('addMaterialToEstimate').addEventListener('click', function() {
        addMaterialFromModal();
    });
    
    document.getElementById('generatePrint').addEventListener('click', function() {
        generatePrint();
    });
    
    // Закрытие модальных окон при клике на фон
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
    
    // МАСШТАБИРОВАНИЕ
    document.getElementById('zoomIn').addEventListener('click', zoomIn);
    document.getElementById('zoomOut').addEventListener('click', zoomOut);
    document.getElementById('zoomReset').addEventListener('click', zoomReset);
    
    // ГЛОБАЛЬНЫЕ НАСТРОЙКИ
    document.getElementById('globalDiscount').addEventListener('input', updateTotals);
    document.getElementById('globalCoefficient').addEventListener('input', updateTotals);
    document.getElementById('globalComment').addEventListener('input', updateTotals);
    
    // МОДАЛЬНОЕ ОКНО НАСТРОЕК СТРОКИ
    document.getElementById('closeRowSettingsModal').addEventListener('click', function() {
        document.getElementById('rowSettingsModal').style.display = 'none';
    });
    
    document.getElementById('applyRowSettings').addEventListener('click', applyRowSettings);
    document.getElementById('clearRowSettings').addEventListener('click', clearRowSettings);
    
    // Обновление предпросмотра
    document.getElementById('rowCoefficient').addEventListener('input', updateRowPreview);
    document.getElementById('rowDiscount').addEventListener('input', updateRowPreview);
    
    // Переключение вкладок в модальном окне
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${this.dataset.tab}Tab`).classList.add('active');
        });
    });
    
    // ===== НОВЫЕ ОБРАБОТЧИКИ ДЛЯ ЗАГРУЗКИ =====
    const loadSelectedBtn = document.getElementById('loadSelectedEstimateBtn');
    if (loadSelectedBtn) {
        loadSelectedBtn.addEventListener('click', loadSelectedEstimate);
    }

    const cancelBtn = document.getElementById('cancelLoadModalBtn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            document.getElementById('loadModal').style.display = 'none';
        });
    }
    
    console.log('Обработчики событий настроены');
	// ===== АВТОМАТИЧЕСКОЕ ЗАКРЫТИЕ МЕНЮ =====
document.querySelectorAll('#controlsMenu .dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
        // Список кнопок, после которых НЕ нужно закрывать меню
        const keepOpenIds = [
            'loadFromDriveBtn',      // старая кнопка Drive
            'googleDriveLoadBtn',     // новая кнопка Drive
            'saveToDriveBtn'          // сохранение в Drive
        ];
        
        // Если это не кнопка Drive - закрываем меню
        if (!keepOpenIds.includes(this.id)) {
            setTimeout(() => {
                const menu = document.getElementById('controlsMenu');
                if (menu) menu.classList.remove('show');
            }, 100);
        }
    });
});
}

        function setupRowEventListeners() {
            // Поиск и выпадающий список
            document.querySelectorAll('.search-input').forEach(input => {
                const rowIndex = parseInt(input.dataset.row);
                const row = estimateData[rowIndex];
                
                if (!row.isMaterial) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        } else {
                            hideDropdown(rowIndex);
                        }
                    });
                    
                    input.addEventListener('focus', function() {
                        const searchTerm = this.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        }
                    });
                }
            });
            
            // Закрытие выпадающих списков
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('search-input')) {
                    hideAllDropdowns();
                }
            });
            
// Изменение цены
document.querySelectorAll('.price-input').forEach(input => {
    input.addEventListener('input', function() {  // change → input
        const rowIndex = parseInt(this.dataset.row);
        updateRowTotal(rowIndex);
        updateEstimateCounter();
    });
});
            
            // Изменение количества
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    updateRowTotal(rowIndex);
                    updateEstimateCounter();
                });
            });
            
            // Удаление строки
            document.querySelectorAll('.delete-row').forEach(button => {
                button.addEventListener('click', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    deleteRow(rowIndex);
                    updateEstimateCounter();
                });
            });
        }

        // Основные функции приложения
        function addToEstimate(item) {
            // Ищем первую пустую строку
            let emptyRowIndex = estimateData.findIndex(row => !row.priceId && !row.isMaterial && row.name.trim() === '');
            
            // Если пустых строк нет, добавляем новую
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            // Заполняем строку с сохранением коэффициентов
            estimateData[emptyRowIndex] = {
                ...estimateData[emptyRowIndex],
                priceId: item.id,
                name: item.name,
                unit: item.unit,
                price: item.price,
                originalPrice: item.price,
                quantity: 1,
                total: item.price,
                isMaterial: false,
                
                // Сохраняем существующие коэффициенты если были
                coefficient: estimateData[emptyRowIndex].coefficient || 1.0,
                coeffComment: estimateData[emptyRowIndex].coeffComment || '',
                discount: estimateData[emptyRowIndex].discount || 0,
                discountComment: estimateData[emptyRowIndex].discountComment || '',
                rowComment: estimateData[emptyRowIndex].rowComment || ''
            };
            
            // Применяем коэффициенты если они есть
            if (estimateData[emptyRowIndex].coefficient !== 1.0 || estimateData[emptyRowIndex].discount > 0) {
                estimateData[emptyRowIndex].total = calculateRowTotal(estimateData[emptyRowIndex]);
            }
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
        }

function addEmptyRow() {
    const newId = estimateData.length + 1;
    estimateData.push({
        id: newId,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false,
        
        // Новые поля
        coefficient: 1.0,
        coeffComment: "",
        discount: 0,
        discountComment: "",
        rowComment: "",
        originalPrice: 0
    });
    
    renderEstimateTable();
    console.log(`Добавлена новая строка. Всего строк: ${estimateData.length}`);
}

        function deleteRow(rowIndex) {
            if (estimateData.length <= 1) {
                alert('Смета должна содержать хотя бы одну строку');
                return;
            }
            
            estimateData.splice(rowIndex, 1);
            
            // Обновляем порядковые номера
            estimateData.forEach((row, index) => {
                row.id = index + 1;
            });
            
            renderEstimateTable();
            updateTotals();
        }

function updateRowTotal(rowIndex) {
    console.log('updateRowTotal вызвана для строки:', rowIndex);
    
    const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
    const quantityInput = document.querySelector(`.quantity-input[data-row="${rowIndex}"]`);
    
    console.log('priceInput:', priceInput);
    console.log('quantityInput:', quantityInput);
    
    const price = parseFloat(priceInput.value) || 0;
    const quantity = parseInt(quantityInput.value) || 1;
    
    console.log('Новая цена:', price);
    console.log('Количество:', quantity);
    
    estimateData[rowIndex].price = price;
    estimateData[rowIndex].originalPrice = price;  // ВСЕГДА обновляем originalPrice
    estimateData[rowIndex].quantity = quantity;
    
    // Пересчитываем с учетом коэффициентов
    estimateData[rowIndex].total = calculateRowTotal(estimateData[rowIndex]);
    
    console.log('Новый total:', estimateData[rowIndex].total);
    
    const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
    if (totalCell) {
        totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
    }
    
    updateTotals();
}

        function updateEstimateCounter() {
            const filledRows = estimateData.filter(row => 
                (row.priceId || row.name.trim() !== '') && !row.isMaterial
            ).length;
            
            const counterElement = document.getElementById('estimateCounter');
            counterElement.textContent = filledRows;
            
            if (filledRows === 0) {
                counterElement.style.backgroundColor = '#6c757d';
            } else if (filledRows < 5) {
                counterElement.style.backgroundColor = '#f39c12';
            } else {
                counterElement.style.backgroundColor = '#27ae60';
            }
        }
        // НОВАЯ ФУНКЦИЯ: Открытие модального окна настроек строки
        function openRowSettings(rowIndex, activeTab = 'coefficient') {
            const row = estimateData[rowIndex];
            if (!row || (!row.priceId && !row.isMaterial && !row.name)) {
                showNotification('Сначала выберите позицию');
                return;
            }
            
            currentRowIndex = rowIndex;
            
            // Заполняем поля
            document.getElementById('rowCoefficient').value = row.coefficient || 1.0;
            document.getElementById('rowCoeffComment').value = row.coeffComment || '';
            document.getElementById('rowDiscount').value = row.discount || 0;
            document.getElementById('rowDiscountComment').value = row.discountComment || '';
            document.getElementById('rowComment').value = row.rowComment || '';
            
            // Обновляем предпросмотр суммы
            updateRowPreview();
            
            // Переключаем вкладку
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === activeTab) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.settings-content').forEach(content => {
                content.classList.remove('active');
                document.getElementById(`${activeTab}Tab`).classList.add('active');
            });
            
            // Показываем модальное окно
            document.getElementById('rowSettingsModal').style.display = 'flex';
        }

        // НОВАЯ ФУНКЦИЯ: Обновление предпросмотра суммы в модальном окне
        function updateRowPreview() {
            if (currentRowIndex === -1) return;
            
            const row = estimateData[currentRowIndex];
            const coeff = parseFloat(document.getElementById('rowCoefficient').value) || 1.0;
            const discount = parseFloat(document.getElementById('rowDiscount').value) || 0;
            const quantity = row.quantity || 1;
            
            // Используем оригинальную цену или текущую
            const basePrice = row.originalPrice > 0 ? row.originalPrice : row.price;
            let priceWithCoeff = basePrice * coeff;
            let total = priceWithCoeff * quantity;
            
            if (discount > 0) {
                total = total * (1 - discount / 100);
            }
            
            const previewEl = document.getElementById('rowTotalPreview');
            previewEl.innerHTML = `
                <span class="base-price">база: ${formatCurrency(basePrice)} руб.</span>
                Итог: ${formatCurrency(total)} руб.
            `;
        }

        // НОВАЯ ФУНКЦИЯ: Применение настроек строки
        function applyRowSettings() {
            if (currentRowIndex === -1) {
                document.getElementById('rowSettingsModal').style.display = 'none';
                return;
            }
            
            const row = estimateData[currentRowIndex];
            
            // Сохраняем оригинальную цену если еще не сохранена
            if (row.originalPrice === 0 && row.price > 0) {
                row.originalPrice = row.price;
            }
            
            // Обновляем поля
            row.coefficient = parseFloat(document.getElementById('rowCoefficient').value) || 1.0;
            row.coeffComment = document.getElementById('rowCoeffComment').value;
            row.discount = parseFloat(document.getElementById('rowDiscount').value) || 0;
            row.discountComment = document.getElementById('rowDiscountComment').value;
            row.rowComment = document.getElementById('rowComment').value;
            
            // Пересчитываем итог строки
            row.total = calculateRowTotal(row);
            
            // Обновляем отображение
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            
            document.getElementById('rowSettingsModal').style.display = 'none';
            showNotification('Настройки применены');
        }

        // НОВАЯ ФУНКЦИЯ: Очистка настроек строки
        function clearRowSettings() {
            if (currentRowIndex === -1) return;
            
            const row = estimateData[currentRowIndex];
            
            // Сбрасываем поля
            row.coefficient = 1.0;
            row.coeffComment = '';
            row.discount = 0;
            row.discountComment = '';
            row.rowComment = '';
            
            // Восстанавливаем оригинальную цену если была
            if (row.originalPrice > 0) {
                row.price = row.originalPrice;
            }
            
            // Пересчитываем итог
            row.total = row.price * row.quantity;
            
            // Обновляем отображение
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            
            // Скрываем модальное окно
            document.getElementById('rowSettingsModal').style.display = 'none';
            showNotification('Настройки сброшены');
        }
function clearEstimate() {
    if (confirm('Вы уверены, что хотите очистить всю смету?')) {
        estimateData = [{
            id: 1,
            priceId: "",
            name: "",
            unit: "",
            price: 0,
            quantity: 1,
            total: 0,
            notes: "",
            isMaterial: false,
            
            // Новые поля
            coefficient: 1.0,
            coeffComment: "",
            discount: 0,
            discountComment: "",
            rowComment: "",
            originalPrice: 0
        }];
        
        renderEstimateTable();
        updateTotals();
        updateEstimateCounter();
        showNotification('Смета очищена');
    }
}

        // Материалы
        function showMaterialModal() {
            document.getElementById('materialName').value = '';
            document.getElementById('materialUnit').value = 'шт.';
            document.getElementById('materialPrice').value = '';
            document.getElementById('materialQuantity').value = '1';
            
            document.getElementById('materialModal').style.display = 'flex';
        }

        function addMaterialFromModal() {
            const name = document.getElementById('materialName').value.trim();
            const unit = document.getElementById('materialUnit').value;
            const price = parseFloat(document.getElementById('materialPrice').value) || 0;
            const quantity = parseInt(document.getElementById('materialQuantity').value) || 1;
            
            if (!name) {
                alert('Введите наименование материала');
                return;
            }
            
            if (price <= 0) {
                alert('Введите корректную цену');
                return;
            }
            
            let emptyRowIndex = estimateData.findIndex(row => row.name.trim() === '');
            
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            estimateData[emptyRowIndex] = {
                id: estimateData[emptyRowIndex].id,
                priceId: `MAT${nextMaterialId++}`,
                name: name,
                unit: unit,
                price: price,
                originalPrice: price,
                quantity: quantity,
                total: price * quantity,
                notes: "",
                isMaterial: true,
                
                // Новые поля
                coefficient: 1.0,
                coeffComment: "",
                discount: 0,
                discountComment: "",
                rowComment: ""
            };
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            document.getElementById('materialModal').style.display = 'none';
            
            showTab('estimate');
            showNotification(`Материал добавлен: ${name.substring(0, 30)}...`);
        }

        // Выпадающие списки
        function showDropdown(rowIndex, searchTerm) {
            hideAllDropdowns();
            
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            dropdown.innerHTML = '';
            
            const matches = [];
            priceData.forEach(section => {
                section.items.forEach(item => {
                    if (item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        item.id.toString().includes(searchTerm)) {
                        matches.push(item);
                    }
                });
            });
            
            if (matches.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item';
                noResults.textContent = 'Ничего не найдено';
                dropdown.appendChild(noResults);
            } else {
                matches.slice(0, 10).forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'dropdown-item';
                    itemElement.innerHTML = `
                        <strong>${item.id}</strong>: ${item.name.substring(0, 50)}${item.name.length > 50 ? '...' : ''} (${item.unit}) - ${formatCurrency(item.price)}
                    `;
                    
                    itemElement.addEventListener('click', function() {
                        selectPriceItem(rowIndex, item);
                        hideDropdown(rowIndex);
                    });
                    
                    dropdown.appendChild(itemElement);
                });
            }
            
            dropdown.style.display = 'block';
        }

        function hideDropdown(rowIndex) {
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }

        function selectPriceItem(rowIndex, item) {
            const searchInput = document.querySelector(`.search-input[data-row="${rowIndex}"]`);
            const priceIdCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .price-id-cell`);
            const unitCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .unit-cell`);
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            
            if (searchInput && priceIdCell && unitCell && priceInput) {
                searchInput.value = item.name;
                priceIdCell.textContent = item.id;
                unitCell.textContent = item.unit;
                priceInput.value = item.price;
                
                estimateData[rowIndex].priceId = item.id;
                estimateData[rowIndex].name = item.name;
                estimateData[rowIndex].unit = item.unit;
                estimateData[rowIndex].price = item.price;
                estimateData[rowIndex].originalPrice = item.price;
                estimateData[rowIndex].isMaterial = false;
                
                // Пересчитываем с учетом коэффициентов
                estimateData[rowIndex].total = calculateRowTotal(estimateData[rowIndex]);
                
                const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
                if (totalCell) {
                    totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
                }
                
                updateTotals();
                updateEstimateCounter();
            }
        }

// ========== СОХРАНЕНИЕ И ЗАГРУЗКА ==========
// Переменная для хранения выбранной сметы
let selectedEstimateId = null;

function saveEstimate() {
    const estimateName = prompt('Введите название для сохранения сметы:', `Смета ${new Date().toLocaleDateString()}`);
    
    if (estimateName) {
        // Фильтруем ТОЛЬКО заполненные строки при сохранении
        const filledRows = estimateData.filter(row => 
            row.priceId || row.name.trim() !== '' || row.isMaterial
        );
        
        const estimateToSave = {
            id: Date.now(),
            name: estimateName,
            date: new Date().toISOString(),
            data: filledRows.map(row => ({ 
                ...row,
                // Сохраняем все поля включая новые
                originalPrice: row.originalPrice || row.price
            })),
            totals: {
                totalAmount: parseFloat(document.getElementById('totalAmount').textContent.replace(/\s/g, ''))
            },
            
            // Сохраняем глобальные настройки
            globalSettings: {
                discount: parseFloat(document.getElementById('globalDiscount').value) || 0,
                coefficient: parseFloat(document.getElementById('globalCoefficient').value) || 1.0,
                comment: document.getElementById('globalComment').value || ''
            },
            
            // Сохраняем масштаб
            zoom: zoomFactor
        };
        
        savedEstimates.push(estimateToSave);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        showNotification(`Смета "${estimateName}" сохранена (${filledRows.length} строк)`);
    }
}

function showLoadModal() {
	    // Сначала закрываем меню
    const menu = document.getElementById('controlsMenu');
    if (menu) menu.classList.remove('show');
    const listContainer = document.getElementById('savedEstimatesList');
    const loadBtn = document.getElementById('loadSelectedEstimateBtn');
    listContainer.innerHTML = '';
    selectedEstimateId = null;
    
    if (loadBtn) loadBtn.style.display = 'none';
    
    if (savedEstimates.length === 0) {
        listContainer.innerHTML = '<div class="empty-estimates">📁 Нет сохраненных смет</div>';
    } else {
        // Сортируем по дате (сначала новые)
        const sortedEstimates = [...savedEstimates].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        sortedEstimates.forEach(estimate => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'estimate-item';
            itemDiv.dataset.id = estimate.id;
            
            // Форматируем дату
            const date = new Date(estimate.date).toLocaleDateString('ru-RU');
            
            itemDiv.innerHTML = `
                <div class="estimate-item-info">
                    <div class="estimate-item-name">${estimate.name}</div>
                    <div class="estimate-item-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${date}</span>
                        <span><i class="fas fa-list"></i> ${estimate.data.length} позиций</span>
                        <span><i class="fas fa-ruble-sign"></i> ${formatCurrency(estimate.totals.totalAmount)}</span>
                    </div>
                </div>
                <div class="estimate-item-actions">
                    <button class="estimate-edit-btn" onclick="editEstimateName(${estimate.id})" title="Редактировать название">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="estimate-delete-btn" onclick="deleteSavedEstimate(${estimate.id})" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            // Клик по элементу для выбора
            itemDiv.addEventListener('click', function(e) {
                // Если кликнули не по кнопкам действий
                if (!e.target.closest('button')) {
                    // Снимаем выделение со всех
                    document.querySelectorAll('.estimate-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    // Выделяем текущий
                    this.classList.add('selected');
                    selectedEstimateId = estimate.id;
                    
                    // Показываем кнопку загрузки
                    if (loadBtn) loadBtn.style.display = 'inline-flex';
                }
            });
            
            listContainer.appendChild(itemDiv);
        });
    }
    
    document.getElementById('loadModal').style.display = 'flex';
}

function editEstimateName(estimateId) {
    const estimate = savedEstimates.find(e => e.id === estimateId);
    if (!estimate) return;
    
    const newName = prompt('Введите новое название сметы:', estimate.name);
    if (newName && newName.trim() !== '') {
        estimate.name = newName.trim();
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        showLoadModal(); // Обновляем список
        showNotification('✅ Название сметы изменено');
    }
}

function loadSelectedEstimate() {
    if (selectedEstimateId) {
        loadEstimate(selectedEstimateId);
        document.getElementById('loadModal').style.display = 'none';
    }
}

function loadEstimate(estimateId) {
    console.log('Загрузка сметы ID:', estimateId);
    const estimate = savedEstimates.find(e => e.id === estimateId);
    
    if (estimate) {
        console.log('Найдена смета:', estimate.name);
        console.log('Количество строк в сохраненной смете:', estimate.data.length);
        
        // Очищаем текущие данные
        estimateData = [];
        
        // Загружаем ВСЕ сохраненные данные
        estimate.data.forEach((item, index) => {
            estimateData.push({ 
                ...item,
                id: index + 1,  // Пересчитываем ID
                // Убеждаемся что все новые поля есть
                coefficient: item.coefficient || 1.0,
                coeffComment: item.coeffComment || '',
                discount: item.discount || 0,
                discountComment: item.discountComment || '',
                rowComment: item.rowComment || '',
                originalPrice: item.originalPrice || item.price || 0
            });
        });
        
        // Если сохранено меньше 50 строк, добавляем пустые до 50
        const targetCount = 50;
        while (estimateData.length < targetCount) {
            estimateData.push({
                id: estimateData.length + 1,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false,
                coefficient: 1.0,
                coeffComment: "",
                discount: 0,
                discountComment: "",
                rowComment: "",
                originalPrice: 0
            });
        }
        
        // Загружаем глобальные настройки если есть
        if (estimate.globalSettings) {
            document.getElementById('globalDiscount').value = estimate.globalSettings.discount || 0;
            document.getElementById('globalCoefficient').value = estimate.globalSettings.coefficient || 1.0;
            document.getElementById('globalComment').value = estimate.globalSettings.comment || '';
        }
        
        // Загружаем масштаб если есть
        if (estimate.zoom) {
            zoomFactor = estimate.zoom;
            if (zoomFactor < MIN_ZOOM) zoomFactor = MIN_ZOOM;
            if (zoomFactor > MAX_ZOOM) zoomFactor = MAX_ZOOM;
            applyZoom();
        }
        
        console.log('Данные загружены в estimateData:', estimateData.length, 'строк');
        
        // Рендерим таблицу
        renderEstimateTable();
        updateTotals();
        updateEstimateCounter();
        showTab('estimate');
        
        showNotification(`Загружена смета: ${estimate.name} (${estimate.data.length} позиций)`);
    }
}

function deleteSavedEstimate(estimateId) {
    savedEstimates = savedEstimates.filter(e => e.id !== estimateId);
    localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
    showLoadModal();
}
        // Печать
        function showPrintModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('estimateDate').value = today;
            
            const estimateCount = savedEstimates.length + 1;
            document.getElementById('estimateNumber').value = `СМ-${estimateCount.toString().padStart(3, '0')}`;
            
            document.getElementById('printModal').style.display = 'flex';
        }
                // ==========  ФУНКЦИИ ПЕЧАТИ==========
// Обновленная функция generatePrint с отправкой PDF через "Поделиться"
function generatePrint() {
    const executorName = document.getElementById('executorName').value || 'ЭлектроСмета';
    const executorInn = document.getElementById('executorInn').value || '';
    const executorPhone = document.getElementById('executorPhone').value || '+7 (963) 598-48-46';
    const clientName = document.getElementById('clientName').value || 'Клиент не указан';
    const clientContacts = document.getElementById('clientContacts').value || '';
    const projectName = document.getElementById('projectName').value || '';
    const estimateNumber = document.getElementById('estimateNumber').value;
    const estimateDate = document.getElementById('estimateDate').value;
    const notes = document.getElementById('notes').value;
    const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '');
    const logoHtml = logoDataUrl ? 
    `<div style="height: 10px; position: relative;">
        <div style="position: absolute; top: -13px; left: -5;">
            <img src="${logoDataUrl}" style="max-height: 160px; max-width: 160px; object-fit: contain;">
        </div>
    </div>` : '';

    if (filledRows.length === 0) {
        alert('Смета пуста! Добавьте позиции перед печатью.');
        return;
    }
    
    const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
    const globalCoeff = parseFloat(document.getElementById('globalCoefficient').value) || 1.0;
    const globalComment = document.getElementById('globalComment').value;
    
    const baseTotal = filledRows.reduce((sum, row) => sum + row.total, 0);
    let finalTotal = baseTotal;
    
    if (globalCoeff !== 1.0) finalTotal = finalTotal * globalCoeff;
    if (globalDiscount > 0) finalTotal = finalTotal * (1 - globalDiscount / 100);
    
    // Создаем HTML с кнопками
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Смета ${estimateNumber}</title>
            <style>
                @page { margin: 0; }
                body { font-family: Arial; padding: 20px; background: #000000; }
                .print-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #3498db !important; padding-bottom: 20px; }
                .header h1 { color: #e74c3c !important; font-size: 24px; margin: 10px 0; }
                .header > div:first-child, .header > div:first-child *, div[style*="ИСПОЛНИТЕЛЬ:"] , div[style*="ИСПОЛНИТЕЛЬ:"] *, div[style*="ЗАКАЗЧИК:"] , div[style*="ЗАКАЗЧИК:"] * { color: #3498db !important; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 9px; }
                .modifier-note { color: #000000 !important; font-size: 11px; margin-left: 5px; }
                th, td { border: 1px solid #000000 !important; padding: 3px 2px; }
                td { color: #000000 !important; }
                th { background: #87CEFA !important; color: black !important; font-size: 9px; }
                td:first-child { color: #000000 !important; font-weight: bold; }
                .total { text-align: right; font-size: 12px; font-weight: bold; margin: 10px 0; color: #27ae60 !important; }
                .global-panel { color: #000000 !important; font-size: 9px; padding: 5px; }
                .controls { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000; }
                .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
                .btn:hover { opacity: 0.9; transform: translateY(-2px); }
                .btn-print { background: #3498db !important; color: white !important; }
                .btn-pdf { background: #27ae60 !important; color: white !important; }
                .btn-share { background: #9b59b6 !important; color: white !important; }
                .btn-close { background: #e74c3c !important; color: white !important; }
                @media print { .controls { display: none !important; } body { background: white !important; } .print-container { box-shadow: none !important; padding: 0 !important; } }
            </style>
        </head>
        <body>
            <div class="controls">
                <button onclick="window.print()" class="btn btn-print">
                    <span>🖨️</span> Печать
                </button>
                <button onclick="saveAsPDFFromPrint()" class="btn btn-pdf">
                    <span>📄</span> PDF
                </button>
                <button onclick="sharePDF()" class="btn btn-share">
                    <span>📱</span> Поделиться PDF
                </button>
                <button onclick="window.close()" class="btn btn-close">
                    <span>✕</span> Закрыть
                </button>
            </div>
            
            <div class="print-container" id="pdfContent">
                <div class="header">
                    <div style="display: flex; justify-content: space-between; margin-top: 30px; margin-bottom: 20px; padding: 10px 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="text-align: left;">
                            <strong style="color: #2c3e50;">ИСПОЛНИТЕЛЬ:</strong><br>
                            ${executorName}<br>
                            ${executorInn ? `ИНН: ${executorInn}<br>` : ''}
                            ${executorPhone ? `Тел.: ${executorPhone}` : ''}
                        </div>
                        <div style="text-align: right;">
                            <strong style="color: #2c3e50;">ЗАКАЗЧИК:</strong><br>
                            ${clientName}<br>
                            ${clientContacts ? `${clientContacts}<br>` : ''}
                            ${projectName ? `Объект: ${projectName}` : ''}
                        </div>
                    </div>
                    ${logoHtml}
                    <h1 style="color: #2c3e50;">СМЕТА № ${estimateNumber}</h1>
                    <div style="font-size: 16px; margin: 10px 0;"><strong>Клиент:</strong> ${clientName}</div>
                    <div style="font-size: 16px;"><strong>Дата:</strong> ${new Date(estimateDate).toLocaleDateString('ru-RU')}</div>
                </div>
                
                ${(globalDiscount > 0 || globalCoeff !== 1.0 || globalComment) ? `
                <div class="global-panel">
                    <strong>Общие настройки:</strong><br>
                    ${globalDiscount > 0 ? `Скидка: ${globalDiscount}%<br>` : ''}
                    ${globalCoeff !== 1.0 ? `Коэффициент: ${globalCoeff}<br>` : ''}
                    ${globalComment ? `Комментарий: ${globalComment}` : ''}
                </div>
                ` : ''}
                
                <table>
                    <thead>
                        <tr>
                            <th>Код</th>
                            <th>Наименование</th>
                            <th>Ед.</th>
                            <th>Цена, руб.</th>
                            <th>Кол-во</th>
                            <th>Сумма, руб.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filledRows.map((row, index) => {
                            let fullName = row.name || '';
                            if (row.coefficient && row.coefficient !== 1.0) {
                                fullName += ` <span class="modifier-note">[коэф. ${row.coefficient}${row.coeffComment ? ': ' + row.coeffComment : ''}]</span>`;
                            }
                            if (row.discount && row.discount > 0) {
                                fullName += ` <span class="modifier-note">[скидка ${row.discount}%${row.discountComment ? ': ' + row.discountComment : ''}]</span>`;
                            }
                            if (row.rowComment) {
                                fullName += ` <span class="modifier-note">— ${row.rowComment}</span>`;
                            }
                            
                            return `
                            <tr>
                                <td><strong>${row.priceId || ''}</strong></td>
                                <td>${fullName}</td>
                                <td>${row.unit || ''}</td>
                                <td>${formatCurrency(row.price)}</td>
                                <td>${row.quantity}</td>
                                <td><strong style="color: #27ae60;">${formatCurrency(row.total)}</strong></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <div style="text-align: right; font-size: 16px; margin-bottom: 5px;">
                        <span style="color: #666;">Базовая сумма:</span>
                        <strong>${formatCurrency(baseTotal)} руб.</strong>
                    </div>
                    ${globalCoeff !== 1.0 ? `
                    <div style="text-align: right; font-size: 16px; margin-bottom: 5px;">
                        <span style="color: #666;">С учетом коэффициента ${globalCoeff}:</span>
                        <strong>${formatCurrency(baseTotal * globalCoeff)} руб.</strong>
                    </div>
                    ` : ''}
                    ${globalDiscount > 0 ? `
                    <div style="text-align: right; font-size: 16px; margin-bottom: 5px;">
                        <span style="color: #666;">Скидка ${globalDiscount}%:</span>
                        <strong>-${formatCurrency(baseTotal * globalCoeff * (globalDiscount / 100))} руб.</strong>
                    </div>
                    ` : ''}
                </div>
                
                <div class="total">
                    ИТОГО: ${formatCurrency(finalTotal)} руб.
                </div>
                
                ${notes ? `<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #3498db; margin: 20px 0;">
                    <strong>Примечания:</strong><br>${notes.replace(/\n/g, '<br>')}
                </div>` : ''}
                
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                    Смета составлена в приложении "ЭлектроСмета" от Electric_Group для Братьев<br>
                    Дата формирования: ${new Date().toLocaleString('ru-RU')}<br>
                    Сайт разработчика https://alivu.github.io/
                </div>
            </div>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
            
            <script>
                // Глобальные функции для доступа из onclick
                window.saveAsPDFFromPrint = function() {
                    window.opener.postMessage({
                        action: 'savePDFFromPrint',
                        data: {
                            executorName: '${executorName}',
                            executorInn: '${executorInn}',
                            executorPhone: '${executorPhone}',
                            clientName: '${clientName}',
                            clientContacts: '${clientContacts}',
                            projectName: '${projectName}',
                            estimateNumber: '${estimateNumber}',
                            estimateDate: '${estimateDate}',
                            notes: '${notes ? notes.replace(/'/g, "\\'").replace(/\\/g, "\\\\") : ''}',
                            logoDataUrl: '${logoDataUrl || ''}'
                        }
                    }, '*');
                };
                
                window.sharePDF = async function() {
                    try {
                        // Показываем индикатор загрузки
                        const loadingDiv = document.createElement('div');
                        loadingDiv.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:20px 30px; border-radius:10px; z-index:10000;';
                        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание PDF для отправки...';
                        document.body.appendChild(loadingDiv);
                        
                        // Создаем PDF из контента
                        const element = document.getElementById('pdfContent');
                        const canvas = await html2canvas(element, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });
                        
                        const imgWidth = 190;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                        
                        // Получаем PDF как Blob
                        const pdfBlob = pdf.output('blob');
                        
                        // Убираем индикатор загрузки
                        document.body.removeChild(loadingDiv);
                        
                        // Создаем имя файла
                        const fileName = \`Смета_${estimateNumber}_${new Date().toISOString().split('T')[0]}.pdf\`;
                        
                        // Пытаемся использовать Web Share API для отправки PDF
                        if (navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], fileName, { type: 'application/pdf' })] })) {
                            await navigator.share({
                                title: 'Смета ${estimateNumber}',
                                text: \`Смета от ${clientName}\`,
                                files: [new File([pdfBlob], fileName, { type: 'application/pdf' })]
                            });
                        } 
                        // Если Web Share API не поддерживает файлы, пробуем обычный share
                        else if (navigator.share) {
                            // На iOS и некоторых Android можно поделиться ссылкой на файл
                            const pdfUrl = URL.createObjectURL(pdfBlob);
                            await navigator.share({
                                title: 'Смета ${estimateNumber}',
                                text: \`Смета от ${clientName} на сумму ${formatCurrency(finalTotal)} руб.\`,
                                url: pdfUrl
                            });
                            setTimeout(() => URL.revokeObjectURL(pdfUrl), 5000);
                        }
                        else {
                            // Если Web Share API недоступен - сохраняем файл
                            const url = URL.createObjectURL(pdfBlob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            // Показываем сообщение
                            alert('✅ PDF сохранен. Вы можете отправить его через любое приложение.');
                        }
                        
                    } catch (error) {
                        console.error('Ошибка при отправке PDF:', error);
                        alert('❌ Не удалось отправить PDF. Попробуйте сохранить файл и отправить вручную.');
                    }
                };
                
                window.onafterprint = function() {
                    setTimeout(() => {
                        if (confirm('Закрыть окно печати?')) {
                            window.close();
                        }
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `;
    
    document.getElementById('printModal').style.display = 'none';
    
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.open();
    printWindow.document.write(printContent);
    printWindow.document.close();
}
function printPriceList() {
    console.log('Печать прайс-листа');
    
    // Получаем сегодняшнюю дату
    const today = new Date().toLocaleDateString('ru-RU');
    const hijri = getHijriDate();
    
    // Создаем HTML для печати прайс-листа
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Прайс-лист Электрика 29.12.2026г</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    background: #f5f5f5;
                }
                .print-container {
                    max-width: 1000px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #3498db;
                    padding-bottom: 20px;
                }
                .controls {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    display: flex;
                    gap: 10px;
                    z-index: 1000;
                }
                .btn {
                    padding: 12px 25px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: 0.3s;
                }
                .btn:hover { opacity: 0.9; transform: translateY(-2px); }
                .btn-print { background: #3498db; color: white; }
                .btn-pdf { background: #27ae60; color: white; }
                .btn-close { background: #e74c3c; color: white; }
                
                /* Стили для таблицы прайс-листа */
                .price-section {
                    margin-bottom: 25px;
                    page-break-inside: avoid;
                }
                .section-title {
                    background: linear-gradient(to right, #2c3e50, #3498db);
                    color: white;
                    padding: 12px 15px;
                    font-weight: bold;
                    font-size: 16px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                }
                .price-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 12px;
                }
                .price-table th {
                    background: #f8f9fa;
                    color: #2c3e50;
                    padding: 10px 8px;
                    text-align: left;
                    border-bottom: 2px solid #dee2e6;
                    font-weight: bold;
                }
                .price-table td {
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                }
                .price-table tr:hover {
                    background: #f8f9fa;
                }
                .id-cell { width: 50px; font-weight: bold; color: #3498db; }
                .name-cell { }
                .unit-cell { width: 80px; text-align: center; }
                .price-cell { width: 120px; text-align: right; font-weight: bold; color: #27ae60; }
                
                @media print {
                    .controls { display: none; }
                    body { background: white; padding: 0; }
                    .print-container { box-shadow: none; padding: 0; }
                    .price-table { font-size: 10px; }
                }
                
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    font-size: 11px;
                    color: #666;
                    text-align: center;
                }
                .hijri-date {
                    background: #f8f9fa;
                    padding: 5px 10px;
                    border-radius: 4px;
                    display: inline-block;
                    margin-top: 5px;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <div class="controls">
                <button onclick="window.print()" class="btn btn-print">
                    <span>🖨️</span> Печать
                </button>
                <button onclick="savePriceAsPDF()" class="btn btn-pdf">
                    <span>📄</span> Скачать PDF
                </button>
                <button onclick="window.close()" class="btn btn-close">
                    <span>✕</span> Закрыть
                </button>
            </div>
            
 <div class="print-container">
    <div class="header">
        <h1 style="color: #2c3e50; margin-bottom: 10px;">Прайс-лист Электрика 29.12.2026г</h1>
        <div style="font-size: 18px; color: #3498db; margin-bottom: 5px;">Братство Электриков ЧР</div>
        <div style="font-size: 16px; margin-bottom: 10px;">
            <strong>Дата:</strong> ${today} | ${hijri.day} ${hijri.month} ${hijri.year} г.х.
        </div>
        <div style="margin-top: 15px; font-size: 14px; color: #666;">
            Для профессионального расчета смет используйте приложение "ЭлектроСмета"
        </div>
    </div>
                
                ${priceData.map(section => `
                    <div class="price-section">
                        <div class="section-title">${section.section}</div>
                        <table class="price-table">
                            <thead>
                                <tr>
                                    <th class="id-cell">Код</th>
                                    <th class="name-cell">Наименование работ</th>
                                    <th class="unit-cell">Ед. изм.</th>
                                    <th class="price-cell">Цена, руб.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${section.items.map(item => `
                                    <tr>
                                        <td class="id-cell">${item.id}</td>
                                        <td class="name-cell">${item.name}</td>
                                        <td class="unit-cell">${item.unit}</td>
                                        <td class="price-cell">${formatCurrency(item.price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `).join('')}
                
                <div class="footer">
                    <div style="margin-bottom: 10px;">
                        <strong>Контакты:</strong> Телефон: +7 (963) 598-48-46 | Telegram: @Electric_Group
                    </div>
                    <div>
                        Прайс-лист сформирован в приложении "ЭлектроСмета" от Electric_Group для Братьев<br>
                        Дата формирования: ${new Date().toLocaleString('ru-RU')}
                    </div>
                </div>
            </div>
            
            <script>
                // Функция для отправки запроса на создание PDF
                function savePriceAsPDF() {
                    window.opener.postMessage({
                        action: 'savePriceAsPDF'
                    }, '*');
                }
                
                // Автоматическая прокрутка к началу
                window.onload = function() {
                    window.scrollTo(0, 0);
                };
                
                // Закрытие после печати
                window.onafterprint = function() {
                    setTimeout(() => {
                        if (confirm('Закрыть окно печати?')) {
                            window.close();
                        }
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `;
    
    try {
        // Открываем окно печати
        const printWindow = window.open('', '_blank', 'width=1100,height=700,scrollbars=yes');
        if (!printWindow) {
            alert('Браузер заблокировал всплывающее окно. Разрешите всплывающие окна для этого сайта.');
            return;
        }
        
        printWindow.document.open();
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        console.log('Окно печати прайс-листа открыто');
        
    } catch (error) {
        console.error('Ошибка при открытии окна:', error);
        alert('Ошибка при открытии окна печати: ' + error.message);
    }
}

        // Функция для проверки загрузки библиотек
        function checkPDFLibraries() {
            if (typeof jspdf === 'undefined') {
                console.error('jsPDF не загружен!');
                alert('Библиотека jsPDF не загружена. Пожалуйста, обновите страницу.');
                return false;
            }
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas не загружен!');
                alert('Библиотека html2canvas не загружена. Пожалуйста, обновите страницу.');
                return false;
            }
            return true;
        }

// Функция сохранения сметы в PDF (использует тот же формат, что и печать)
function saveAsPDF() {
    // Проверяем загрузку библиотек
    if (!checkPDFLibraries()) {
        return;
    }
    
    // Показываем модальное окно для ввода данных
    showPrintModal();
    
    // Изменяем кнопку в модальном окне
    const generateBtn = document.getElementById('generatePrint');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Сохранить PDF';
        generateBtn.onclick = function() {
            generatePDFFromModal();
        };
    }
}

// ИСПРАВЛЕННАЯ функция для генерации PDF из модального окна
async function generatePDFFromModal() {
    const executorName = document.getElementById('executorName').value || 'ЭлектроСмета';
    const executorInn = document.getElementById('executorInn').value || '';
    const executorPhone = document.getElementById('executorPhone').value || '+7 (963) 598-48-46';
    const clientName = document.getElementById('clientName').value || 'Клиент не указан';
    const clientContacts = document.getElementById('clientContacts').value || '';
    const projectName = document.getElementById('projectName').value || '';
    const estimateNumber = document.getElementById('estimateNumber').value;
    const estimateDate = document.getElementById('estimateDate').value;
    const notes = document.getElementById('notes').value;
    
    const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '');
    
    if (filledRows.length === 0) {
        alert('Смета пуста! Добавьте позиции перед сохранением.');
        return;
    }
    
    // Закрываем модальное окно
    document.getElementById('printModal').style.display = 'none';
    
    // Показываем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 9999;
        font-size: 16px;
    `;
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание PDF...';
    document.body.appendChild(loadingDiv);
    
    // Получаем глобальные настройки
    const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
    const globalCoeff = parseFloat(document.getElementById('globalCoefficient').value) || 1.0;
    const globalComment = document.getElementById('globalComment').value;
    
    // Рассчитываем итоги
    const baseTotal = filledRows.reduce((sum, row) => sum + row.total, 0);
    let finalTotal = baseTotal;
    
    if (globalCoeff !== 1.0) finalTotal = finalTotal * globalCoeff;
    if (globalDiscount > 0) finalTotal = finalTotal * (1 - globalDiscount / 100);
    
	const today = new Date().toLocaleDateString('ru-RU');
	const hijri = await getHijriDate();
    
    // Формируем HTML для PDF с отступами 10мм
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Смета ${estimateNumber}</title>
<style>
    /* ========== ОСНОВНЫЕ НАСТРОЙКИ ========== */
    @page {
        margin: 10mm;
    }
    
    body { 
        font-family: Arial, sans-serif; 
        padding: 0;
        margin: 0;
        background: white;
        font-size: 10px;
        line-height: 1.2;
    }
    
    /* ========== ОСНОВНОЙ БЛОК С ОТСТУПАМИ 10мм ========== */
    .print-container { 
        width: 190mm;
        margin: 0 auto;
        background: white;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* ========== ШАПКА ========== */
    .header { 
        margin-bottom: 8px;
        padding-bottom: 8px;
        width: 100%;
    }
    
    /* Контейнер Исполнитель/Заказчик */
    .header-contacts {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        padding: 5px 8px;
        background: #f8f9fa;
        border-radius: 3px;
        border-top: 2px solid #3498db;
        border-bottom: 2px solid #27ae60;
        font-size: 9px;
        line-height: 1.3;
        width: 100%;
        box-sizing: border-box;
    }
    
    .header-contacts .left,
    .header-contacts .right {
        text-align: left;
        flex: 1;
        color: #3498db; /* Голубой текст */
    }
    
    .header-contacts .right {
        text-align: right;
    }
    
    .header-contacts strong {
        color: #3498db; /* Голубой */
        font-size: 10px;
    }
    
    /* Блок под контактами */
    .sub-header {
        display: flex;
        align-items: center; /* Выравнивание по центру вертикали */
        margin-top: 4px;
        min-height: 70px; /* Под размер логотипа */
        width: 100%;
    }
    
    /* Логотип - слева */
    .logo-container {
        width: 80px;
        text-align: left;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }
    
    .logo-container img {
        max-height: 120px;
        max-width: 120px;
        object-fit: contain;
    }
    
    /* Номер сметы и дата - по центру */
    .title-block {
        flex: 1;
        text-align: center;
        padding: 0 10px;
		margin-left: -15mm; /* ← добавить эту строку */
    }
    
    .title-block h1 {
        color: #e74c3c;
        font-size: 16px;
        margin: 0 0 3px 0;
        font-weight: bold;
        line-height: 1.2;
    }
    
    .title-block .date {
        font-size: 10px;
        color: #666;
        line-height: 1.2;
    }
    
    /* ========== ТАБЛИЦА СМЕТЫ ========== */
    table { 
        width: 100%;
        border-collapse: collapse;
        margin: 6px 0;
        font-size: 9px;
        table-layout: fixed;
    }
    
    th, td { 
        border: 1px solid #333;
        padding: 2px 3px;
        text-align: left;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    th {
        background: #87CEFA;
        color: black;
        font-weight: bold;
        text-align: center;
        font-size: 9px;
        padding: 3px 2px;
    }
    
    /* Фиксированные ширины колонок */
    th:first-child, td:first-child {
        width: 30px;
        text-align: center;
        font-weight: bold;
        color: #3498db;
        font-size: 9px;
    }
    
    th:nth-child(2), td:nth-child(2) {
        width: auto;
        font-size: 9px;
        white-space: normal;
    }
    
    th:nth-child(3), td:nth-child(3) {
        width: 35px;
        text-align: center;
        font-size: 9px;
    }
    
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(6), td:nth-child(6) {
        width: 55px;
        text-align: right;
        font-size: 9px;
    }
    
    /* Примечания к позициям */
    .modifier-note { 
        color: #555;
        font-size: 7px;
        margin-left: 2px;
        font-style: italic;
    }
    
    /* ========== ИТОГОВЫЕ СУММЫ ========== */
    .totals-block {
        background: #f8f9fa;
        padding: 5px;
        border-radius: 3px;
        margin: 6px 0;
        border-left: 2px solid #3498db;
        width: 100%;
        box-sizing: border-box;
    }
    
    .total-row {
        text-align: right;
        font-size: 9px;
        margin-bottom: 2px;
        line-height: 1.2;
    }
    
    .total-row.final {
        font-size: 11px;
        font-weight: bold;
        color: #27ae60;
        margin-top: 4px;
        padding-top: 4px;
        border-top: 1px solid #000;
    }
    
    /* Глобальные настройки */
    .global-panel { 
        background: #f0f8ff;
        padding: 4px 6px;
        border-left: 2px solid #3498db;
        margin: 5px 0;
        font-size: 9px;
        line-height: 1.2;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Примечания */
    .notes-block {
        background: #f9f9f9;
        padding: 5px;
        border-left: 2px solid #f39c12;
        margin: 6px 0;
        font-size: 9px;
        line-height: 1.3;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Футер */
    .footer {
        margin-top: 10px;
        padding-top: 5px;
        border-top: 1px solid #ddd;
        font-size: 8px;
        color: #666;
        text-align: center;
        line-height: 1.2;
        width: 100%;
    }
</style>
        </head>
        <body>
            <div class="print-container">
                
                <!-- ШАПКА -->
                <div class="header">
                    
                    <!-- ИСПОЛНИТЕЛЬ и ЗАКАЗЧИК -->
                    <div class="header-contacts">
                        <div class="left">
                            <strong>ИСПОЛНИТЕЛЬ:</strong><br>
                            ${executorName}<br>
                            ${executorInn ? `ИНН: ${executorInn}<br>` : ''}
                            ${executorPhone ? `Тел.: ${executorPhone}` : ''}
                        </div>
                        <div class="right">
                            <strong>ЗАКАЗЧИК:</strong><br>
                            ${clientName}<br>
                            ${clientContacts ? `${clientContacts}<br>` : ''}
                            ${projectName ? `Объект: ${projectName}` : ''}
                        </div>
                    </div>
                    
                    <!-- Логотип слева, Смета по центру -->
                    <div class="sub-header">
                        ${logoDataUrl ? `
                        <div class="logo-container">
                            <img src="${logoDataUrl}" alt="Логотип">
                        </div>
                        ` : '<div class="logo-container"></div>'}
                        
                        <div class="title-block">
                            <h1>СМЕТА № ${estimateNumber}</h1>
<div class="date">
    ${new Date(estimateDate).toLocaleDateString('ru-RU')}
    ${hijri ? ` | ${hijri.day} ${hijri.month} ${hijri.year} г.х.` : ''}
</div>
                        </div>
                    </div>
                    
                </div>
                
                ${(globalDiscount > 0 || globalCoeff !== 1.0 || globalComment) ? `
                <div class="global-panel">
                    <strong>Настройки:</strong>
                    ${globalDiscount > 0 ? `Скидка ${globalDiscount}% ` : ''}
                    ${globalCoeff !== 1.0 ? `Коэф. ${globalCoeff} ` : ''}
                    ${globalComment ? `| ${globalComment}` : ''}
                </div>
                ` : ''}
                
                <!-- ТАБЛИЦА -->
                <table>
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Наименование</th>
                            <th>Ед.</th>
                            <th>Цена</th>
                            <th>Кол</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filledRows.map((row, index) => {
                            let fullName = row.name || '';
                            if (row.coefficient && row.coefficient !== 1.0) {
                                fullName += ` <span class="modifier-note">[×${row.coefficient}${row.coeffComment ? ':' + row.coeffComment : ''}]</span>`;
                            }
                            if (row.discount && row.discount > 0) {
                                fullName += ` <span class="modifier-note">[−${row.discount}%${row.discountComment ? ':' + row.discountComment : ''}]</span>`;
                            }
                            if (row.rowComment) {
                                fullName += ` <span class="modifier-note">—${row.rowComment}</span>`;
                            }
                            
                            return `
                            <tr>
                                <td>${row.priceId || (index + 1)}</td>
                                <td>${fullName}</td>
                                <td>${row.unit || ''}</td>
                                <td>${formatCurrency(row.price)}</td>
                                <td>${row.quantity}</td>
                                <td><strong style="color: #27ae60;">${formatCurrency(row.total)}</strong></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                
                <div class="totals-block">
                    <div class="total-row">
                        <span style="color: #666;">Базовая сумма:</span>
                        <strong>${formatCurrency(baseTotal)} руб.</strong>
                    </div>
                    ${globalCoeff !== 1.0 ? `
                    <div class="total-row">
                        <span style="color: #666;">С коэфф. ${globalCoeff}:</span>
                        <strong>${formatCurrency(baseTotal * globalCoeff)} руб.</strong>
                    </div>
                    ` : ''}
                    ${globalDiscount > 0 ? `
                    <div class="total-row">
                        <span style="color: #666;">Скидка ${globalDiscount}%:</span>
                        <strong>−${formatCurrency(baseTotal * globalCoeff * (globalDiscount / 100))} руб.</strong>
                    </div>
                    ` : ''}
                    <div class="total-row final">
                        ИТОГО: ${formatCurrency(finalTotal)} руб.
                    </div>
                </div>
                
                ${notes ? `
                <div class="notes-block">
                    <strong>Примечания:</strong><br>
                    ${notes.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                <div class="footer">
                    Смета составлена с использованием приложения "ЭлектроСмета" для профессионального расчета от Electric_Group для Братьев  | ${new Date().toLocaleString('ru-RU')}<br>
                    Сайт разработчика https://alivu.github.io/ | +7 (963) 598-48-46
                </div>
            </div>
        </body>
        </html>
    `;
    
    // Создаем временный контейнер с шириной 190mm (210mm - 10mm - 10mm)
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 190mm;
        min-height: 277mm;
        background: white;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
    `;
    tempContainer.innerHTML = printContent;
    document.body.appendChild(tempContainer);
    
    // Ждем загрузки
    setTimeout(() => {
        html2canvas(tempContainer, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            windowWidth: tempContainer.scrollWidth,
            windowHeight: tempContainer.scrollHeight
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png', 1.0);
            
            // Создаем PDF с полями 10мм
            const pdf = new jspdf.jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Размеры страницы A4 с учетом отступов 10мм
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2); // 190mm
            const contentHeight = pageHeight - (margin * 2); // 277mm
            
            const imgWidth = contentWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = margin; // Начинаем с отступа 10mm сверху
            
            // Добавляем первую страницу
            pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
            heightLeft -= contentHeight;
            
            // Если контент не помещается - добавляем страницы
            while (heightLeft > 0) {
                pdf.addPage();
                position = margin - (imgHeight - heightLeft); // Корректируем позицию
                pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= contentHeight;
            }
            
            document.body.removeChild(tempContainer);
            document.body.removeChild(loadingDiv);
            
            const fileName = `Смета_${estimateNumber}_${clientName.replace(/[^a-zA-Z0-9а-яА-Я]/g, '_')}.pdf`;
            pdf.save(fileName);
            
            showNotification('✅ PDF сохранен с отступами 10мм!');
            
        }).catch(error => {
            console.error('Ошибка:', error);
            document.body.removeChild(tempContainer);
            document.body.removeChild(loadingDiv);
            showNotification('❌ Ошибка: ' + error.message);
        });
    }, 500);
}
// ========== ФУНКЦИЯ ДЛЯ ИКОНКИ ==========
function handleIconError() {
    console.log('Иконка не загрузилась, показываем иконку по умолчанию');
    const appIcon = document.getElementById('appLogoIcon');
    const fallbackIcon = document.getElementById('fallbackIcon');
    
    if (appIcon && fallbackIcon) {
        appIcon.style.display = 'none';
        fallbackIcon.style.display = 'inline-block';
    }
}

// Проверяем загрузку иконки при старте
document.addEventListener('DOMContentLoaded', function() {
    const appIcon = document.getElementById('appLogoIcon');
    if (appIcon) {
        appIcon.onerror = handleIconError;
    }
});
        
// PWA Service Worker регистрация
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Используем относительный путь
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('✅ Service Worker зарегистрирован');
                })
                .catch(function(error) {
                    console.log('❌ Ошибка Service Worker:', error);
                    // Не показываем ошибку пользователю
                });
        });
    }
}

// Создаем кнопку установки PWA
let deferredPrompt;
const installButton = document.createElement('button');

function createInstallButton() {
    installButton.innerHTML = '<i class="fas fa-download"></i> Установить приложение';
    installButton.style.cssText = `
        position: fixed;
        bottom: 50px;
        right: 60px;
        background: linear-gradient(90deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 30px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        cursor: pointer;
        z-index: 10000;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    `;
    
    installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            showNotification('Приложение установлено!');
        }
        
        deferredPrompt = null;
        installButton.style.display = 'none';
    });
    
    document.body.appendChild(installButton);
}

// Отслеживаем установку PWA
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'flex';
    
    setTimeout(() => {
        installButton.style.display = 'none';
    }, 10000);
});

// Проверяем режим PWA
function checkDisplayMode() {
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('📱 Запущено как PWA');
        document.body.classList.add('pwa-mode');
    }
}

// Инициализация PWA
function initializePWA() {
    registerServiceWorker();
    createInstallButton();
    checkDisplayMode();
    
    if (window.navigator.standalone) {
        showNotification('Добро пожаловать в ЭлектроСмета! ⚡');
    }
}

// Запускаем PWA при загрузке
document.addEventListener('DOMContentLoaded', function() {
    // Ваш существующий код инициализации остается здесь
    
    // Добавляем эту строку в существующий DOMContentLoaded:
    initializePWA();
});

        // ========== GOOGLE DRIVE СИНХРОНИЗАЦИЯ ==========
const GOOGLE_CLIENT_ID = '1005885507362-vsplr1th18mhk2uj6prb2akump2c20tb.apps.googleusercontent.com';
const GOOGLE_CLIENT_SECRET = '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';
let googleToken = '';

// Шаг 1: Генерация PKCE (вставьте перед googleLogin)
function generateRandomString(length) {
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let text = '';
    for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}

async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
}

function generatePKCE() {
    const codeVerifier = generateRandomString(128);
    localStorage.setItem('pkce_code_verifier', codeVerifier);
    return generateCodeChallenge(codeVerifier);
}

// Шаг 1: Новая функция входа (заменяет старую googleLogin)
// ========== НОВАЯ ФУНКЦИЯ ВХОДА ==========
async function googleLogin() {
    const clientId = '1005885507362-vsplr1th18mhk2uj6prb2akump2c20tb.apps.googleusercontent.com';
    
    const redirectUri = encodeURIComponent('https://electro-smeta.vercel.app/oauth-callback.html');
    
    const scope = encodeURIComponent([
        'https://www.googleapis.com/auth/userinfo.email',
        'https://www.googleapis.com/auth/userinfo.profile',
        'https://www.googleapis.com/auth/drive.file'
    ].join(' '));
    
    // Генерируем state для защиты
    const state = Math.random().toString(36).substring(7);
    localStorage.setItem('oauth_state', state);
    
    const url = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${clientId}` +
        `&redirect_uri=${redirectUri}` +
        `&response_type=code` +
        `&scope=${scope}` +
        `&access_type=offline` +
        `&prompt=consent` +
        `&state=${state}`;
    
    window.open(url, 'authWindow', 'width=600,height=700,left=200,top=100');
}

// ========== НОВЫЙ ОБРАБОТЧИК СООБЩЕНИЙ ==========
window.addEventListener('message', async function(event) {
    // Проверяем, что сообщение от нашего домена
    if (event.origin !== 'https://electro-smeta.vercel.app') return;
    
    if (event.data.type === 'auth_code') {
        const code = event.data.code;
        
        // Проверяем state
        const savedState = localStorage.getItem('oauth_state');
        if (event.data.state !== savedState) {
            showNotification('❌ Ошибка безопасности');
            return;
        }
        localStorage.removeItem('oauth_state');
        
        try {
            showNotification('⏳ Получение токенов...');
            
            // Отправляем код на наш сервер (БЕЗ CLIENT SECRET!)
            const response = await fetch('https://electro-smeta.vercel.app/api/auth.js', {  // Добавлено .js
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.details || error.error);
            }
            
            const tokens = await response.json();
            
// Сохраняем токены
if (tokens.refresh_token) {
    localStorage.setItem('google_refresh_token', tokens.refresh_token);
}
// ✅ ТОЖЕ В LOCALSTORAGE!
localStorage.setItem('google_access_token', tokens.access_token);
localStorage.setItem('google_token_expiry', Date.now() + tokens.expires_in * 1000);
            
// Получаем информацию о пользователе
const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
    headers: { 'Authorization': `Bearer ${tokens.access_token}` }
});
const userData = await userInfo.json();

// ✅ СОХРАНЯЕМ ВЕСЬ ОБЪЕКТ ПОЛЬЗОВАТЕЛЯ!
localStorage.setItem('google_user', JSON.stringify(userData));
console.log('💾 Сохранён пользователь:', {
    email: userData.email,
    name: userData.name,
    picture: userData.picture
});

// ✅ ВЫЗЫВАЕМ НОВУЮ ФУНКЦИЮ
if (typeof updateAllButtons === 'function') {
    updateAllButtons();
} else {
    // Если функция еще не определена, пробуем позже
    setTimeout(() => {
        if (typeof updateAllButtons === 'function') {
            updateAllButtons();
        }
    }, 200);
}

showNotification(`✅ Вход выполнен: ${userData.email}`);

} catch (error) {
    console.error('❌ Ошибка:', error);
    showNotification('❌ Ошибка авторизации: ' + error.message);
}

// Шаг 3: Слушатель сообщений от окна callback


// ========== ФУНКЦИЯ ОБМЕНА КОДА НА ТОКЕНЫ ==========
async function exchangeCodeForTokens(code, state) {
    console.log('🔄 exchangeCodeForTokens вызвана', { code, state });
    
    let codeVerifier = localStorage.getItem('pkce_code_verifier');
    
    if (!codeVerifier) {
        codeVerifier = sessionStorage.getItem('pkce_code_verifier');
        if (codeVerifier) {
            localStorage.setItem('pkce_code_verifier', codeVerifier);
        }
    }
    
    if (!codeVerifier) {
        console.log('⚠️ codeVerifier не найден, создаем новый');
        codeVerifier = generateRandomString(128);
        localStorage.setItem('pkce_code_verifier', codeVerifier);
        sessionStorage.setItem('pkce_code_verifier', codeVerifier);
    }
    
    try {
        showNotification('⏳ Получение токенов...');
        
        const response = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                code: code,
                client_id: '1005885507362-vsplr1th18mhk2uj6prb2akump2c20tb.apps.googleusercontent.com',
                client_secret: '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',
                redirect_uri: 'https://electro-smeta.vercel.app/oauth-callback.html',
                grant_type: 'authorization_code',
                code_verifier: codeVerifier
            })
        });
        
        const tokens = await response.json();
        
        if (tokens.error) {
            throw new Error(tokens.error_description || tokens.error);
        }
        
        console.log('✅ Токены получены:', tokens);
        
        // Сохраняем refresh token
        if (tokens.refresh_token) {
            localStorage.setItem('google_refresh_token', tokens.refresh_token);
        }
        
        // Access token храним временно
        sessionStorage.setItem('google_access_token', tokens.access_token);
        sessionStorage.setItem('google_token_expiry', Date.now() + tokens.expires_in * 1000);
        
        localStorage.removeItem('pkce_code_verifier');
        
        // ✅ АВТОМАТИЧЕСКИ СОХРАНЯЕМ ПОЛЬЗОВАТЕЛЯ (работает для всех!)
        if (tokens.id_token) {
            try {
                const tokenParts = tokens.id_token.split('.');
                if (tokenParts.length > 1) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    console.log('📧 Данные пользователя:', payload);
                    
                    // Создаем объект с реальными данными (добавил picture)
                    const user = {
                        email: payload.email || "Пользователь",
                        name: payload.name || payload.given_name || payload.email?.split('@')[0] || "Пользователь",
                        picture: payload.picture || null
                    };
                    
                    // Сохраняем в localStorage
                    localStorage.setItem('google_user', JSON.stringify(user));
                    console.log('✅ Пользователь сохранен:', user);
                    
                    // ✅ ИЗМЕНЕНО: вызываем updateAllButtons вместо updateGoogleUI
                    if (typeof updateAllButtons === 'function') {
                        updateAllButtons();
                    } else {
                        setTimeout(() => {
                            if (typeof updateAllButtons === 'function') {
                                updateAllButtons();
                            }
                        }, 200);
                    }
                }
            } catch (e) {
                console.log('⚠️ Ошибка декодирования id_token:', e);
            }
        } else {
            // Если это запрос на Drive, просто обновляем интерфейс с существующим пользователем
            const existingUser = localStorage.getItem('google_user');
            if (existingUser) {
                // ✅ ИЗМЕНЕНО: вызываем updateAllButtons вместо updateGoogleUI
                if (typeof updateAllButtons === 'function') {
                    updateAllButtons();
                } else {
                    setTimeout(() => {
                        if (typeof updateAllButtons === 'function') {
                            updateAllButtons();
                        }
                    }, 200);
                }
            }
        }
        
        showNotification(`✅ Вход выполнен!`);
        
    } catch (error) {
        console.error('❌ Ошибка:', error);
        showNotification('❌ Ошибка авторизации: ' + error.message);
    }
}
// Шаг 3: Функция получения валидного access token
async function getValidAccessToken() {
    const accessToken = sessionStorage.getItem('google_access_token');
    const expiry = sessionStorage.getItem('google_token_expiry');
    const refreshToken = localStorage.getItem('google_refresh_token');

    // Если есть живой access token - используем его
    if (accessToken && expiry && Date.now() < parseInt(expiry)) {
        return accessToken;
    }

    // Если есть refresh token - обновляем через сервер
    if (refreshToken) {
        try {
            console.log('🔄 Обновляем токен через сервер...');
            
            const response = await fetch('https://electro-smeta.vercel.app/api/refresh.js', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('❌ Ошибка обновления:', errorData);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const tokens = await response.json();

            // Сохраняем новый access token
            sessionStorage.setItem('google_access_token', tokens.access_token);
            sessionStorage.setItem('google_token_expiry', Date.now() + tokens.expires_in * 1000);

            return tokens.access_token;

        } catch (error) {
            console.error('Ошибка при обновлении токена:', error);
            // Очищаем проблемные токены
            localStorage.removeItem('google_refresh_token');
            sessionStorage.removeItem('google_access_token');
            sessionStorage.removeItem('google_token_expiry');
            return null;
        }
    }

    return null;
}


		
// Функция сохранения локально
function saveEstimateLocally(estimate) {
    // Получаем существующие локальные сметы
    let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
    
    // Добавляем новую смету
    savedEstimates.push(estimate);
    
    // Сохраняем обратно в localStorage
    localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
}
// Шаг 7: Новая функция saveToDrive (адаптированная под PKCE)
async function saveToDrive() {
    // Получаем валидный access token
    let token = await getValidAccessToken();
    
    if (!token) {
        // Если нет токена - предлагаем войти
        if (confirm('Для сохранения в Google Drive необходимо войти. Перейти к авторизации?')) {
            googleLogin();
        }
        return;
    }
    
    // Запрашиваем название файла
    const estimateName = prompt('Название файла:', `Смета_${new Date().toLocaleDateString('ru-RU')}`);
    if (!estimateName) return;
    
    // Получаем текущие данные сметы
    const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '' || row.isMaterial);
    
    const currentEstimate = {
        id: Date.now(),
        name: estimateName,
        date: new Date().toISOString(),
        data: filledRows.map(row => ({
            id: row.id,
            priceId: row.priceId,
            name: row.name,
            unit: row.unit,
            price: row.price,
            originalPrice: row.originalPrice || row.price,
            quantity: row.quantity,
            total: row.total,
            isMaterial: row.isMaterial || false,
            coefficient: row.coefficient || 1.0,
            coeffComment: row.coeffComment || '',
            discount: row.discount || 0,
            discountComment: row.discountComment || '',
            rowComment: row.rowComment || ''
        })),
        totals: {
            totalAmount: parseFloat(document.getElementById('totalAmount').textContent.replace(/\s/g, ''))
        },
        globalSettings: {
            discount: parseFloat(document.getElementById('globalDiscount').value) || 0,
            coefficient: parseFloat(document.getElementById('globalCoefficient').value) || 1.0,
            comment: document.getElementById('globalComment').value || ''
        },
        zoom: zoomFactor
    };
    
    console.log('Сохранение в Drive:', currentEstimate);
    
    try {
        // ПРОВЕРКА: есть ли права на Drive?
        // Делаем тестовый запрос к Drive API
        const testResponse = await fetch('https://www.googleapis.com/drive/v3/files?pageSize=1', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Если нет прав - запрашиваем их
        if (testResponse.status === 401 || testResponse.status === 403) {
            showNotification('⚠️ Требуется доступ к Google Drive');
            
            const granted = await requestDriveScope();
            if (!granted) {
                showNotification('❌ Нет доступа к Google Drive');
                return;
            }
            
            // Получаем новый токен с правами
            token = await getValidAccessToken();
            if (!token) {
                showNotification('❌ Ошибка получения токена');
                return;
            }
        }
        
        // 1. Создаем файл в Google Drive
        const fileResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: `${estimateName}.json`,
                mimeType: 'application/json'
            })
        });
        
        if (!fileResponse.ok) {
            const error = await fileResponse.json();
            throw new Error(error.error?.message || 'Ошибка создания файла');
        }
        
        const file = await fileResponse.json();
        
        // 2. Загружаем содержимое
        const uploadResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${file.id}?uploadType=media`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentEstimate)
        });
        
        if (!uploadResponse.ok) {
            throw new Error('Ошибка загрузки содержимого');
        }
        
        // 3. Сохраняем ЛОКАЛЬНО (всегда)
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        savedEstimates.push(currentEstimate);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        showNotification('✅ Смета сохранена в Google Drive и локально!');
        
    } catch (error) {
        console.error('Ошибка Google Drive:', error);
        
        // В любом случае сохраняем локально
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        savedEstimates.push(currentEstimate);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        // Показываем понятное сообщение
        if (error.message.includes('401') || error.message.includes('403')) {
            showNotification('⚠️ Нет прав доступа к Drive. Смета сохранена локально.');
        } else {
            showNotification(`⚠️ Ошибка Drive: ${error.message}. Смета сохранена локально.`);
        }
    }
}

// ========== ФУНКЦИЯ ЗАПРОСА ПРАВ НА DRIVE ==========
async function requestDriveScope() {
    console.log('🔄 Запрашиваем права на Drive...');
    
    return new Promise(async (resolve) => {
        const clientId = GOOGLE_CLIENT_ID;
        const redirectUri = encodeURIComponent('https://electro-smeta.vercel.app/oauth-callback.html');
        
        // Генерируем codeVerifier
        const codeVerifier = generateRandomString(128);
        localStorage.setItem('pkce_code_verifier', codeVerifier);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        
        const scope = encodeURIComponent('https://www.googleapis.com/auth/drive.file');
        
        // Пытаемся открыть окно
        const authWindow = window.open('', '_blank', 'width=600,height=700,left=200,top=100');
        
        // ВАЖНО: Проверяем, удалось ли открыть окно (не заблокировано ли всплывающее окно)
        if (!authWindow) {
            console.error('❌ Не удалось открыть окно авторизации. Возможно, оно заблокировано браузером.');
            showNotification('❌ Разрешите всплывающие окна для этого сайта, чтобы авторизоваться в Drive.');
            resolve(false);
            return;
        }
        
        const url = `https://accounts.google.com/o/oauth2/v2/auth?` +
            `client_id=${clientId}` +
            `&redirect_uri=${redirectUri}` +
            `&response_type=code` +
            `&scope=${scope}` +
            `&code_challenge=${codeChallenge}` +
            `&code_challenge_method=S256` +
            `&access_type=offline` +
            `&prompt=consent` +
            `&state=drive_scope`;
        
        // Устанавливаем URL для окна
        authWindow.location.href = url;
        
        // Слушаем ответ
        function messageHandler(event) {
            if (event.origin !== 'https://electro-smeta.vercel.app') return;
            
            if (event.data.type === 'auth_code' && event.data.state === 'drive_scope') {
                window.removeEventListener('message', messageHandler);
                
                // Проверяем и закрываем окно, если оно еще открыто
                if (authWindow && !authWindow.closed) {
                    authWindow.close();
                }
                
                const savedCodeVerifier = localStorage.getItem('pkce_code_verifier');
                
                fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        code: event.data.code,
                        client_id: clientId,
                        client_secret: GOOGLE_CLIENT_SECRET,
                        redirect_uri: 'https://electro-smeta.vercel.app/oauth-callback.html',
                        grant_type: 'authorization_code',
                        code_verifier: savedCodeVerifier
                    })
                })
                .then(r => r.json())
                .then(tokens => {
                    if (tokens.refresh_token) {
                        localStorage.setItem('google_refresh_token', tokens.refresh_token);
                    }
                    if (tokens.access_token) {
                        sessionStorage.setItem('google_access_token', tokens.access_token);
                        sessionStorage.setItem('google_token_expiry', Date.now() + tokens.expires_in * 1000);
                        console.log('✅ Права на Drive получены');
                        showNotification('✅ Доступ к Drive получен!');
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch(error => {
                    console.error('❌ Ошибка получения токена Drive:', error);
                    resolve(false);
                });
            }
        }
        
        window.addEventListener('message', messageHandler);
        
        // Таймаут на случай, если пользователь не завершил авторизацию
        setTimeout(() => {
            window.removeEventListener('message', messageHandler);
            if (authWindow && !authWindow.closed) {
                authWindow.close();
            }
            console.log('⏱️ Время ожидания авторизации истекло');
            resolve(false);
        }, 120000); // 2 минуты
    });
}
		
// Последний шаг: Новая функция loadFromDrive (адаптированная под PKCE)
async function loadFromDrive() {
    // Получаем валидный access token
    let token = await getValidAccessToken();
    
    if (!token) {
        if (confirm('Для загрузки из Google Drive необходимо войти. Перейти к авторизации?')) {
            googleLogin();
        }
        return;
    }
    
    try {
        // ПРОВЕРКА: есть ли права на Drive?
        const testResponse = await fetch('https://www.googleapis.com/drive/v3/files?pageSize=1', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Если нет прав - запрашиваем их
        if (testResponse.status === 401 || testResponse.status === 403) {
            showNotification('⚠️ Требуется доступ к Google Drive');
            
            const granted = await requestDriveScope();
            if (!granted) {
                showNotification('❌ Нет доступа к Google Drive');
                return;
            }
            
            // Получаем новый токен с правами
            token = await getValidAccessToken();
            if (!token) {
                showNotification('❌ Ошибка получения токена');
                return;
            }
        }
        
        // ✅ ВЫЗЫВАЕМ ВАШЕ ПРЕКРАСНОЕ МОДАЛЬНОЕ ОКНО
        await showGoogleDriveLoadModal();
        
    } catch (error) {
        console.error('Ошибка загрузки из Drive:', error);
        
        if (error.message.includes('401') || error.message.includes('403')) {
            showNotification('⚠️ Проблема с доступом. Попробуйте войти заново.');
            localStorage.removeItem('google_refresh_token');
            sessionStorage.removeItem('google_access_token');
        } else {
            showNotification(`❌ Ошибка загрузки: ${error.message}`);
        }
    }
}

// Вспомогательная функция для загрузки одного файла
async function loadSingleFile(fileId, token) {
    try {
        showNotification('⏳ Загрузка файла...');
        
        // Загружаем файл
        const fileResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!fileResponse.ok) {
            throw new Error(`Ошибка загрузки файла: ${fileResponse.status}`);
        }
        
        const data = await fileResponse.json();
        
        // Загружаем данные в смету
        if (data && data.data) {
            // Определяем максимальное количество строк
            const maxRows = Math.max(data.data.length, 30);
            
            // Очищаем текущую смету с нужным количеством строк
            estimateData = Array(maxRows).fill().map((_, i) => ({
                id: i + 1,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false,
                coefficient: 1.0,
                coeffComment: "",
                discount: 0,
                discountComment: "",
                rowComment: "",
                originalPrice: 0
            }));
            
            // Заполняем данными
            data.data.forEach((row, i) => {
                if (i < maxRows) {
                    estimateData[i] = {
                        id: i + 1,
                        priceId: row.priceId || "",
                        name: row.name || "",
                        unit: row.unit || "",
                        price: row.price || 0,
                        originalPrice: row.originalPrice || row.price || 0,
                        quantity: row.quantity || 1,
                        total: row.total || 0,
                        notes: row.notes || "",
                        isMaterial: row.isMaterial || false,
                        coefficient: row.coefficient || 1.0,
                        coeffComment: row.coeffComment || "",
                        discount: row.discount || 0,
                        discountComment: row.discountComment || "",
                        rowComment: row.rowComment || ""
                    };
                }
            });
            
            // Загружаем глобальные настройки
            if (data.globalSettings) {
                document.getElementById('globalDiscount').value = data.globalSettings.discount || 0;
                document.getElementById('globalCoefficient').value = data.globalSettings.coefficient || 1.0;
                document.getElementById('globalComment').value = data.globalSettings.comment || '';
            }
            
            // Загружаем масштаб
            if (data.zoom) {
                zoomFactor = data.zoom;
                if (zoomFactor < MIN_ZOOM) zoomFactor = MIN_ZOOM;
                if (zoomFactor > MAX_ZOOM) zoomFactor = MAX_ZOOM;
                applyZoom();
            }
            
            // Обновляем интерфейс
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            showTab('estimate');
            
            showNotification(`✅ Загружена смета: "${data.name || 'без названия'}" (${data.data.length} позиций)`);
        } else {
            showNotification('❌ Ошибка: неверный формат файла');
        }
    } catch (error) {
        console.error('Ошибка загрузки файла:', error);
        showNotification(`❌ Ошибка загрузки: ${error.message}`);
    }
}

// Обновленный обработчик событий для кнопок
document.addEventListener('DOMContentLoaded', async function() {
    // Проверяем авторизацию при загрузке
    await checkGoogleAuth();
    
    // Назначаем обработчики для кнопок Drive
    const saveBtn = document.getElementById('saveToDriveBtn');
    if (saveBtn) {
        saveBtn.onclick = saveToDrive;
        // По умолчанию скрываем, пока не проверим авторизацию
        saveBtn.style.display = 'none';
    }
    
    const loadBtn = document.getElementById('loadFromDriveBtn');
    if (loadBtn) {
        loadBtn.onclick = loadFromDrive;
        loadBtn.style.display = 'none';
    }
    
    // Кнопка для нового модального окна Drive (если есть)
    const googleDriveLoadBtn = document.getElementById('googleDriveLoadBtn');
    if (googleDriveLoadBtn) {
        googleDriveLoadBtn.onclick = loadFromDrive;
        googleDriveLoadBtn.style.display = 'none';
    }
});

// ========== УПРАВЛЕНИЕ КНОПКАМИ GOOGLE DRIVE ==========

// 2. Проверяем есть ли сохраненный токен (ИСПРАВЛЕНО)
async function checkSavedToken() {
    // ✅ Используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    
    const saveBtn = document.getElementById('saveToDriveBtn');
    const loadBtn = document.getElementById('loadFromDriveBtn');
    const googleDriveLoadBtn = document.getElementById('googleDriveLoadBtn');
    
    if (token) {
        console.log('✅ Токен есть, показываем кнопки Drive');
        if (saveBtn) saveBtn.style.display = 'flex';
        if (loadBtn) loadBtn.style.display = 'flex';
        if (googleDriveLoadBtn) googleDriveLoadBtn.style.display = 'flex';
        return token;
    } else {
        console.log('❌ Токена нет, скрываем кнопки Drive');
        if (saveBtn) saveBtn.style.display = 'none';
        if (loadBtn) loadBtn.style.display = 'none';
        if (googleDriveLoadBtn) googleDriveLoadBtn.style.display = 'none';
        return null;
    }
}

class Magnifier {
    constructor() {
        // Создаем кнопку
        this.toggleBtn = document.createElement('button');
        this.toggleBtn.className = 'magnifier-toggle';
        this.toggleBtn.id = 'magnifierToggle';
        this.toggleBtn.title = 'Включить увеличительную линзу';
        this.toggleBtn.innerHTML = '<i class="fas fa-search-plus"></i>';
        document.body.appendChild(this.toggleBtn);
        
        // Создаем линзу
        this.magnifier = document.createElement('div');
        this.magnifier.className = 'magnifier';
        this.magnifier.id = 'magnifier';
        this.magnifier.innerHTML = `
            <div class="magnifier-content" id="magnifierContent"></div>
            <div class="magnifier-wave"></div>
        `;
        document.body.appendChild(this.magnifier);
        
        // Создаем подсказку
        this.hint = document.createElement('div');
        this.hint.className = 'magnifier-hint';
        this.hint.id = 'magnifierHint';
        document.body.appendChild(this.hint);
        
        this.content = document.getElementById('magnifierContent');
        this.isActive = false;
        this.updateInterval = null;
        
        // Свойства для перетаскивания
        this.isDragging = false;
        this.dragOffsetX = 0;
        this.dragOffsetY = 0;
        
        // Свойства для перетаскивания кнопки
        this.isDraggingBtn = false;
        this.dragBtnOffsetX = 0;
        this.dragBtnOffsetY = 0;

        // Размеры линзы
        this.lensWidth = 250;
        this.lensHeight = 90;
        
        // Добавляем CSS стили
        this.addStyles();
        
        this.init();
    }
    
    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* ========== ЛИНЗА ========== */
            .magnifier {
                position: fixed;
                width: 5px;
                min-width: 250px;
                height: auto;
                min-height: 90px;
                border-radius: 15px;
                pointer-events: auto;
                z-index: 9999;
                display: none;
                border: 4px solid rgba(52, 152, 219, 0.9);
                box-shadow: 0 0 50px rgba(52, 152, 219, 0.7);
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                padding: 20px 25px;
                box-sizing: border-box;
                cursor: grab;
                user-select: none;
                transition: all 0.3s ease;
                right: 300px;
                bottom: 350px;
            }
            
            .magnifier.dragging {
                cursor: grabbing;
                box-shadow: 0 0 80px rgba(52, 152, 219, 0.9);
            }
            
            .magnifier-content {
                width: 100%;
                font-weight: 700;
                color: #2c3e50;
                font-size: 18px;
                line-height: 1.4;
                white-space: normal;
                word-break: break-word;
                text-align: left;
                padding: 0;
                margin: 0;
            }

            /* ========== ПОДСКАЗКА ========== */
            .magnifier-hint {
                position: fixed;
                bottom: 150px;
                right: 380px;
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 12px 16px;
                border-radius: 12px;
                font-size: 0.85rem;
                max-width: 220px;
                z-index: 9998;
                display: none;
                box-shadow: 0 6px 20px rgba(0,0,0,0.25);
                border-left: 4px solid #3498db;
                opacity: 0;
                transform: translateY(10px);
                transition: opacity 0.3s ease, transform 0.3s ease;
                pointer-events: none;
            }
            
            .magnifier-hint.show {
                opacity: 1;
                transform: translateY(0);
                display: block;
            }
            
            .magnifier-hint:after {
                content: '';
                position: absolute;
                bottom: -8px;
                right: 20px;
                border: 8px solid transparent;
                border-top-color: #2c3e50;
            }
            
            .magnifier-hint strong {
                color: #f1c40f;
                display: block;
                margin-bottom: 5px;
                font-size: 0.95rem;
            }
            
            .magnifier-hint i {
                color: #3498db;
                margin-right: 8px;
            }
            
            /* ========== КНОПКА ЛУПЫ ========== */
            .magnifier-toggle {
                position: fixed;
                bottom: 70px;
                right: 380px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3498db, #2c3e50);
                color: white;
                border: none;
                cursor: pointer;
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.8rem;
                transition: all 0.3s ease;
                border: 3px solid rgba(255,255,255,0.3);
            }
            
            .magnifier-toggle:hover {
                transform: scale(1.1);
            }
            
            .magnifier-toggle.active {
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
                70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
                100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
            }
            
            /* Мобильные версии */
            @media (max-width: 767px) {
                .magnifier {
                    width: 90%;
                    min-height: 80px;
                    padding: 15px 20px;
                    border-radius: 12px;
                    right: 5%;
                    bottom: 5px;
                    left: 5% !important;
                    transform: none !important;
                    margin: 0 auto;
                }
                
                .magnifier-toggle {
                    bottom: 80px;
                    right: 310px;
                    width: 35px;
                    height: 35px;
                    font-size: 1.4rem;
                }
                
                .magnifier-content {
                    font-size: 34px !important;
                    line-height: 1.3 !important;
                }
                
                .magnifier-hint {
                    bottom: 120px;
                    right: 200px;
                    max-width: 180px;
                    font-size: 0.75rem;
                    padding: 10px 14px;
                }
            }

            @media (max-width: 480px) {
                .magnifier {
                    width: 92%;
                    min-height: 70px;
                    padding: 12px 15px;
                    bottom: 110px;
                }
                
                .magnifier-content {
                    font-size: 30px !important;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    init() {
        // Настраиваем перетаскивание
        this.setupDragging();
        this.setupButtonDragging();
        
        // Кнопка включения/выключения
// Кнопка включения/выключения - для мобильных и десктопа
this.toggleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    this.toggle();
});

// Для мобильных - дополнительно на touch
this.toggleBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    e.stopPropagation();
    this.toggle();
}, { passive: false });
        
        // Показываем подсказку
        this.toggleBtn.addEventListener('mouseenter', () => this.showHint());
        this.toggleBtn.addEventListener('mouseleave', () => this.hideHint());
        
        // Отслеживаем скролл
        window.addEventListener('scroll', () => this.updateTextUnderSearchBar());
        
        const priceContainer = document.querySelector('.price-list-container');
        if (priceContainer) {
            priceContainer.addEventListener('scroll', () => this.updateTextUnderSearchBar());
        }
        
        console.log('✅ Линза и кнопка созданы через JavaScript');
        
        // Автоматически показываем подсказку
        setTimeout(() => {
            this.showHint();
            setTimeout(() => this.hideHint(), 500);
        }, 500);
    }
    
    setupDragging() {
        const lens = this.magnifier;
        
        lens.addEventListener('mousedown', (e) => {
            if (!this.isActive) return;
            
            this.isDragging = true;
            lens.classList.add('dragging');
            
            const rect = lens.getBoundingClientRect();
            this.dragOffsetX = e.clientX - rect.left;
            this.dragOffsetY = e.clientY - rect.top;
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isActive || !this.isDragging) return;
            
            const x = e.clientX - this.dragOffsetX;
            const y = e.clientY - this.dragOffsetY;
            
            const maxX = window.innerWidth - this.lensWidth;
            const maxY = window.innerHeight - this.lensHeight;
            
            lens.style.left = Math.max(10, Math.min(x, maxX - 10)) + 'px';
            lens.style.top = Math.max(10, Math.min(y, maxY - 10)) + 'px';
            lens.style.right = 'auto';
            lens.style.bottom = 'auto';
            lens.style.transform = 'none';
        });
        
        document.addEventListener('mouseup', () => {
            if (this.isDragging) {
                this.isDragging = false;
                lens.classList.remove('dragging');
            }
        });
        
        // Touch события
        lens.addEventListener('touchstart', (e) => {
            if (!this.isActive || !e.touches[0]) return;
            
            this.isDragging = true;
            lens.classList.add('dragging');
            
            const touch = e.touches[0];
            const rect = lens.getBoundingClientRect();
            this.dragOffsetX = touch.clientX - rect.left;
            this.dragOffsetY = touch.clientY - rect.top;
            
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!this.isActive || !this.isDragging || !e.touches[0]) return;
            
            const touch = e.touches[0];
            const x = touch.clientX - this.dragOffsetX;
            const y = touch.clientY - this.dragOffsetY;
            
            const maxX = window.innerWidth - this.lensWidth;
            const maxY = window.innerHeight - this.lensHeight;
            
            lens.style.left = Math.max(10, Math.min(x, maxX - 10)) + 'px';
            lens.style.top = Math.max(10, Math.min(y, maxY - 10)) + 'px';
            lens.style.right = 'auto';
            lens.style.bottom = 'auto';
            lens.style.transform = 'none';
            
            e.preventDefault();
        });
        
        document.addEventListener('touchend', () => {
            if (this.isDragging) {
                this.isDragging = false;
                lens.classList.remove('dragging');
            }
        });
    }
    
    setupButtonDragging() {
        const btn = this.toggleBtn;
        
        btn.addEventListener('mousedown', (e) => {
            if (this.isActive) return;
            
            this.isDraggingBtn = true;
            const rect = btn.getBoundingClientRect();
            this.dragBtnOffsetX = e.clientX - rect.left;
            this.dragBtnOffsetY = e.clientY - rect.top;
            btn.style.cursor = 'grabbing';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isDraggingBtn) return;
            
            const x = e.clientX - this.dragBtnOffsetX;
            const y = e.clientY - this.dragBtnOffsetY;
            
            const maxX = window.innerWidth - btn.offsetWidth;
            const maxY = window.innerHeight - btn.offsetHeight;
            
            btn.style.position = 'fixed';
            btn.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
            btn.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
            btn.style.right = 'auto';
            btn.style.bottom = 'auto';
        });
        
        document.addEventListener('mouseup', () => {
            if (this.isDraggingBtn) {
                this.isDraggingBtn = false;
                this.toggleBtn.style.cursor = '';
            }
        });
        
        btn.addEventListener('touchstart', (e) => {
            if (this.isActive || !e.touches[0]) return;
            
            this.isDraggingBtn = true;
            const touch = e.touches[0];
            const rect = btn.getBoundingClientRect();
            this.dragBtnOffsetX = touch.clientX - rect.left;
            this.dragBtnOffsetY = touch.clientY - rect.top;
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!this.isDraggingBtn || !e.touches[0]) return;
            
            const touch = e.touches[0];
            const x = touch.clientX - this.dragBtnOffsetX;
            const y = touch.clientY - this.dragBtnOffsetY;
            
            const maxX = window.innerWidth - btn.offsetWidth;
            const maxY = window.innerHeight - btn.offsetHeight;
            
            btn.style.position = 'fixed';
            btn.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
            btn.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
            btn.style.right = 'auto';
            btn.style.bottom = 'auto';
            
            e.preventDefault();
        });
        
        document.addEventListener('touchend', () => {
            if (this.isDraggingBtn) {
                this.isDraggingBtn = false;
            }
        });
    }
    
    updateTextUnderSearchBar() {
        if (!this.isActive) return;
        
        try {
            const searchBar = document.querySelector('.search-box');
            if (!searchBar) return;
            
            const searchBarRect = searchBar.getBoundingClientRect();
            const lineY = searchBarRect.bottom + 5;
            
            const priceItems = document.querySelectorAll('.price-item');
            
            let targetItem = null;
            let minDistance = Infinity;
            
            priceItems.forEach(item => {
                const rect = item.getBoundingClientRect();
                const itemCenterY = rect.top + rect.height / 2;
                const distance = Math.abs(itemCenterY - lineY);
                
                if (distance < minDistance && rect.top >= searchBarRect.bottom - 50) {
                    minDistance = distance;
                    targetItem = item;
                }
            });
            
            if (targetItem) {
                const text = targetItem.textContent.trim();
                if (text) {
                    this.content.innerHTML = `
                        <div style="
                            font-size: ${window.innerWidth <= 767 ? '20px' : '22px'};
                            font-weight: 700;
                            color: #2c3e50;
                            line-height: 1.4;
                            word-break: break-word;
                            white-space: normal;
                            width: 100%;
                        ">
                            ${this.escapeHtml(text)}
                        </div>
                    `;
                    return;
                }
            }
            
            this.content.innerHTML = '';
            
        } catch (error) {
            console.log('Ошибка линзы:', error);
            this.content.innerHTML = '';
        }
    }
    
    showHint() {
        // Создаем подсказку если её нет
        if (!this.hint) {
            this.hint = document.createElement('div');
            this.hint.className = 'magnifier-hint';
            this.hint.id = 'magnifierHint';
            document.body.appendChild(this.hint);
        }
        
        this.hint.classList.add('show');
        
        if (this.isActive) {
            this.hint.innerHTML = `
                <strong><i class="fas fa-search-plus"></i> Линза активна</strong>
                Показывает текст под панелью поиска.<br>
                Перетащите в удобное место.
            `;
        } else {
            this.hint.innerHTML = `
                <strong><i class="fas fa-search-plus"></i> Увеличительная линза</strong>
                Нажмите для включения. Будет показывать текст под панелью поиска.
            `;
        }
    }
    
    hideHint() {
        if (this.hint) {
            this.hint.classList.remove('show');
        }
    }
    
    toggle() {
            // Для мобильных - убедимся что линза существует
    if (!this.magnifier) {
        console.error('Линза не найдена');
        return;
    }
        this.isActive = !this.isActive;
        this.magnifier.style.display = this.isActive ? 'block' : 'none';
        this.toggleBtn.classList.toggle('active', this.isActive);
        
        if (this.isActive) {
            this.magnifier.style.right = '20px';
            this.magnifier.style.bottom = '140px';
            this.magnifier.style.left = 'auto';
            this.magnifier.style.top = 'auto';
            this.magnifier.style.transform = 'none';
            
            setTimeout(() => this.updateTextUnderSearchBar(), 100);
            
            if (this.updateInterval) clearInterval(this.updateInterval);
            this.updateInterval = setInterval(() => {
                if (this.isActive && !this.isDragging) {
                    this.updateTextUnderSearchBar();
                }
            }, 500);
        } else {
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
                this.updateInterval = null;
            }
        }
        
        this.showHint();
        setTimeout(() => this.hideHint(), 2000);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// ========== ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ЛИНЗЫ ==========
function initMagnifier() {
    console.log('🔄 Инициализация линзы...');
    try {
        setTimeout(() => {
            const magnifier = new Magnifier();
            window.magnifierInstance = magnifier;
            
            // ПОКАЗЫВАЕМ КНОПКУ через 300мс после инициализации
            setTimeout(() => {
                const btn = document.getElementById('magnifierToggle');
                if (btn) {
                    btn.classList.add('ready');
                    console.log('✅ Кнопка лупы готова');
                }
            }, 300);
            
            console.log('✅ Линза готова к работе');            
        }, 500);
    } catch (error) {
        console.error('❌ Ошибка инициализации линзы:', error);
    }
}
// ========== ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ==========
document.addEventListener('DOMContentLoaded', async function() {  // ← добавили async
    await checkGoogleAuth();   // ← теперь работает
    await checkSavedToken();   // ← теперь работает
    
    // Скрываем кнопку сразу
    const toggleBtn = document.getElementById('magnifierToggle');
    if (toggleBtn) {
        toggleBtn.style.opacity = '0';
        toggleBtn.style.pointerEvents = 'none';
    }
    
    initMagnifier();
});
function debugEstimateData() {
    console.log('=== DEBUG estimateData ===');
    console.log('Всего строк в массиве:', estimateData.length);
    
    const filledRows = estimateData.filter(row => 
        row.priceId || row.name.trim() !== '' || row.isMaterial
    );
    console.log('Заполненных строк:', filledRows.length);
    
    // Показываем все заполненные строки
    console.log('=== ЗАПОЛНЕННЫЕ СТРОКИ ===');
    filledRows.forEach((row, index) => {
        console.log(`${index + 1}. ID: ${row.id}, Код: ${row.priceId}, Название: ${row.name.substring(0, 30)}...`);
    });
    
    // Проверяем DOM
    const tableRows = document.querySelectorAll('#estimateTable tr');
    console.log('Строк в DOM таблице:', tableRows.length);
    
    // Проверяем последнюю сохраненную смету
    const saved = JSON.parse(localStorage.getItem('electroEstimates'));
    if (saved && saved.length > 0) {
        const lastEstimate = saved[saved.length - 1];
        console.log('=== ПОСЛЕДНЯЯ СОХРАНЕННАЯ СМЕТА ===');
        console.log('Название:', lastEstimate.name);
        console.log('Сохранено строк:', lastEstimate.data.length);
        console.log('Первые 5 строк сохраненных данных:', lastEstimate.data.slice(0, 5));
        console.log('Последние 5 строк сохраненных данных:', lastEstimate.data.slice(-5));
    }
    
    // Отображаем в уведомлении для быстрой проверки
    const notificationText = `Данные: ${filledRows.length} заполненных из ${estimateData.length} | DOM: ${tableRows.length} строк`;
    showNotification(`Debug: ${notificationText}`);
}
// ========== ФУНКЦИЯ ОБНОВЛЕНИЯ СМЕТЫ ==========
function refreshEstimate() {
    if (!confirm('ВНИМАНИЕ!\n\nОбновление сметы удалит:\n• Все сохраненные сметы\n• Настройки приложения\n• Google авторизацию\n\nПродолжить?')) {
        return;
    }
    
    // Очищаем все хранилища
    localStorage.clear();
    sessionStorage.clear();
    
    // Сбрасываем переменные
    estimateData = [{
        id: 1,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false,
        coefficient: 1.0,
        coeffComment: "",
        discount: 0,
        discountComment: "",
        rowComment: "",
        originalPrice: 0
    }];
    
    savedEstimates = [];
    nextMaterialId = 1000;
    googleToken = '';
    
    // Сбрасываем глобальные настройки
    document.getElementById('globalDiscount').value = 0;
    document.getElementById('globalCoefficient').value = 1.0;
    document.getElementById('globalComment').value = '';
    
    // Сбрасываем масштаб
    zoomFactor = 1.0;
    applyZoom();
    saveZoomFactor();
    
    // Обновляем интерфейс
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    showTab('estimate');
    
    // Показываем уведомление
    showNotification('🔄 Смета обновлена! Приложение сброшено к начальному состоянию.');
    
    // Предлагаем перезагрузку
    setTimeout(() => {
        if (confirm('Для полного обновления рекомендуется перезагрузить страницу. Сделать это сейчас?')) {
            location.reload();
        }
    }, 1500);
}

        // ========== НОВЫЙ ФУНКЦИОНАЛ: ВИДЕО ПО НОМЕРУ ==========
        
        // Базовый URL для видео (ваш репозиторий)
        //const VIDEO_BASE_URL = 'https://i.imgur.com/';
// ========== НОВЫЙ ФУНКЦИОНАЛ: ВИДЕО ПО НОМЕРУ ==========

// Словарь ссылок на видео (номер: прямая ссылка)
const videoLinks = {
	 5: 'https://i.imgur.com/Hk09DFd.jpeg',
    28: 'https://i.imgur.com/k93Uc9a.mp4',
    43: 'https://i.imgur.com/0CSBqVf.mp4',
	107: 'https://i.imgur.com/s02jq0q.png',
    // Добавляйте новые видео так:
    // 10: 'https://i.imgur.com/ваш_код.mp4',
    // 25: 'https://i.imgur.com/другой_код.mp4',
};

// Объект для кэширования доступных видео
const videoCache = new Set();

/**
 * Проверяет существование видео по номеру
 */
async function checkVideoExists(number) {
    // Проверяем, есть ли ссылка в словаре
    if (videoLinks[number]) {
        videoCache.add(number);
        return true;
    }
    return false;
}

/**
 * Воспроизводит видео или показывает изображение по номеру.
 * Автоматически определяет тип файла по расширению и содержимому.
 */
async function playVideoByNumber(number) {
    // Показываем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'video-loading';
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
    document.body.appendChild(loadingDiv);
    
    try {
        // Получаем ссылку из словаря
        let mediaUrl = videoLinks[number];
        
        if (!mediaUrl) {
            document.body.removeChild(loadingDiv);
            showNotification(`❌ Материал для позиции №${number} не найден`);
            return;
        }
        
        // Определяем тип файла по расширению
        const fileExtension = mediaUrl.split('.').pop().toLowerCase().split('?')[0];
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'jfif', 'jpe', 'jif', 'jfif', 'jfi'];
        const isImage = imageExtensions.includes(fileExtension);
        
        // Создаем модальное окно для медиа
        const mediaModal = document.createElement('div');
        mediaModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        `;
        
        // Контейнер для контента
        const contentContainer = document.createElement('div');
        contentContainer.style.cssText = `
            max-width: 90%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        // Кнопка закрытия
        const closeButton = document.createElement('button');
        closeButton.innerHTML = '✕ Закрыть';
        closeButton.style.cssText = `
            margin-top: 20px;
            padding: 12px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        `;
        closeButton.onmouseover = () => {
            closeButton.style.transform = 'scale(1.05)';
            closeButton.style.boxShadow = '0 6px 20px rgba(231, 76, 60, 0.4)';
        };
        closeButton.onmouseout = () => {
            closeButton.style.transform = 'scale(1)';
            closeButton.style.boxShadow = '0 4px 15px rgba(231, 76, 60, 0.3)';
        };
        closeButton.onclick = () => document.body.removeChild(mediaModal);
        
        if (isImage) {
            // Для изображений
            console.log('Загружаем изображение:', mediaUrl);
            
            const img = document.createElement('img');
            img.style.cssText = `
                max-width: 100%;
                max-height: 100%;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                object-fit: contain;
            `;
            
            // Обработчик успешной загрузки
            img.onload = () => {
                document.body.removeChild(loadingDiv);
                console.log('✅ Изображение загружено');
            };
            
            // Обработчик ошибки загрузки
            img.onerror = () => {
                document.body.removeChild(loadingDiv);
                console.error('❌ Ошибка загрузки изображения');
                
                // Показываем сообщение об ошибке в модальном окне
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    color: white;
                    text-align: center;
                    padding: 20px;
                `;
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                    <p style="font-size: 18px;">Не удалось загрузить изображение</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">${mediaUrl}</p>
                `;
                contentContainer.appendChild(errorDiv);
            };
            
            img.src = mediaUrl;
            contentContainer.appendChild(img);
            
        } else {
            // Для видео
            console.log('Загружаем видео:', mediaUrl);
            
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            video.style.cssText = `
                max-width: 100%;
                max-height: 100%;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            // Обработчик успешной загрузки
            video.onloadeddata = () => {
                document.body.removeChild(loadingDiv);
                console.log('✅ Видео загружено');
            };
            
            // Обработчик ошибки загрузки
            video.onerror = () => {
                document.body.removeChild(loadingDiv);
                console.error('❌ Ошибка загрузки видео');
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    color: white;
                    text-align: center;
                    padding: 20px;
                `;
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                    <p style="font-size: 18px;">Не удалось загрузить видео</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">${mediaUrl}</p>
                `;
                contentContainer.appendChild(errorDiv);
            };
            
            // Определяем MIME тип
            const mimeType = fileExtension === 'mp4' ? 'video/mp4' : 'video/webm';
            
            const source = document.createElement('source');
            source.src = mediaUrl;
            source.type = mimeType;
            
            video.appendChild(source);
            video.innerHTML += 'Ваш браузер не поддерживает видео.';
            contentContainer.appendChild(video);
        }
        
        // Собираем модальное окно
        mediaModal.appendChild(contentContainer);
        mediaModal.appendChild(closeButton);
        
        // Добавляем возможность закрыть кликом на фон
        mediaModal.addEventListener('click', (e) => {
            if (e.target === mediaModal) {
                document.body.removeChild(mediaModal);
            }
        });
        
        document.body.appendChild(mediaModal);
        
        // Добавляем в кэш
        videoCache.add(number);
        
    } catch (error) {
        // Убираем индикатор загрузки в случае ошибки
        if (loadingDiv.parentNode) {
            document.body.removeChild(loadingDiv);
        }
        console.error('Ошибка при загрузке:', error);
        showNotification(`❌ Ошибка загрузки: ${error.message}`);
    }
}
/**
 * Предзагрузка информации о видео
 */
async function preloadVideoInfo() {
    console.log('Предзагрузка информации о видео...');
    
    // Получаем все номера из videoLinks
    const videoNumbers = Object.keys(videoLinks).map(Number);
    
    for (const number of videoNumbers) {
        await checkVideoExists(number);
    }
    
    console.log('Предзагрузка информации о видео завершена');
    console.log('Доступные видео:', Array.from(videoCache));
}

// Добавляем вызов preloadVideoInfo в initializeApp
const originalInitializeApp = initializeApp;
initializeApp = async function() {
    await originalInitializeApp();
    await preloadVideoInfo();
};
        
		
		
		
		
// ========== ИСПРАВЛЕННОЕ СКРЫТИЕ/ПОКАЗ ПАНЕЛИ ==========
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggleGlobalPanel');
    const globalPanel = document.querySelector('.global-modifiers-panel');
    
    // Важно: проверяем, что все элементы найдены
    if (toggleBtn && globalPanel) {
        // Проверяем сохраненное состояние
        const isHidden = localStorage.getItem('globalPanelHidden') === 'true';
        if (isHidden) {
            globalPanel.classList.add('hidden');
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i> <span id="togglePanelText">Показать панель</span>';
        }
        
        // Функция обработки клика
        function handlePanelToggle(e) {
            e.preventDefault();
            globalPanel.classList.toggle('hidden');
            
            // Меняем текст и иконку
            if (globalPanel.classList.contains('hidden')) {
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> <span id="togglePanelText">Показать панель</span>';
                localStorage.setItem('globalPanelHidden', 'true');
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> <span id="togglePanelText">Скрыть панель</span>';
                localStorage.setItem('globalPanelHidden', 'false');
            }
        }
        
        // Добавляем обработчики
        toggleBtn.addEventListener('click', handlePanelToggle);
        toggleBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            handlePanelToggle(e);
        }, { passive: false });
        
    } else {
        console.warn('Не удалось найти элементы для управления панелью.');
    }
});
		
		
	// ========== ФИКС ПОРЯДКА ЭЛЕМЕНТОВ ==========
document.addEventListener('DOMContentLoaded', function() {
    // Убедимся, что элементы расположены в правильном порядке
    const estimateTab = document.getElementById('estimate-tab');
    if (estimateTab) {
        const panel = estimateTab.querySelector('.global-modifiers-panel');
        const container = estimateTab.querySelector('.estimate-scale-container');
        const totals = estimateTab.querySelector('.estimate-totals');
        
        if (panel && container && totals) {
            // Проверяем порядок (panel должен быть ПЕРЕД container)
            const panelIndex = Array.from(estimateTab.children).indexOf(panel);
            const containerIndex = Array.from(estimateTab.children).indexOf(container);
            
            if (panelIndex > containerIndex) {
                // Если panel после container - перемещаем
                estimateTab.insertBefore(panel, container);
                console.log('✅ Порядок элементов исправлен');
            }
        }
    }
});	
	
// ========== СОХРАНЕНИЕ ДАННЫХ ИСПОЛНИТЕЛЯ ==========
function loadExecutorData() {
    // Загружаем из localStorage
    const savedData = localStorage.getItem('executorData');
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            document.getElementById('executorName').value = data.name || '';
            document.getElementById('executorInn').value = data.inn || '';
            document.getElementById('executorPhone').value = formatPhoneNumber(data.phone || '');
        } catch (e) {
            console.error('Ошибка загрузки данных исполнителя:', e);
        }
    }
    
    // Загружаем из Google Drive если есть токен
    if (googleToken || localStorage.getItem('google_token')) {
        loadExecutorFromDrive();
    }
}

function saveExecutorData() {
    const rawPhone = document.getElementById('executorPhone').value;
    const formattedPhone = formatPhoneNumber(rawPhone);
    
    const executorData = {
        name: document.getElementById('executorName').value,
        inn: document.getElementById('executorInn').value,
        phone: formattedPhone,
        lastUpdated: new Date().toISOString()
    };
    
    // Сохраняем локально
    localStorage.setItem('executorData', JSON.stringify(executorData));
    
    // Обновляем поле ввода, чтобы показать отформатированный номер
    document.getElementById('executorPhone').value = formattedPhone;
    
    // Сохраняем в Google Drive если есть токен
    if (googleToken || localStorage.getItem('google_token')) {
        saveExecutorToDrive(executorData);
    } else {
        showNotification('✅ Данные исполнителя сохранены локально');
    }
}

// Сохранить данные исполнителя в Google Drive (ИСПРАВЛЕНО)
async function saveExecutorToDrive(executorData) {
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        console.log('❌ Нет токена для сохранения данных исполнителя');
        showNotification('❌ Ошибка авторизации');
        return;
    }
    
    try {
        console.log('💾 Сохраняем данные исполнителя в Drive...');
        
        // Проверяем, есть ли уже файл
        const listResponse = await fetch('https://www.googleapis.com/drive/v3/files?q=name="executor_data.json"', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!listResponse.ok) {
            if (listResponse.status === 403) {
                showNotification('⚠️ Нет прав доступа к Drive');
                const granted = await requestDriveScope();
                if (granted) {
                    // Повторяем сохранение после получения прав
                    return saveExecutorToDrive(executorData);
                }
            }
            throw new Error(`Ошибка: ${listResponse.status}`);
        }
        
        const files = await listResponse.json();
        let fileId = null;
        
        if (files.files && files.files.length > 0) {
            fileId = files.files[0].id;
            console.log('📁 Обновляем существующий файл');
            
            // Обновляем существующий файл
            const updateResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(executorData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Ошибка обновления: ${updateResponse.status}`);
            }
        } else {
            console.log('📁 Создаем новый файл');
            
            // Создаем новый файл
            const fileResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: 'executor_data.json',
                    mimeType: 'application/json'
                })
            });
            
            if (!fileResponse.ok) {
                throw new Error(`Ошибка создания файла: ${fileResponse.status}`);
            }
            
            const file = await fileResponse.json();
            fileId = file.id;
            
            // Загружаем содержимое
            const uploadResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(executorData)
            });
            
            if (!uploadResponse.ok) {
                throw new Error(`Ошибка загрузки: ${uploadResponse.status}`);
            }
        }
        
        showNotification('✅ Данные исполнителя сохранены в Google Drive');
        console.log('✅ Данные исполнителя успешно сохранены');
        
    } catch (error) {
        console.error('❌ Ошибка сохранения в Drive:', error);
        showNotification('⚠️ Данные сохранены только локально');
    }
}

// Загрузить данные исполнителя из Google Drive (ИСПРАВЛЕНО)
async function loadExecutorFromDrive() {
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        console.log('❌ Нет токена для загрузки данных исполнителя');
        return;
    }
    
    try {
        console.log('📂 Загружаем данные исполнителя из Drive...');
        
        const listResponse = await fetch('https://www.googleapis.com/drive/v3/files?q=name="executor_data.json"', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!listResponse.ok) {
            if (listResponse.status === 403) {
                showNotification('⚠️ Нет прав доступа к Drive');
                const granted = await requestDriveScope();
                if (granted) {
                    // Повторяем загрузку после получения прав
                    return loadExecutorFromDrive();
                }
            }
            throw new Error(`Ошибка: ${listResponse.status}`);
        }
        
        const files = await listResponse.json();
        
        if (files.files && files.files.length > 0) {
            const fileId = files.files[0].id;
            console.log('📁 Найден файл с ID:', fileId);
            
            const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!fileResponse.ok) {
                throw new Error(`Ошибка загрузки файла: ${fileResponse.status}`);
            }
            
            const data = await fileResponse.json();
            console.log('📄 Данные загружены:', data);
            
            // Заполняем поля формы
            const executorName = document.getElementById('executorName');
            const executorInn = document.getElementById('executorInn');
            const executorPhone = document.getElementById('executorPhone');
            
            if (executorName) executorName.value = data.name || '';
            if (executorInn) executorInn.value = data.inn || '';
            if (executorPhone) executorPhone.value = formatPhoneNumber(data.phone || '');
            
            // Обновляем localStorage
            localStorage.setItem('executorData', JSON.stringify(data));
            
            console.log('✅ Данные исполнителя загружены из Drive');
            showNotification('✅ Данные исполнителя загружены');
        } else {
            console.log('ℹ️ Файл с данными исполнителя не найден');
        }
    } catch (error) {
        console.error('❌ Ошибка загрузки из Drive:', error);
    }
}
// Обновляем функцию showPrintModal для загрузки данных
const originalShowPrintModal = showPrintModal;
showPrintModal = function() {
    originalShowPrintModal();
    loadExecutorData(); // Загружаем данные исполнителя
};

// Добавляем обработчик для кнопки сохранения
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('saveExecutorData');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveExecutorData);
    }
});	
// ========== ПРОВЕРКА РАБОТЫ МАСШТАБИРОВАНИЯ ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('Проверка кнопок масштабирования:');
    
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const zoomResetBtn = document.getElementById('zoomReset');
    const scalable = document.getElementById('estimateScalable');
    const zoomPercent = document.getElementById('zoomPercent');
    
    console.log('zoomInBtn:', zoomInBtn ? 'найден' : 'НЕ НАЙДЕН');
    console.log('zoomOutBtn:', zoomOutBtn ? 'найден' : 'НЕ НАЙДЕН');
    console.log('zoomResetBtn:', zoomResetBtn ? 'найден' : 'НЕ НАЙДЕН');
    console.log('estimateScalable:', scalable ? 'найден' : 'НЕ НАЙДЕН');
    console.log('zoomPercent:', zoomPercent ? 'найден' : 'НЕ НАЙДЕН');
    
    if (scalable) {
        console.log('Начальный transform:', scalable.style.transform);
        console.log('Текущий zoomFactor:', zoomFactor);
    }
    
    // Добавляем дополнительные обработчики для надежности
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', function(e) {
            console.log('Клик по кнопке Zoom In');
            zoomIn();
        });
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', function(e) {
            console.log('Клик по кнопке Zoom Out');
            zoomOut();
        });
    }
    
    if (zoomResetBtn) {
        zoomResetBtn.addEventListener('click', function(e) {
            console.log('Клик по кнопке Zoom Reset');
            zoomReset();
        });
    }
});


// ========== ИСПРАВЛЕНИЕ МАСШТАБИРОВАНИЯ ДЛЯ МОБИЛЬНЫХ ==========
(function() {
    // Сохраняем оригинальные функции
    const originalApplyZoom = applyZoom;
    const originalZoomIn = zoomIn;
    const originalZoomOut = zoomOut;
    const originalZoomReset = zoomReset;
    
    // Переопределяем applyZoom для мобильных
    window.applyZoom = function() {
        const scalable = document.getElementById('estimateScalable');
        const zoomPercent = document.getElementById('zoomPercent');
        
        if (scalable) {
            // Для мобильных используем CSS переменную
            if (window.innerWidth <= 767) {
                document.documentElement.style.setProperty('--scale-factor', zoomFactor);
                scalable.style.webkitTransform = `scale(${zoomFactor})`;
                scalable.style.transform = `scale(${zoomFactor})`;
            } else {
                scalable.style.transform = `scale(${zoomFactor})`;
            }
            
            if (zoomPercent) {
                zoomPercent.textContent = Math.round(zoomFactor * 100) + '%';
            }
            
            saveZoomFactor();
            console.log('Масштаб применен (моб):', zoomFactor);
        }
    };
    
    // Переопределяем zoomIn
    window.zoomIn = function() {
        if (zoomFactor < MAX_ZOOM) {
            zoomFactor = Math.min(zoomFactor + 0.1, MAX_ZOOM);
            applyZoom();
            
            // Для мобильных принудительно обновляем скролл
            if (window.innerWidth <= 767) {
                setTimeout(function() {
                    const container = document.querySelector('.estimate-scale-container');
                    if (container) {
                        container.scrollLeft = 0;
                        container.scrollTop = 0;
                    }
                }, 50);
            }
        }
    };
    
    // Переопределяем zoomOut
    window.zoomOut = function() {
        if (zoomFactor > MIN_ZOOM) {
            zoomFactor = Math.max(zoomFactor - 0.1, MIN_ZOOM);
            applyZoom();
        }
    };
    
    // Переопределяем zoomReset
    window.zoomReset = function() {
        zoomFactor = 1.0;
        applyZoom();
        
        // Сбрасываем скролл
        if (window.innerWidth <= 767) {
            setTimeout(function() {
                const container = document.querySelector('.estimate-scale-container');
                if (container) {
                    container.scrollLeft = 0;
                    container.scrollTop = 0;
                }
            }, 50);
        }
    };
    
    // Добавляем обработчики касаний для мобильных
    document.addEventListener('DOMContentLoaded', function() {
        if (window.innerWidth <= 767) {
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const zoomResetBtn = document.getElementById('zoomReset');
            
            if (zoomInBtn) {
                zoomInBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    zoomIn();
                }, { passive: false });
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    zoomOut();
                }, { passive: false });
            }
            
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    zoomReset();
                }, { passive: false });
            }
            
            console.log('Мобильные обработчики масштабирования добавлены');
        }
    });
})();

// ========== ПРИНУДИТЕЛЬНОЕ ОБНОВЛЕНИЕ ПОСЛЕ ЗАГРУЗКИ ==========
window.addEventListener('load', function() {
    if (window.innerWidth <= 767) {
        // Загружаем сохраненный масштаб
        const savedZoom = localStorage.getItem('estimate_zoom');
        if (savedZoom) {
            zoomFactor = parseFloat(savedZoom);
            if (zoomFactor < MIN_ZOOM) zoomFactor = MIN_ZOOM;
            if (zoomFactor > MAX_ZOOM) zoomFactor = MAX_ZOOM;
        } else {
            zoomFactor = 1.0;
        }
        
        // Применяем масштаб
        setTimeout(function() {
            applyZoom();
            console.log('Масштаб применен после загрузки:', zoomFactor);
        }, 500);
    }
});
// ========== УПРАВЛЕНИЕ ВХОДОМ ЧЕРЕЗ GOOGLE ==========
// Получаем элементы
const googleLoginBtn = document.getElementById('googleLoginBtn');
const googleUserBlock = document.getElementById('googleUserBlock');
const googleUserEmail = document.getElementById('googleUserEmail');
const googleLogoutBtn = document.getElementById('googleLogoutBtn');
const googleLoginDivider = document.getElementById('googleLoginDivider');

// ========== УПРАВЛЕНИЕ ВСЕМИ КНОПКАМИ АВТОРИЗАЦИИ ==========
(function() {
    console.log('🚀 Управление кнопками авторизации');
    
    function updateAllButtons() {
        const loginBtn = document.getElementById('googleLoginBtn');
        const loginDivider = document.getElementById('googleLoginDivider');
        const userBlock = document.getElementById('googleUserBlock');
        const editorBtn = document.getElementById('editorBtn');
        
        const savedUser = localStorage.getItem('google_user');
        
        if (savedUser) {
            try {
                const user = JSON.parse(savedUser);
                const isAuthorized = true;
                const isEditor = (user.email === 'gunoev095@gmail.com');
                
                console.log('👤 Пользователь:', user.email);
                
                // 1. Скрываем кнопку входа и разделитель
                if (loginBtn) {
                    loginBtn.style.display = 'none';
                    console.log('✅ Кнопка входа скрыта');
                }
                
                if (loginDivider) {
                    loginDivider.style.display = 'none';
                    console.log('✅ Разделитель скрыт');
                }
                
                // 2. Показываем блок пользователя
                if (userBlock) {
                    userBlock.style.display = 'block';
                    
                    // Обновляем содержимое блока пользователя
                    const displayName = user.name || user.email.split('@')[0];
                    const photoUrl = user.picture || null;
                    
                    userBlock.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 4px; padding: 8px 13px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 2px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${photoUrl ? 
                                    `<img src="${photoUrl}" alt="avatar" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid white;">` : 
                                    `<i class="fas fa-user-circle" style="font-size: 28px; color: white;"></i>`
                                }
                                <div style="flex: 1; overflow: hidden;">
                                    <div style="font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${displayName}
                                    </div>
                                    <div style="font-size: 11px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${user.email}
                                    </div>
                                </div>
                                <button id="googleLogoutBtn" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 4px;" title="Выйти">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 4px; margin-top: 3px;">
                                <button id="saveToDriveBtn" class="btn btn-sm btn-primary" style="flex: 1; font-size: 10px; padding: 4px;" onclick="saveToDrive()">
                                    <i class="fas fa-save"></i> Сохранить
                                </button>
                                <button id="loadFromDriveBtn" class="btn btn-sm btn-success" style="flex: 1; font-size: 10px; padding: 4px;" onclick="loadFromDrive()">
                                    <i class="fas fa-download"></i> Загрузить
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Переназначаем обработчик выхода
                    const logoutBtn = document.getElementById('googleLogoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', function() {
                            localStorage.clear();
                            sessionStorage.clear();
                            location.reload();
                        });
                    }
                }
                
                // 3. Управляем кнопкой редактора
                if (editorBtn) {
                    if (isEditor) {
                        editorBtn.classList.add('show-editor');
                        console.log('✅ Кнопка редактора показана');
                    } else {
                        editorBtn.classList.remove('show-editor');
                        console.log('❌ Кнопка редактора скрыта (другой email)');
                    }
                }
                
            } catch (e) {
                console.error('❌ Ошибка парсинга:', e);
            }
        } else {
            // Нет пользователя - показываем кнопку входа
            if (loginBtn) loginBtn.style.display = 'flex';
            if (loginDivider) loginDivider.style.display = 'block';
            if (userBlock) userBlock.style.display = 'none';
            if (editorBtn) editorBtn.classList.remove('show-editor');
            
            console.log('❌ Нет пользователя - кнопка входа видна');
        }
    }
    
    // Запускаем при загрузке
    setTimeout(updateAllButtons, 500);
    
    // Слушаем изменения в localStorage
    window.addEventListener('storage', function(e) {
        if (e.key === 'google_user' || e.key === null) {
            console.log('🔄 Изменение localStorage');
            updateAllButtons();
        }
    });
    
    // Слушаем клики по кнопкам авторизации
    document.addEventListener('click', function(e) {
        if (e.target.closest('#googleLoginBtn') || e.target.closest('#googleLogoutBtn')) {
            console.log('🔄 Клик по кнопке авторизации');
            setTimeout(updateAllButtons, 1000);
        }
    });
    
    console.log('✅ Система управления кнопками запущена');
})();
// ========== УПРАВЛЕНИЕ КНОПКОЙ РЕДАКТОРА ==========
const editorBtn = document.getElementById('editorBtn');

// Функция для проверки email и отображения кнопки редактора
function updateEditorButtonVisibility(user) {
    if (!editorBtn) {
        console.log('❌ Кнопка редактора не найдена в DOM');
        return;
    }
    
    // Список разрешенных email
    const allowedEmails = ['gunoev095@gmail.com'];
    
    // Проверяем, авторизован ли пользователь и есть ли у него email
    if (user && user.email) {
        console.log('👤 Проверка пользователя:', user.email);
        
        if (allowedEmails.includes(user.email)) {
            // Показываем кнопку редактора для разрешенного email
            editorBtn.style.display = 'flex';
            console.log('✅ Кнопка редактора показана для:', user.email);
            
            // Добавляем обработчик клика (только один раз)
            if (!editorBtn.hasClickListener) {
                editorBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🖱️ Клик по кнопке редактора');
                    
                    // Открываем редактор в новой вкладке
                    const editorUrl = 'edit.html';
                    window.open(editorUrl, '_blank');
                    
                    // Закрываем меню
                    const menu = document.getElementById('controlsMenu');
                    if (menu) menu.classList.remove('show');
                });
                editorBtn.hasClickListener = true;
            }
        } else {
            // Скрываем кнопку для других email
            editorBtn.style.display = 'none';
            console.log('❌ Кнопка редактора скрыта для:', user.email);
        }
    } else {
        // Нет пользователя - кнопка скрыта
        editorBtn.style.display = 'none';
        console.log('❌ Кнопка редактора скрыта (пользователь не авторизован)');
    }
}

// Дополнительная проверка при изменении авторизации
window.addEventListener('storage', function(e) {
    if (e.key === 'google_user') {
        console.log('🔄 Изменились данные пользователя в localStorage');
        if (e.newValue) {
            try {
                const user = JSON.parse(e.newValue);
                updateEditorButtonVisibility(user);
            } catch (e) {
                console.error('❌ Ошибка парсинга нового пользователя');
                if (editorBtn) editorBtn.style.display = 'none';
            }
        } else {
            // Пользователь вышел
            if (editorBtn) editorBtn.style.display = 'none';
        }
    }
});
// Форматирование номера телефона
function formatPhoneNumber(phone) {
    if (!phone) return '';
    
    // Убираем все нецифровые символы
    const cleaned = phone.replace(/\D/g, '');
    
    // Проверяем длину для российских номеров
    if (cleaned.length === 11) {
        if (cleaned.startsWith('8')) {
            return `+7 (${cleaned.substring(1, 4)}) ${cleaned.substring(4, 7)}-${cleaned.substring(7, 9)}-${cleaned.substring(9, 11)}`;
        }
        if (cleaned.startsWith('7')) {
            return `+7 (${cleaned.substring(1, 4)}) ${cleaned.substring(4, 7)}-${cleaned.substring(7, 9)}-${cleaned.substring(9, 11)}`;
        }
    }
    // Если номер 10 цифр (без кода)
    if (cleaned.length === 10) {
        return `+7 (${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6, 8)}-${cleaned.substring(8, 10)}`;
    }
    return phone;
}

// Функция для проверки наличия логотипа в Drive (ИСПРАВЛЕНО)
async function checkLogoInDrive() {
    console.log('🔍 Проверяем наличие логотипа в Drive...');
    
    const token = await getValidAccessToken();
    if (!token) {
        console.log('❌ Нет токена для проверки логотипа');
        return;
    }
    
    try {
        const response = await fetch(
            'https://www.googleapis.com/drive/v3/files?q=name="company_logo.png"&fields=files(id)',
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        console.log('📡 Статус ответа:', response.status);
        
        if (!response.ok) {
            if (response.status === 403) {
                console.log('⚠️ Нет прав на Drive, запрашиваем...');
                const granted = await requestDriveScope();
                if (granted) {
                    // Повторяем проверку после получения прав
                    setTimeout(() => checkLogoInDrive(), 1000);
                }
            }
            return;
        }
        
        const data = await response.json();
        console.log('📦 Данные из Drive:', data);
        
        // ПОКАЗЫВАЕМ КНОПКУ если логотип есть
        const loadLogoBtn = document.getElementById('loadLogoFromDriveBtn');
        if (!loadLogoBtn) {
            console.log('❌ Кнопка загрузки логотипа не найдена');
            return;
        }
        
        if (data.files && data.files.length > 0) {
            loadLogoBtn.style.display = 'inline-block';
            console.log('✅ Логотип найден, кнопка загрузки активна');
        } else {
            loadLogoBtn.style.display = 'none';
            console.log('ℹ️ Логотип не найден, кнопка скрыта');
        }
        
    } catch (error) {
        console.error('❌ Ошибка проверки логотипа:', error);
    }
}

// Отдельная функция для обновления кнопки
function updateLogoButton(hasLogo) {
    const loadLogoBtn = document.getElementById('loadLogoFromDriveBtn');
    if (!loadLogoBtn) {
        console.log('❌ Кнопка загрузки логотипа не найдена');
        return;
    }
    
    if (hasLogo) {
        loadLogoBtn.style.display = 'inline-block';
        console.log('✅ Логотип найден, кнопка активна');
    } else {
        loadLogoBtn.style.display = 'none';
        console.log('ℹ️ Логотип не найден');
    }
}

// Функция выхода
function googleLogout() {
    // Просто делаем ту же очистку, что и вручную
    localStorage.clear();
    sessionStorage.clear();
    
    // Очищаем cookies
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    showNotification('👋 Выход из аккаунта');
    
    // Перезагружаем страницу
    location.reload();
}


		
// Шаг 4: Проверка авторизации при загрузке (ИСПРАВЛЕНО)
// Шаг 4: Проверка авторизации при загрузке (ИСПРАВЛЕНО)
async function checkGoogleAuth() {
    const refreshToken = localStorage.getItem('google_refresh_token');
    const userJson = localStorage.getItem('google_user');
    
    if (refreshToken && userJson) {
        try {
            const user = JSON.parse(userJson);
            
            // Проверяем, можем ли получить access token
            const accessToken = await getValidAccessToken();
            if (accessToken) {
                window.googleToken = accessToken;
                localStorage.setItem('google_token', accessToken);
                
                // Вызываем новую функцию
                if (typeof updateAllButtons === 'function') {
                    updateAllButtons();
                }
            } else {
                // Не удалось обновить - очищаем
                localStorage.removeItem('google_refresh_token');
                localStorage.removeItem('google_user');
                
                if (typeof updateAllButtons === 'function') {
                    updateAllButtons();
                }
            }
            
        } catch (e) {
            console.error('Ошибка парсинга пользователя');
            localStorage.removeItem('google_user');
            
            if (typeof updateAllButtons === 'function') {
                updateAllButtons();
            }
        }
    } else {
        if (typeof updateAllButtons === 'function') {
            updateAllButtons();
        }
    }
}

// Назначаем обработчики (только если элементы существуют)
if (googleLoginBtn) {
    googleLoginBtn.addEventListener('click', googleLogin);
}

if (googleLogoutBtn) {
    googleLogoutBtn.addEventListener('click', googleLogout);
}

// Запускаем проверку при загрузке
document.addEventListener('DOMContentLoaded', async function() {
    await checkGoogleAuth();
    // Остальная инициализация...
});

let selectedDriveFileId = null;

// ========== ИСПРАВЛЕННАЯ ФУНКЦИЯ ==========
async function getEstimateDetails(fileId) {
    const token = await getValidAccessToken();
    if (!token) {
        console.log('❌ Нет токена для getEstimateDetails');
        return null;
    }
    
    try {
        console.log(`🔍 Загружаем файл ${fileId} для проверки...`);
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) {
            console.log(`❌ Ошибка загрузки файла: ${response.status}`);
            return null;
        }
        
        const data = await response.json();
        
        if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
            console.log(`✅ Файл валиден: ${data.data.length} позиций`);
            return {
                itemsCount: data.data.length,
                total: data.totals?.totalAmount || 0,
                date: data.date
            };
        } else {
            console.log(`❌ Файл не является сметой (нет данных)`);
            return null;
        }
    } catch (error) {
        console.error('❌ Ошибка получения деталей файла:', error);
        return null;
    }
}
// Показать окно загрузки из Google Drive
async function showGoogleDriveLoadModal() {
    // Сначала закрываем меню
    const menu = document.getElementById('controlsMenu');
    if (menu) menu.classList.remove('show');
    
    const modal = document.getElementById('googleDriveLoadModal');
    const filesList = document.getElementById('googleDriveFilesList');
    const loading = document.getElementById('googleDriveLoading');
    const loadBtn = document.getElementById('loadSelectedDriveFileBtn');
    
    filesList.innerHTML = '';
    selectedDriveFileId = null;
    if (loadBtn) loadBtn.style.display = 'none';
    
    modal.style.display = 'flex';
    loading.style.display = 'block';
    
    try {
        // ✅ ИСПРАВЛЕНО: используем getValidAccessToken() вместо localStorage
        let token = await getValidAccessToken();
        
        if (!token) {
            showNotification('⚠️ Требуется доступ к Google Drive');
            
            const granted = await requestDriveScope();
            if (!granted) {
                showNotification('❌ Нет доступа к Google Drive');
                modal.style.display = 'none';
                return;
            }
            
            // Получаем новый токен с правами
            token = await getValidAccessToken();
            if (!token) {
                showNotification('❌ Ошибка получения токена');
                modal.style.display = 'none';
                return;
            }
        }
        
        // Теперь токен есть - запрашиваем файлы
        const response = await fetch(
            'https://www.googleapis.com/drive/v3/files?q=mimeType="application/json" and trashed=false&orderBy=modifiedTime desc&fields=files(id,name,modifiedTime,size)',
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        const data = await response.json();
        console.log('Файлы из Drive:', data.files);
        
        if (!data.files || data.files.length === 0) {
            filesList.innerHTML = '<div class="empty-drive-files">📁 В Google Drive нет файлов</div>';
            loading.style.display = 'none';
            return;
        }
        
        // Создаём массив промисов для проверки каждого файла
        const filePromises = data.files.map(async file => {
            try {
                const details = await getEstimateDetails(file.id);
                // Проверяем, что файл содержит данные сметы
                if (details && details.itemsCount > 0) {
                    return { file, details };
                }
            } catch (e) {
                console.log('Ошибка проверки файла:', file.name);
            }
            return null;
        });
        
        // Ждём все проверки
        const results = await Promise.all(filePromises);
        
        // Отфильтровываем только валидные сметы
        const validFiles = results.filter(r => r !== null);
        
        if (validFiles.length === 0) {
            filesList.innerHTML = '<div class="empty-drive-files">📁 В Google Drive нет файлов смет</div>';
            loading.style.display = 'none';
            return;
        }
        
        // Отображаем только валидные сметы
        validFiles.forEach(({ file, details }) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'google-drive-item';
            itemDiv.dataset.id = file.id;
            itemDiv.dataset.name = file.name;
            
            const fileName = file.name.replace('.json', '');
            
            // Получаем дату из данных файла (если есть)
            let displayDate = 'Дата неизвестна';
            if (details.date) {
                try {
                    const date = new Date(details.date);
                    if (!isNaN(date.getTime())) {
                        displayDate = date.toLocaleDateString('ru-RU');
                    }
                } catch (e) {}
            }
            
            // Ищем дату в имени файла как запасной вариант
            if (displayDate === 'Дата неизвестна') {
                const dateMatch = fileName.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                if (dateMatch) {
                    displayDate = `${dateMatch[1]}.${dateMatch[2]}.${dateMatch[3]}`;
                }
            }
            
            itemDiv.innerHTML = `
                <div class="google-drive-item-info">
                    <div class="google-drive-item-name">
                        <i class="fas fa-file-alt"></i>
                        ${fileName}
                    </div>
                    <div class="google-drive-item-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${displayDate}</span>
                        <span><i class="fas fa-list"></i> ${details.itemsCount} позиций</span>
                        <span><i class="fas fa-ruble-sign"></i> ${formatCurrency(details.total)}</span>
                    </div>
                </div>
                <div class="google-drive-item-actions">
                    <button class="google-drive-edit-btn" onclick="editDriveFileName('${file.id}', '${file.name}')" title="Редактировать название">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="google-drive-delete-btn" onclick="deleteDriveFile('${file.id}')" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            itemDiv.addEventListener('click', function(e) {
                if (!e.target.closest('button')) {
                    document.querySelectorAll('.google-drive-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedDriveFileId = file.id;
                    if (loadBtn) loadBtn.style.display = 'inline-flex';
                }
            });
            
            filesList.appendChild(itemDiv);
        });
        
        loading.style.display = 'none';
        
    } catch (error) {
        console.error('Ошибка загрузки из Drive:', error);
        loading.style.display = 'none';
        filesList.innerHTML = '<div class="empty-drive-files">❌ Ошибка загрузки файлов</div>';
    }
}

// Редактирование имени файла в Drive
async function editDriveFileName(fileId, currentName) {
    const newName = prompt('Введите новое название файла:', currentName.replace('.json', ''));
    if (!newName || newName.trim() === '') return;
    
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        showNotification('❌ Ошибка авторизации');
        return;
    }
    
    try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: newName + '.json'
            })
        });
        
        if (!response.ok) {
            throw new Error(`Ошибка: ${response.status}`);
        }
        
        showNotification('✅ Название файла изменено');
        showGoogleDriveLoadModal(); // Обновляем список
    } catch (error) {
        console.error('❌ Ошибка переименования:', error);
        showNotification('❌ Ошибка при переименовании');
    }
}

// Удаление файла из Drive
async function deleteDriveFile(fileId) {
    if (!confirm('Удалить этот файл из Google Drive?')) return;
    
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        showNotification('❌ Ошибка авторизации');
        return;
    }
    
    try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error(`Ошибка: ${response.status}`);
        }
        
        showNotification('✅ Файл удален из Google Drive');
        showGoogleDriveLoadModal(); // Обновляем список
    } catch (error) {
        console.error('❌ Ошибка удаления:', error);
        showNotification('❌ Ошибка при удалении');
    }
}
// Загрузка данных из Drive в смету
function loadDriveEstimateData(data) {
    console.log('Загрузка сметы из Drive:', data.name);
    
    // Очищаем текущие данные
    estimateData = [];
    
    // Загружаем данные
    if (data.data && data.data.length > 0) {
        data.data.forEach((item, index) => {
            estimateData.push({ 
                ...item,
                id: index + 1,
                coefficient: item.coefficient || 1.0,
                coeffComment: item.coeffComment || '',
                discount: item.discount || 0,
                discountComment: item.discountComment || '',
                rowComment: item.rowComment || '',
                originalPrice: item.originalPrice || item.price || 0
            });
        });
    }
    
    // Добавляем пустые строки до 50
    while (estimateData.length < 50) {
        estimateData.push({
            id: estimateData.length + 1,
            priceId: "",
            name: "",
            unit: "",
            price: 0,
            quantity: 1,
            total: 0,
            notes: "",
            isMaterial: false,
            coefficient: 1.0,
            coeffComment: "",
            discount: 0,
            discountComment: "",
            rowComment: "",
            originalPrice: 0
        });
    }
    
    // Загружаем глобальные настройки если есть
    if (data.globalSettings) {
        document.getElementById('globalDiscount').value = data.globalSettings.discount || 0;
        document.getElementById('globalCoefficient').value = data.globalSettings.coefficient || 1.0;
        document.getElementById('globalComment').value = data.globalSettings.comment || '';
    }
    
    // Загружаем масштаб если есть
    if (data.zoom) {
        zoomFactor = data.zoom;
        if (zoomFactor < MIN_ZOOM) zoomFactor = MIN_ZOOM;
        if (zoomFactor > MAX_ZOOM) zoomFactor = MAX_ZOOM;
        applyZoom();
    }
    
    // Рендерим таблицу
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    showTab('estimate');
    
    showNotification(`✅ Загружена смета: ${data.name || 'из Drive'}`);
}

// Загрузка выбранного файла из Drive
async function loadSelectedDriveFile() {
    if (!selectedDriveFileId) return;
    
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами Drive
    const token = await getValidAccessToken();
    if (!token) {
        showNotification('❌ Ошибка авторизации');
        return;
    }
    
    try {
        showNotification('⏳ Загрузка сметы...');
        
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${selectedDriveFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) {
            throw new Error(`Ошибка загрузки: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.data) {
            loadDriveEstimateData(data);
            document.getElementById('googleDriveLoadModal').style.display = 'none';
            showNotification('✅ Смета загружена из Google Drive');
        } else {
            showNotification('❌ Неверный формат файла');
        }
    } catch (error) {
        console.error('Ошибка загрузки файла:', error);
        showNotification(`❌ Ошибка: ${error.message}`);
    }
}

// ========== УПРАВЛЕНИЕ ЛОГОТИПОМ ==========
let logoDataUrl = localStorage.getItem('companyLogo') || null;

// Сохранить логотип в Google Drive (ИСПРАВЛЕНО)
async function saveLogoToDrive() {
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        showNotification('❌ Сначала войдите в Google и получите права на Drive');
        return;
    }
    
    if (!logoDataUrl) {
        showNotification('❌ Сначала загрузите логотип');
        return;
    }
    
    try {
        showNotification('⏳ Сохраняем логотип в Drive...');
        
        const response = await fetch(logoDataUrl);
        const blob = await response.blob();
        
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify({
            name: 'company_logo.png',
            mimeType: 'image/png'
        })], { type: 'application/json' }));
        formData.append('file', blob);
        
        const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            console.error('❌ Ошибка загрузки:', errorText);
            throw new Error(`Ошибка загрузки: ${uploadResponse.status}`);
        }
        
        // Показываем кнопку загрузки из Drive
        const loadBtn = document.getElementById('loadLogoFromDriveBtn');
        if (loadBtn) {
            loadBtn.style.display = 'inline-block';
            console.log('✅ Кнопка загрузки логотипа активирована');
        }
        
        showNotification('✅ Логотип сохранен в Google Drive');
        
    } catch (error) {
        console.error('❌ Ошибка сохранения логотипа:', error);
        showNotification('❌ Ошибка при сохранении логотипа');
    }
}
// Загрузить логотип из Google Drive (ИСПРАВЛЕНО)
async function loadLogoFromDrive() {
    // ✅ ИСПРАВЛЕНО: используем правильный токен с правами на Drive
    const token = await getValidAccessToken();
    if (!token) {
        showNotification('❌ Сначала войдите в Google и получите права на Drive');
        return;
    }
    
    try {
        showNotification('⏳ Загружаем логотип из Drive...');
        
        // Ищем файл логотипа
        const response = await fetch(
            'https://www.googleapis.com/drive/v3/files?q=name="company_logo.png"&fields=files(id)',
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) {
            if (response.status === 403) {
                showNotification('⚠️ Нет прав доступа к Drive');
                const granted = await requestDriveScope();
                if (granted) {
                    // Повторяем загрузку после получения прав
                    return loadLogoFromDrive();
                }
            }
            throw new Error(`Ошибка: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.files || data.files.length === 0) {
            showNotification('❌ Логотип не найден в Drive');
            return;
        }
        
        const fileId = data.files[0].id;
        
        // Загружаем файл
        const fileResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!fileResponse.ok) {
            throw new Error(`Ошибка загрузки файла: ${fileResponse.status}`);
        }
        
        const blob = await fileResponse.blob();
        
        // Конвертируем в Data URL
        const reader = new FileReader();
        reader.onload = function(e) {
            logoDataUrl = e.target.result;
            localStorage.setItem('companyLogo', logoDataUrl);
            
            // Обновляем интерфейс
            const logoImg = document.getElementById('logoImage');
            const logoPreview = document.getElementById('logoPreview');
            const clearBtn = document.getElementById('clearLogoBtn');
            const saveBtn = document.getElementById('saveLogoToDriveBtn');
            const loadBtn = document.getElementById('loadLogoFromDriveBtn');
            
            if (logoImg) logoImg.src = logoDataUrl;
            if (logoPreview) logoPreview.style.display = 'block';
            if (clearBtn) clearBtn.style.display = 'inline-block';
            if (saveBtn) saveBtn.style.display = 'inline-block';
            if (loadBtn) loadBtn.style.display = 'inline-block';
            
            showNotification('✅ Логотип загружен из Drive');
        };
        reader.readAsDataURL(blob);
        
    } catch (error) {
        console.error('❌ Ошибка загрузки логотипа из Drive:', error);
        showNotification('❌ Ошибка при загрузке логотипа');
    }
}

// Инициализация логотипа и обработчиков
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем сохраненный логотип при открытии
    if (logoDataUrl) {
        const logoImg = document.getElementById('logoImage');
        const logoPreview = document.getElementById('logoPreview');
        const clearBtn = document.getElementById('clearLogoBtn');
        const saveBtn = document.getElementById('saveLogoToDriveBtn');
        const loadBtn = document.getElementById('loadLogoFromDriveBtn');
        
        if (logoImg) logoImg.src = logoDataUrl;
        if (logoPreview) logoPreview.style.display = 'block';
        if (clearBtn) clearBtn.style.display = 'inline-block';
        if (saveBtn) saveBtn.style.display = 'inline-block';
        if (loadBtn) loadBtn.style.display = 'inline-block';
    }
    
    // Обработчик загрузки файла
    const logoUpload = document.getElementById('logoUpload');
    if (logoUpload) {
        logoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    logoDataUrl = event.target.result;
                    localStorage.setItem('companyLogo', logoDataUrl);
                    
                    const preview = document.getElementById('logoPreview');
                    const logoImg = document.getElementById('logoImage');
                    const clearBtn = document.getElementById('clearLogoBtn');
                    const saveBtn = document.getElementById('saveLogoToDriveBtn');
                    const loadBtn = document.getElementById('loadLogoFromDriveBtn');
                    
                    if (logoImg) logoImg.src = logoDataUrl;
                    if (preview) preview.style.display = 'block';
                    if (clearBtn) clearBtn.style.display = 'inline-block';
                    if (saveBtn) saveBtn.style.display = 'inline-block';
                    if (loadBtn) loadBtn.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Обработчик очистки
    const clearBtn = document.getElementById('clearLogoBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            localStorage.removeItem('companyLogo');
            logoDataUrl = null;
            
            const preview = document.getElementById('logoPreview');
            const upload = document.getElementById('logoUpload');
            const saveBtn = document.getElementById('saveLogoToDriveBtn');
            const loadBtn = document.getElementById('loadLogoFromDriveBtn');
            
            if (preview) preview.style.display = 'none';
            if (upload) upload.value = '';
            this.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'none';
            if (loadBtn) loadBtn.style.display = 'none';
        });
    }
    
    // Кнопка загрузки выбранного файла из Drive
    const loadDriveBtn = document.getElementById('loadSelectedDriveFileBtn');
    if (loadDriveBtn) {
        loadDriveBtn.addEventListener('click', loadSelectedDriveFile);
    }
    
    // Кнопка закрытия модального окна Drive
    const closeDriveBtn = document.getElementById('closeGoogleDriveModal');
    if (closeDriveBtn) {
        closeDriveBtn.addEventListener('click', () => {
            document.getElementById('googleDriveLoadModal').style.display = 'none';
        });
    }
    
    // Кнопка отмены для Drive
    const cancelDriveBtn = document.getElementById('cancelGoogleDriveModalBtn');
    if (cancelDriveBtn) {
        cancelDriveBtn.addEventListener('click', () => {
            document.getElementById('googleDriveLoadModal').style.display = 'none';
        });
    }
    
    // Кнопка загрузки логотипа из Drive
    const loadLogoBtn = document.getElementById('loadLogoFromDriveBtn');
    if (loadLogoBtn) {
        loadLogoBtn.addEventListener('click', loadLogoFromDrive);
    }
    
    // Кнопка сохранения логотипа в Drive
    const saveLogoBtn = document.getElementById('saveLogoToDriveBtn');
    if (saveLogoBtn) {
        saveLogoBtn.addEventListener('click', saveLogoToDrive);
    }
});



// ========== УПРАВЛЕНИЕ КНОПКОЙ РЕДАКТОРА (ТИХАЯ ВЕРСИЯ) ==========
(function() {
    console.log('🚀 Управление кнопкой редактора');
    
    function updateEditorButton() {
        const btn = document.getElementById('editorBtn');
        if (!btn) return;
        
        const savedUser = localStorage.getItem('google_user');
        let shouldShow = false;
        
        if (savedUser) {
            try {
                const user = JSON.parse(savedUser);
                shouldShow = (user.email === 'gunoev095@gmail.com');
            } catch (e) {}
        }
        
        if (shouldShow) {
            btn.classList.add('show-editor');
        } else {
            btn.classList.remove('show-editor');
        }
    }
    
    // Запускаем один раз при загрузке
    setTimeout(updateEditorButton, 500);
    
    // Слушаем только реальные события
    window.addEventListener('storage', function(e) {
        if (e.key === 'google_user') {
            updateEditorButton();
        }
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('#googleLoginBtn') || e.target.closest('#googleLogoutBtn')) {
            setTimeout(updateEditorButton, 1000);
        }
    });
    
    console.log('✅ Система управления кнопкой запущена (без интервалов)');
})();



		
    </script>
	<!-- Модальное окно для загрузки из Google Drive -->
<div class="modal" id="googleDriveLoadModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fab fa-google-drive"></i> Загрузить из Google Drive</h3>
            <button class="close-modal" id="closeGoogleDriveModal">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Индикатор загрузки -->
            <div id="googleDriveLoading" style="text-align: center; padding: 20px; display: none;">
                <i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...
            </div>
            
            <!-- Список файлов -->
            <div id="googleDriveFilesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Файлы будут загружены сюда -->
            </div>
            
            <!-- Кнопки действий -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #ddd; padding-top: 15px;">
                <button class="btn btn-success" id="loadSelectedDriveFileBtn" style="display: none;">
                    <i class="fas fa-download"></i> Загрузить выбранное
                </button>
                <button class="btn btn-secondary" id="cancelGoogleDriveModalBtn" style="background: #6c757d;">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>
</div>	
<!-- Подвал сайта -->
<div class="site-footer" style="text-align: center; margin-top: 30px; padding: 10px; border-top: 1px solid #eee;">
    <div class="footer-links" style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; color: #666; font-size: 12px;">
        <a href="/privacy.html" style="color: #3498db; text-decoration: none;">Политика конфиденциальности</a>
        <a href="/terms.html" style="color: #3498db; text-decoration: none;">Условия использования</a>
    </div>
</div>
	<style>
@media (max-width: 767px) {
    .footer-links {
        flex-direction: column;
        gap: 10px !important;
        align-items: center;
    }
}
</style>
</body>
	
</html>
