<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ЭлектроСмета профессиональный расчет от Electric_Group для Братьев</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Общие стили */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* Шапка */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo-icon {
            color: var(--secondary);
            font-size: 1.3rem;
        }

        .logo-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Панель навигации */
        .nav-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 0;
            padding: 10px;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: var(--shadow);
        }

        /* Вкладки */
        .tabs {
            display: flex;
            flex: 1;
            min-width: 200px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        /* Контейнер контента */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
            min-height: 500px;
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

        /* Вкладка 1: Прайс-лист */
        .price-header {
            background: var(--primary);
            color: white;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 768px) {
            .price-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .price-header h2 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            position: relative;
            width: 100%;
            height: 40px;
        }

        @media (min-width: 768px) {
            .search-box {
                width: 300px;
            }
        }

        .search-box input {
            width: 100%;
            padding: 9px 13px 9px 37px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .search-box input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .price-list-container {
            height: calc(100vh - 250px);
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }

        .price-section {
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .section-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 10px 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .section-content.expanded {
            max-height: 5000px;
        }

        .price-item {
            display: grid;
            grid-template-columns: 50px 1fr 60px 80px;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .price-item:hover {
            background: #f0f7ff;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .item-number {
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            background: #f0f8ff;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .item-name {
            font-size: 0.85rem;
            word-break: break-word;
            line-height: 1.3;
        }

        .item-unit {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .item-price {
            text-align: right;
            font-weight: 600;
            color: var(--success);
            font-size: 0.85rem;
        }


        /* Вкладка 2: Смета */
        .estimate-table-container {
            height: calc(100vh - 300px);
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
/* ========== УВЕЛИЧЕНИЕ КОЛОНКИ "ЦЕНА" ========== */
.estimate-table th:nth-child(5),
.estimate-table td:nth-child(5) {
    width: 110px !important;
    min-width: 110px !important;
    max-width: 110px !important;
    white-space: nowrap !important;
    overflow: visible !important;
    text-align: center;
    padding: 8px 6px !important;
}

/* Увеличить поле ввода цены */
.price-input {
    width: 75px !important;
    min-width: 75px !important;
    padding: 6px 4px !important;
    font-size: 0.9rem !important;
}
        .estimate-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
            min-width: 700px;
        }

        .estimate-table thead {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .estimate-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .estimate-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .estimate-table tbody tr:hover {
            background: #f9f9f9;
        }

        .estimate-table tbody tr.material-row {
            background-color: #fff8e1;
        }

        .estimate-table td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }

        .search-cell {
            position: relative;
            min-width: 150px;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .dropdown-item {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .dropdown-item:hover {
            background: #f0f7ff;
        }

        .number-input {
            width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .unit-cell, .price-cell, .total-cell {
            font-weight: 500;
            text-align: center;
        }

        .total-cell {
            color: var(--success);
            font-weight: 600;
        }

        .actions-cell {
            text-align: center;
            width: 40px;
        }

        .delete-row {
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .estimate-totals {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .total-row:last-child {
            margin-bottom: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .total-value {
            font-weight: 600;
            color: var(--success);
        }

        /* Кнопки */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
            background: var(--secondary);
            color: white;
            text-decoration: none;
            user-select: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-info {
            background: #17a2b8;
        }

        /* Управление */
        .estimate-controls {
            display: flex;
            gap: 8px;
        }

        .dropdown-controls {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 160px;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #333;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Адаптивность для мобильных */
        @media (max-width: 767px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .nav-panel {
                flex-direction: column;
                padding: 8px;
            }
            
            .tabs {
                width: 100%;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .estimate-controls {
                width: 100%;
                justify-content: center;
            }
            
            .dropdown-toggle {
                min-width: 100%;
            }
            
            .price-item {
                grid-template-columns: 40px 1fr 40px 70px;
                gap: 6px;
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .item-number {
                font-size: 0.8rem;
            }
            
            .item-name {
                font-size: 0.8rem;
            }
            
            .item-unit {
                font-size: 0.75rem;
            }
            
            .item-price {
                font-size: 0.8rem;
            }
            
            .price-list-container {
                height: calc(100vh - 200px);
            }
            
            .estimate-table-container {
                height: calc(100vh - 250px);
                padding: 10px;
            }
            
            .estimate-table th,
            .estimate-table td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }

                /* ДОБАВЬТЕ ЭТУ СЕКЦИЮ - уменьшаем колонку "Код" */
            .estimate-table th:nth-child(2),
            .estimate-table td:nth-child(2) {
                width: 45px;       /* Уменьшили ширину */
                min-width: 45px;
                max-width: 45px;
                padding: 6px 2px;  /* Меньше горизонтальные отступы */
                font-size: 0.75rem; /* Меньше текст */
            }
            .search-input {
                font-size: 0.8rem;
                padding: 5px 6px;
            }
            
            .number-input {
                width: 50px;
                padding: 4px;
                font-size: 0.8rem;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                padding: 15px;
                max-height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .price-item {
                grid-template-columns: 35px 1fr 35px 60px;
                gap: 4px;
                padding: 5px 6px;
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        /* Исправления для iOS */
        input, textarea, select {
            font-size: 16px !important; /* Предотвращает масштабирование в iOS */
        }
        
        .no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-bolt logo-icon"></i>
                <span class="logo-text">ЭлектроСмета от @Electrc_Group</span>
            </div>
        </div>
        
        <!-- Панель навигации -->
        <div class="nav-panel">
            <!-- Вкладки -->
            <div class="tabs">
                <button class="tab active" id="priceTabBtn">
                    <i class="fas fa-file-invoice-dollar"></i> Прайс-лист
                </button>
                <button class="tab" id="estimateTabBtn">
                    <i class="fas fa-calculator"></i> Смета
                    <span id="estimateCounter" style="
                        background: #6c757d; 
                        color: white; 
                        padding: 2px 6px; 
                        border-radius: 10px; 
                        font-size: 0.75rem; 
                        margin-left: 5px;
                    ">0</span>
                </button>
            </div>
            
            <!-- Управление -->
            <div class="estimate-controls">
                <!-- Кнопка печати прайса -->
                <button class="btn btn-info" id="printPriceBtn">
                    <i class="fas fa-print"></i> Прайс
                </button>
                
                <!-- Меню управления сметой -->
                <div class="dropdown-controls">
                    <button class="btn btn-success dropdown-toggle" id="controlsDropdown">
                        <i class="fas fa-bars"></i> Управление
                        <i class="fas fa-chevron-down" style="margin-left: 8px;"></i>
                    </button>
                    <div class="dropdown-menu" id="controlsMenu">
                        <button class="dropdown-item" id="addRowBtn">
                            <i class="fas fa-plus"></i> Добавить строку
                        </button>
                        <button class="dropdown-item" id="addMaterialBtn">
                            <i class="fas fa-box"></i> Добавить материал
                        </button>
                        <button class="dropdown-item" id="clearEstimateBtn">
                            <i class="fas fa-broom"></i> Очистить смету
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="saveEstimateBtn">
                            <i class="fas fa-save"></i> Сохранить смету
                        </button>
                        <button class="dropdown-item" id="loadEstimateBtn">
                            <i class="fas fa-folder-open"></i> Загрузить смету
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="saveAsPdfBtn">
                            <i class="fas fa-file-pdf"></i> Сохранить в PDF
                        </button>
                        <button class="dropdown-item" id="printEstimateBtn">
                            <i class="fas fa-print"></i> Печать сметы
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Вкладка 1: Прайс-лист -->
        <div class="tab-content active" id="price-tab">
            <div class="price-header">
                <h2><i class="fas fa-list"></i> Прайс-лист электромонтажных работ ЧР</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="priceSearch" placeholder="Поиск по прайс-листу..." autocomplete="off">
                </div>
            </div>
            
            <div class="price-list-container" id="priceList">
                <!-- Прайс-лист будет загружен здесь -->
            </div>
        </div>
        
        <!-- Вкладка 2: Смета -->
        <div class="tab-content" id="estimate-tab">
            <div class="estimate-table-container">
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th width="40">№</th>
                            <th width="45">Код</th>
                            <th>Наименование</th>
                            <th width="70">Ед. изм.</th>
                            <th width="110">Цена, руб.</th>
                            <th width="90">Кол-во</th>
                            <th width="110">Сумма, руб.</th>
                            <th width="40"></th>
                        </tr>
                    </thead>
                    <tbody id="estimateTable">
                        <!-- Строки сметы будут загружены здесь -->
                    </tbody>
                </table>
            </div>
            
            <div class="estimate-totals">    
                <div class="total-row">
                    <span>Общая сумма сметы:</span>
                    <span class="total-value" id="totalAmount">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="modal" id="materialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> Добавление материала</h3>
                <button class="close-modal" id="closeMaterialModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="materialName">Наименование материала:</label>
                    <input type="text" id="materialName" class="form-control" placeholder="Например: Кабель ВВГнг 3х1,5" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialUnit">Единица измерения:</label>
                    <select id="materialUnit" class="form-control">
                        <option value="шт.">шт.</option>
                        <option value="м/п">м/п</option>
                        <option value="м">м</option>
                        <option value="комплект">комплект</option>
                        <option value="упаковка">упаковка</option>
                        <option value="рулон">рулон</option>
                        <option value="кг">кг</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена за единицу, руб.:</label>
                    <input type="number" id="materialPrice" class="form-control" placeholder="0" min="0" step="0.01" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialQuantity">Количество:</label>
                    <input type="number" id="materialQuantity" class="form-control" placeholder="1" min="1" step="1" value="1" autocomplete="off">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="addMaterialToEstimate" style="width: 100%;">
                        <i class="fas fa-plus-circle"></i> Добавить в смету
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-print"></i> Печать сметы</h3>
                <button class="close-modal" id="closePrintModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="clientName">Клиент:</label>
                    <input type="text" id="clientName" class="form-control" placeholder="Введите имя клиента" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="estimateNumber">Номер сметы:</label>
                    <input type="text" id="estimateNumber" class="form-control" value="СМ-001" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="estimateDate">Дата:</label>
                    <input type="date" id="estimateDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="notes">Примечания:</label>
                    <textarea id="notes" class="form-control" rows="3" placeholder="Дополнительная информация..." autocomplete="off"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="generatePrint" style="width: 100%;">
                        <i class="fas fa-file-pdf"></i> Сформировать для печати
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="loadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Загрузить смету</h3>
                <button class="close-modal" id="closeLoadModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="savedEstimatesList">
                    <!-- Список сохраненных смет будет загружен здесь -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Проверяем iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // Функция для iOS - отложенная инициализация
        function initForIOS() {
            console.log('Инициализация для iOS');
            
            // Исправляем скролл
            document.body.style.overflow = 'auto';
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // Исправляем фокус
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Предотвращаем масштабирование при фокусе
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    e.preventDefault();
                }
            }, {passive: false});
        }

        // Данные прайс-листа
        const priceData = [
            {
                section: "① Монтажные работы",
                items: [
                    {id: 1, name: "Разводка кабеля, опуски на розетки, выключатели к светильнику и щиту", unit: "шт.", price: 500},
                    {id: 2, name: "Распределительная коробка, скрутка-сиз, клеммниками, ВАГО", unit: "шт.", price: 650},
                    {id: 3, name: "Распределительная коробка, сварка, пайка, пресс ГМЛ", unit: "шт.", price: 900},
                    {id: 4, name: "Распределительная коробка пересборка старой, двойная цена", unit: "шт.", price: 1300},
                    {id: 5, name: "Распайка проходного переключателя 1-2кл.", unit: "шт.", price: 1000},
                    {id: 6, name: "Распайка перекрестный переключателя 1-2кл.", unit: "шт.", price: 1500},
                    {id: 7, name: "Затягивание кабеля в гофру до Ø 25мм", unit: "м/п", price: 30},
                    {id: 8, name: "Затягивание кабеля в гофру Ø 32мм", unit: "м/п", price: 60},
                    {id: 9, name: "Затягивание кабеля в металлическую гофру Ø 32 мм", unit: "м/п", price: 100},
                    {id: 10, name: "Монтаж кабеля 220В до 2,5мм²", unit: "м/п", price: 120},
                    {id: 11, name: "Монтаж кабеля 220В от 4 мм2 до 6 мм2 (медь)", unit: "м/п", price: 150},
                    {id: 12, name: "Монтаж кабеля 220В 10 мм2 / 16 мм2", unit: "м/п", price: 180},
                    {id: 13, name: "Монтаж кабеля 220В 25 мм2", unit: "м/п", price: 250},
                    {id: 14, name: "Монтаж кабеля 380В от 1.5 мм2 до 6 мм2", unit: "м/п", price: 250},
                    {id: 15, name: "Монтаж кабеля 380В до 10 мм2 до 16 мм2", unit: "м/п", price: 330},
                    {id: 16, name: "Монтаж кабеля 380В от 25 мм2 до 35 мм2", unit: "м/п", price: 480},
                    {id: 17, name: "Прокладка бронь-кабеля до 95 мм2", unit: "м/п", price: 450},
                    {id: 18, name: "Прокладка бронь-кабеля до 240 мм2", unit: "м/п", price: 630},
                    {id: 19, name: "Монтаж греющего кабеля и систем электрообогрева", unit: "м/п", price: 500},
                    {id: 20, name: "Траншея под силовой кабель, закладные трубы до 30см в глубину", unit: "м/п", price: 450},
                    {id: 21, name: "Подушка и засыпка кабеля", unit: "м/п", price: 300},
                    {id: 22, name: "Протяжка СИП. 4/16, 4/25", unit: "м/п", price: 200},
                    {id: 23, name: "Протяжка СИП. 4/35, 4/50", unit: "м/п", price: 250},
                    {id: 24, name: "Слаботочка (тв, интернет)", unit: "м/п", price: 100},
                    {id: 25, name: "Опрессовка наконечников RJ45", unit: "шт.", price: 200},
                    {id: 26, name: "Укладка закладной трубы для протяжки кабелей. До Ø32мм", unit: "м/п", price: 200},
                    {id: 27, name: "Монтаж заводского заземления", unit: "м/п", price: 2000},
                    {id: 28, name: "Монтаж (самодельная из уголков 40х4мм) заземления", unit: "м/п", price: 2300},
                    {id: 29, name: "Монтаж железных лотков 200/300 мм", unit: "м/п", price: 500},
                    {id: 30, name: "Монтаж кабель каналов до 40 мм", unit: "м/п", price: 180},
                    {id: 31, name: "Монтаж кабель каналов от 40 мм до 100 мм", unit: "м/п", price: 250}
                ]
            },
            {
                section: "② Черновые работы",
                items: [
                    {id: 32, name: "Сквозное сверление стены до Ø 18 мм один сантиметр", unit: "см.", price: 20},
                    {id: 33, name: "Сквозное сверление стены Ø 20\\25мм один сантиметр", unit: "см.", price: 25},
                    {id: 34, name: "Сквозное сверление стены Ø 28\\40мм один сантиметр", unit: "см.", price: 35},
                    {id: 35, name: "Сквозное сверление стены Ø 50\\120мм один сантиметр", unit: "см.", price: 38},
                    {id: 36, name: "Штроба по штукатурке (известковая и гипсовая) шириной до 20 мм", unit: "м/п", price: 300},
                    {id: 37, name: "Штроба по кирпичу шириной до 20 мм", unit: "м/п", price: 400},
                    {id: 38, name: "Штроба по бетону шириной до 20 мм. (монолитный, ж/б коэф. Слож. 1,5)", unit: "м/п", price: 600},
                    {id: 40, name: "Штроба замазка", unit: "м/п", price: 150},
                    {id: 41, name: "Сверление подрозетников в блоке до Ø 80 мм", unit: "шт.", price: 150},
                    {id: 42, name: "Сверление подрозетников в кирпиче до Ø 80 мм", unit: "шт.", price: 200},
                    {id: 43, name: "Сверление подрозетников в кирпиче до Ø 80 мм (глубокие)", unit: "шт.", price: 250},
                    {id: 44, name: "Сверление подрозетников в бетоне до Ø80мм (монолитный ж/б коэф. Слож. 1.5)", unit: "шт.", price: 450},
                    {id: 45, name: "Сверление подрозетников в бетоне до Ø 80 мм (глубокие)", unit: "шт.", price: 650},
                    {id: 46, name: "Сверление подрозетников в высокопрочном монолитном жб / до Ø 80 мм", unit: "шт.", price: 670},
                    {id: 47, name: "Сверление и установка подрозетников в гипсокартонной стене Ø 80 мм", unit: "шт.", price: 180},
                    {id: 48, name: "Монтаж подрозетников с гипсовой смесью", unit: "шт.", price: 200},
                    {id: 49, name: "Монтаж в стену распредкоробок или люков под распайки.", unit: "шт.", price: 500}
                ]
            },
            {
                section: "③ Установка щитов",
                items: [
                    {id: 50, name: "Установка бокса (щита) наружного до 24 мод. (Корпус счетчика 220в)", unit: "шт.", price: 1000},
                    {id: 51, name: "Установка бокса (щита) наружного до 60 мод. (Корпус счетчика 380в)", unit: "шт.", price: 1500},
                    {id: 52, name: "Установка бокса (щита) внутреннего до 24 модулей в кирпиче", unit: "шт.", price: 3500},
                    {id: 53, name: "Установка бокса (щита) внутреннего до 24 модулей в бетоне", unit: "шт.", price: 6000},
                    {id: 54, name: "Установка бокса (щита) внутреннего до 36 модулей в кирпиче", unit: "шт.", price: 4500},
                    {id: 55, name: "Установка бокса (щита) внутреннего до 36 модулей в бетоне", unit: "шт.", price: 8000},
                    {id: 56, name: "Установка бокса (щита) внутреннего до 60 модулей в кирпиче", unit: "шт.", price: 6000},
                    {id: 57, name: "Установка бокса (щита) внутреннего до 60 модулей в бетоне", unit: "шт.", price: 10000},
                    {id: 58, name: "Высверливание тех-отверстия", unit: "шт.", price: 500},
                    {id: 59, name: "Подключение Щита, Ввода к щиту, (Соединение Орешками)", unit: "шт.", price: 1500},
                    {id: 60, name: "Маркировка жил и автоматов, (включая коплект маркировки)", unit: "шт.", price: 3000},
                    {id: 61, name: "Сборка автоматов в щите 1P/1 мод (в щитах 60-96 мод): Коэф. 1.5 (2х от 120)", unit: "шт.", price: 500},
                    {id: 62, name: "Формирование узла шин N/PE (расключение свыше 10 жил): Коэф. 1.5", unit: "шт.", price: 500},
                    {id: 63, name: "Установка проходных клемм (зажим Push-in/WAGO)", unit: "шт.", price: 500},
                    {id: 64, name: "Установка РБ (Распределительного блока 80-250а", unit: "шт.", price: 1500},
                    {id: 65, name: "Блок соединительный до 80а 1ф", unit: "шт.", price: 500},
                    {id: 66, name: "Установка УЗО (дифференциального автомата) 220В", unit: "шт.", price: 2000},
                    {id: 67, name: "Установка УЗО (дифференциального автомата) 380В", unit: "шт.", price: 3500},
                    {id: 68, name: "Установка УЗИП (Молниезащита) 220В", unit: "шт.", price: 2000},
                    {id: 69, name: "Установка УЗИП (Молниезащита) 380В", unit: "шт.", price: 3500},
                    {id: 70, name: "Установка контактора (магнитный пускатель) 220В", unit: "шт.", price: 2000},
                    {id: 71, name: "Установка контактора (магнитный пускатель) 380В", unit: "шт.", price: 3000},
                    {id: 72, name: "Кнопка пуск-стоп", unit: "шт.", price: 800},
                    {id: 73, name: "Установка и подключение термо реле к магнитному пускателю", unit: "шт.", price: 1500},
                    {id: 74, name: "Установка и подключение реле времени", unit: "шт.", price: 2000},
                    {id: 75, name: "Установка и подключение РНПП", unit: "шт.", price: 3500},
                    {id: 76, name: "Установка и подключение реле напряжения 220В", unit: "шт.", price: 1500},
                    {id: 77, name: "Установка и подключение реле напряжения, (переключатель фаз 380В)", unit: "шт.", price: 3500},
                    {id: 78, name: "Установка ВРУ до (400А)", unit: "шт.", price: 30000},
                    {id: 79, name: "ВА 100А (Автоматический выключатель)", unit: "шт.", price: 5000},
                    {id: 80, name: "ВА 160А (Автоматический выключатель)", unit: "шт.", price: 5500},
                    {id: 81, name: "ВА 250А (Автоматический выключатель)", unit: "шт.", price: 6000},
                    {id: 82, name: "РР 250А (рубильник реверсивный)", unit: "шт.", price: 6500},
                    {id: 83, name: "РР 400А (рубильник реверсивный)", unit: "шт.", price: 8000},
                    {id: 84, name: "Шины медные (Фазные шины)", unit: "шт.", price: 1000},
                    {id: 85, name: "Опрессовка наконечниками концов кабеля", unit: "шт.", price: 500},
                    {id: 86, name: "Установка счетчика 220В (без напряжения)", unit: "шт.", price: 2500},
                    {id: 87, name: "Установка счетчика 220В (без напряжения) комплект в боксе с автоматами", unit: "шт.", price: 4500},
                    {id: 88, name: "Установка счетчика 380В (без напряжения)", unit: "шт.", price: 3500},
                    {id: 89, name: "Установка счетчика 380В (без напряжения) комплект в боксе и автомат", unit: "шт.", price: 7000},
                    {id: 90, name: "Установка и подключение счётчика косвенного включения (через ТТ)", unit: "шт.", price: 10000},
                    {id: 91, name: "Установка ТТ в цепях учёта счётчика косвенного включения", unit: "шт.", price: 2000},
                    {id: 92, name: "Подключение 2 жильного кабеля на столбе (без подъёмника, 1 столб)", unit: "шт.", price: 3000},
                    {id: 93, name: "Подключение 4 жильного кабеля на столбе (без подъёмника, 1 столб)", unit: "шт.", price: 4000},
                    {id: 94, name: "Подъём на столб.", unit: "шт.", price: 2000},
                    {id: 95, name: "Крепление ВВОДА под карниз на уровне первого этажа", unit: "шт.", price: 3000},
                    {id: 96, name: "Крепление ВВОДА под карниз на уровне второго этажа", unit: "шт.", price: 6000},
                    {id: 97, name: "Установка прожектора (Кобра) на столб", unit: "шт.", price: 3000},
                    {id: 98, name: "Установка прожектора на стену", unit: "шт.", price: 1500}
                ]
            },
            {
                section: "⑤ Чистовая установка",
                items: [
                    {id: 99, name: "Ретро проводка, законченная точка.", unit: "шт.", price: 2500},
                    {id: 100, name: "Розетка, выключатель, накладная и встраиваемая 1 пост", unit: "шт.", price: 250},
                    {id: 101, name: "Перемычки в розеточных группах", unit: "шт.", price: 200},
                    {id: 102, name: "Проходной выключатель одноклавишный", unit: "шт.", price: 500},
                    {id: 103, name: "Проходной (перекрестный) выключатель двухклавишный", unit: "шт.", price: 1200},
                    {id: 104, name: "Розетка силовая 380В, с креплением", unit: "шт.", price: 1500},
                    {id: 105, name: "Розетка для электроплиты", unit: "шт.", price: 1000},
                    {id: 106, name: "Интернет розетка", unit: "шт.", price: 700},
                    {id: 107, name: "ТВ розетка", unit: "шт.", price: 350},
                    {id: 108, name: "Установка смарт‑модуля в подрозетник для системы умного дома", unit: "шт.", price: 1500},
                    {id: 109, name: "Настройка смарт‑модуля под систему умного дома", unit: "шт.", price: 3500},
                    {id: 110, name: "Установка диммера", unit: "шт.", price: 1000},
                    {id: 111, name: "Установка Ножки крепления для ТВ с установкой ТВ", unit: "шт.", price: 4000},
                    {id: 112, name: "Монтаж патрона Е27 с лампой", unit: "шт.", price: 150},
                    {id: 113, name: "Установка датчиков, фотореле, датчик движения и тд.", unit: "шт.", price: 1500},
                    {id: 114, name: "Установка, сборка люстр по запчастям рожок 500р (не ниже 2000р)", unit: "шт.", price: 500},
                    {id: 115, name: "Установка люстры уже в собранном виде рожок 350р (не ниже 2000р)", unit: "шт.", price: 350},
                    {id: 116, name: "Установка светодиодной люстры (Простая установка)", unit: "шт.", price: 3000},
                    {id: 117, name: "Установка бра", unit: "шт.", price: 1500},
                    {id: 118, name: "Установка точечных светильников", unit: "шт.", price: 500},
                    {id: 119, name: "Разметка и высверливание отверстий для точечных светильников", unit: "шт.", price: 500},
                    {id: 120, name: "Монтаж трековых светильников", unit: "м/п", price: 1500},
                    {id: 121, name: "Монтаж трековых светильников (На тросах)", unit: "м/п", price: 1800},
                    {id: 122, name: "Гирлянда с патронами Е27", unit: "м/п", price: 500},
                    {id: 123, name: "Диодные ленты 220В", unit: "м/п", price: 500},
                    {id: 124, name: "Диодные ленты 12/24В", unit: "м/п", price: 600},
                    {id: 125, name: "Монтаж алюминиевого профиля для светодиодной ленты", unit: "м/п", price: 500},
                    {id: 126, name: "Распил угла профиля для светодиодной ленты", unit: "м/п", price: 500},
                    {id: 127, name: "Монтаж блока 12В, 24В, 220В", unit: "шт.", price: 1500},
                    {id: 128, name: "Установка Светильников, Армстронг, линейные, плафоны,", unit: "шт.", price: 1200},
                    {id: 129, name: "Светильники в подвесной потолок, Линии Армстронг и остальные.", unit: "шт.", price: 800},
                    {id: 130, name: "Монтаж и выравнивание подвесных светильников на тросах.", unit: "шт.", price: 1800},
                    {id: 131, name: "Светильник садовый, столб для сада.", unit: "м/п", price: 3000},
                    {id: 132, name: "Бетонное основание для светильника", unit: "шт.", price: 2000},
                    {id: 133, name: "Установка домофона с замком. (Отдельно замок или домофон 5000т)", unit: "шт.", price: 10000},
                    {id: 134, name: "Установка вытяжки Ø 120", unit: "шт.", price: 1500},
                    {id: 135, name: "Поиск замыканий за точку (устранение не входит в цену)", unit: "шт.", price: 3500},
                    {id: 136, name: "Прозвонка кабеля (с точки А до точки Б) (обсудить заранее с заказчиком)", unit: "шт.", price: 200},
                    {id: 137, name: "Удлинение вводного кабеля с опрессовкой, за 1 жилу", unit: "шт.", price: 1000},
                    {id: 138, name: "Установка Полотенце сушилки", unit: "шт.", price: 3500},
                    {id: 139, name: "Замер заземления", unit: "шт.", price: 3000},
                    {id: 140, name: "Установка стабилизатора 220v", unit: "шт.", price: 5000},
                    {id: 141, name: "Установка стабилизатора 380v", unit: "шт.", price: 6500}
                ]
            }
        ];

        // Глобальные переменные
        let estimateData = [];
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        let nextMaterialId = 1000;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, начинаем инициализацию');
            
            // Для iOS применяем исправления
            if (isIOS) {
                console.log('Обнаружен iOS, применяем исправления');
                initForIOS();
                
                // Задержка для iOS чтобы все успело загрузиться
                setTimeout(initializeApp, 100);
            } else {
                initializeApp();
            }
        });

        function initializeApp() {
            console.log('Инициализация приложения');
            
            // Инициализируем данные сметы
            initializeEstimateData();
            
            // Рендерим все
            renderPriceList();
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            
            // Настраиваем обработчики
            setupEventListeners();
            setupDate();
            
            // Показываем первую вкладку
            showTab('price');
            
            // Показываем уведомление о загрузке
            setTimeout(() => {
                showNotification('ЭлектроСмета загружена и готова к работе!');
            }, 500);
            
            console.log('Приложение инициализировано');
        }

        function initializeEstimateData() {
            // Создаем 20 пустых строк для сметы
            estimateData = Array(20).fill().map((_, i) => ({
                id: i + 1,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false
            }));
        }

        // Функции для вкладок
        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем нужную вкладку
            const tabContent = document.getElementById(`${tabName}-tab`);
            const tabBtn = document.getElementById(`${tabName}TabBtn`);
            
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            if (tabBtn) {
                tabBtn.classList.add('active');
            }
        }

        // Рендеринг прайс-листа
        function renderPriceList() {
            console.log('Рендеринг прайс-листа');
            const priceListContainer = document.getElementById('priceList');
            
            if (!priceListContainer) {
                console.error('Контейнер прайс-листа не найден!');
                return;
            }
            
            priceListContainer.innerHTML = '';
            
            priceData.forEach(section => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'price-section';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    ${section.section}
                    <i class="fas fa-chevron-down"></i>
                `;
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'section-content';
                
                // Раскрываем первую секцию по умолчанию
                if (section.section.includes("① Монтажные работы")) {
                    itemsContainer.classList.add('expanded');
                    sectionHeader.querySelector('i').className = 'fas fa-chevron-up';
                }
                
                section.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'price-item';
                    itemElement.dataset.id = item.id;
                    itemElement.innerHTML = `
                        <div class="item-number">${item.id}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-unit">${item.unit}</div>
                        <div class="item-price">${formatCurrency(item.price)}</div>
                    `;
                    
                    // Обработчик для добавления в смету
                    itemElement.addEventListener('click', function() {
                        addToEstimate(item);
                        showTab('estimate');
                        showNotification(`Добавлено: ${item.name.substring(0, 30)}...`);
                    });
                    
                    itemsContainer.appendChild(itemElement);
                });
                
                // Обработчик раскрытия/скрытия секции
                sectionHeader.addEventListener('click', function() {
                    const isExpanded = itemsContainer.classList.contains('expanded');
                    const icon = this.querySelector('i');
                    
                    if (isExpanded) {
                        itemsContainer.classList.remove('expanded');
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        itemsContainer.classList.add('expanded');
                        icon.className = 'fas fa-chevron-up';
                    }
                });
                
                sectionElement.appendChild(sectionHeader);
                sectionElement.appendChild(itemsContainer);
                priceListContainer.appendChild(sectionElement);
            });
            
            console.log('Прайс-лист отрендерен');
        }

        // Рендеринг таблицы сметы
        function renderEstimateTable() {
            const tableBody = document.getElementById('estimateTable');
            if (!tableBody) {
                console.error('Таблица сметы не найдена!');
                return;
            }
            
            tableBody.innerHTML = '';
            
            estimateData.forEach((row, index) => {
                const tr = document.createElement('tr');
                if (row.isMaterial) {
                    tr.classList.add('material-row');
                }
                
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td class="price-id-cell">${row.isMaterial ? 'МАТ' : (row.priceId || '')}</td>
                    <td class="search-cell">
                        <input type="text" class="search-input" 
                               data-row="${index}" 
                               value="${row.name}"
                               placeholder="${row.isMaterial ? 'Материал...' : 'Начните вводить название...'}"
                               autocomplete="off">
                        <div class="dropdown" id="dropdown-${index}"></div>
                    </td>
                    <td class="unit-cell">${row.unit || ''}</td>
                    <td class="price-cell">
                        <input type="number" class="number-input price-input" 
                               data-row="${index}" 
                               value="${row.price || ''}" 
                               min="0" step="0.01">
                    </td>
                    <td class="quantity-cell">
                        <input type="number" class="number-input quantity-input" 
                               data-row="${index}" 
                               value="${row.quantity || 1}" 
                               min="1" step="1">
                    </td>
                    <td class="total-cell">${formatCurrency(row.total)}</td>
                    <td class="actions-cell">
                        <i class="fas fa-trash delete-row" data-row="${index}"></i>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            // Настраиваем обработчики событий для новых строк
            setupRowEventListeners();
        }

        function setupEventListeners() {
            console.log('Настройка обработчиков событий');
            
            // Вкладки
            document.getElementById('priceTabBtn').addEventListener('click', function() {
                showTab('price');
            });
            
            document.getElementById('estimateTabBtn').addEventListener('click', function() {
                showTab('estimate');
            });
            
            // Поиск по прайс-листу
            const priceSearch = document.getElementById('priceSearch');
            if (priceSearch) {
                priceSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const allItems = document.querySelectorAll('.price-item');
                    
                    allItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = 'grid';
                            // Раскрываем родительскую секцию
                            const section = item.closest('.price-section');
                            if (section) {
                                const content = section.querySelector('.section-content');
                                content.classList.add('expanded');
                                section.querySelector('i').className = 'fas fa-chevron-up';
                            }
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // Выпадающее меню управления
            const dropdownBtn = document.getElementById('controlsDropdown');
            const menu = document.getElementById('controlsMenu');
            
            if (dropdownBtn && menu) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    menu.classList.toggle('show');
                });
                
                // Закрытие меню при клике вне его
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.dropdown-controls')) {
                        menu.classList.remove('show');
                    }
                });
                
                // Кнопки меню
                document.getElementById('addRowBtn').addEventListener('click', function() {
                    addEmptyRow();
                    updateEstimateCounter();
                    menu.classList.remove('show');
                });
                
                document.getElementById('addMaterialBtn').addEventListener('click', function() {
                    showMaterialModal();
                    menu.classList.remove('show');
                });
                
                document.getElementById('clearEstimateBtn').addEventListener('click', function() {
                    if (confirm('Вы уверены, что хотите очистить всю смету?')) {
                        clearEstimate();
                        updateEstimateCounter();
                    }
                    menu.classList.remove('show');
                });
                
                document.getElementById('saveEstimateBtn').addEventListener('click', function() {
                    saveEstimate();
                    menu.classList.remove('show');
                });
                
                document.getElementById('loadEstimateBtn').addEventListener('click', function() {
                    showLoadModal();
                    menu.classList.remove('show');
                });
                
                document.getElementById('printEstimateBtn').addEventListener('click', function() {
                    showPrintModal();
                    menu.classList.remove('show');
                });
                
                document.getElementById('saveAsPdfBtn').addEventListener('click', function() {
                    saveAsPDF();
                    menu.classList.remove('show');
                });
                
                document.getElementById('printPriceBtn').addEventListener('click', function() {
                    printPriceList();
                });
            }
            
            // Модальные окна
            document.getElementById('closeMaterialModal').addEventListener('click', function() {
                document.getElementById('materialModal').style.display = 'none';
            });
            
            document.getElementById('closePrintModal').addEventListener('click', function() {
                document.getElementById('printModal').style.display = 'none';
            });
            
            document.getElementById('closeLoadModal').addEventListener('click', function() {
                document.getElementById('loadModal').style.display = 'none';
            });
            
            document.getElementById('addMaterialToEstimate').addEventListener('click', function() {
                addMaterialFromModal();
            });
            
            document.getElementById('generatePrint').addEventListener('click', function() {
                generatePrint();
            });
            
            // Закрытие модальных окон при клике на фон
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            console.log('Обработчики событий настроены');
        }

        function setupRowEventListeners() {
            // Поиск и выпадающий список
            document.querySelectorAll('.search-input').forEach(input => {
                const rowIndex = parseInt(input.dataset.row);
                const row = estimateData[rowIndex];
                
                if (!row.isMaterial) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        } else {
                            hideDropdown(rowIndex);
                        }
                    });
                    
                    input.addEventListener('focus', function() {
                        const searchTerm = this.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        }
                    });
                }
            });
            
            // Закрытие выпадающих списков
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('search-input')) {
                    hideAllDropdowns();
                }
            });
            
            // Изменение цены
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    updateRowTotal(rowIndex);
                    updateEstimateCounter();
                });
            });
            
            // Изменение количества
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    updateRowTotal(rowIndex);
                    updateEstimateCounter();
                });
            });
            
            // Удаление строки
            document.querySelectorAll('.delete-row').forEach(button => {
                button.addEventListener('click', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    deleteRow(rowIndex);
                    updateEstimateCounter();
                });
            });
        }

        // Основные функции приложения
        function addToEstimate(item) {
            // Ищем первую пустую строку
            let emptyRowIndex = estimateData.findIndex(row => !row.priceId && !row.isMaterial && row.name.trim() === '');
            
            // Если пустых строк нет, добавляем новую
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            // Заполняем строку
            estimateData[emptyRowIndex] = {
                ...estimateData[emptyRowIndex],
                priceId: item.id,
                name: item.name,
                unit: item.unit,
                price: item.price,
                quantity: 1,
                total: item.price,
                isMaterial: false
            };
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
        }

        function addEmptyRow() {
            const newId = estimateData.length + 1;
            estimateData.push({
                id: newId,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false
            });
            
            renderEstimateTable();
        }

        function deleteRow(rowIndex) {
            if (estimateData.length <= 1) {
                alert('Смета должна содержать хотя бы одну строку');
                return;
            }
            
            estimateData.splice(rowIndex, 1);
            
            // Обновляем порядковые номера
            estimateData.forEach((row, index) => {
                row.id = index + 1;
            });
            
            renderEstimateTable();
            updateTotals();
        }

        function updateRowTotal(rowIndex) {
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            const quantityInput = document.querySelector(`.quantity-input[data-row="${rowIndex}"]`);
            
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 1;
            
            estimateData[rowIndex].price = price;
            estimateData[rowIndex].quantity = quantity;
            estimateData[rowIndex].total = price * quantity;
            
            const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
            if (totalCell) {
                totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
            }
            
            updateTotals();
        }

        function updateTotals() {
            const totalAmount = estimateData.reduce((sum, row) => sum + row.total, 0);
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        function updateEstimateCounter() {
            const filledRows = estimateData.filter(row => 
                (row.priceId || row.name.trim() !== '') && !row.isMaterial
            ).length;
            
            const counterElement = document.getElementById('estimateCounter');
            counterElement.textContent = filledRows;
            
            if (filledRows === 0) {
                counterElement.style.backgroundColor = '#6c757d';
            } else if (filledRows < 5) {
                counterElement.style.backgroundColor = '#f39c12';
            } else {
                counterElement.style.backgroundColor = '#27ae60';
            }
        }

        function clearEstimate() {
            estimateData = Array(20).fill().map((_, i) => ({
                id: i + 1,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false
            }));
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            showNotification('Смета очищена');
        }

        // Материалы
        function showMaterialModal() {
            document.getElementById('materialName').value = '';
            document.getElementById('materialUnit').value = 'шт.';
            document.getElementById('materialPrice').value = '';
            document.getElementById('materialQuantity').value = '1';
            
            document.getElementById('materialModal').style.display = 'flex';
        }

        function addMaterialFromModal() {
            const name = document.getElementById('materialName').value.trim();
            const unit = document.getElementById('materialUnit').value;
            const price = parseFloat(document.getElementById('materialPrice').value) || 0;
            const quantity = parseInt(document.getElementById('materialQuantity').value) || 1;
            
            if (!name) {
                alert('Введите наименование материала');
                return;
            }
            
            if (price <= 0) {
                alert('Введите корректную цену');
                return;
            }
            
            let emptyRowIndex = estimateData.findIndex(row => row.name.trim() === '');
            
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            estimateData[emptyRowIndex] = {
                id: estimateData[emptyRowIndex].id,
                priceId: `MAT${nextMaterialId++}`,
                name: name,
                unit: unit,
                price: price,
                quantity: quantity,
                total: price * quantity,
                notes: "",
                isMaterial: true
            };
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            document.getElementById('materialModal').style.display = 'none';
            
            showTab('estimate');
            showNotification(`Материал добавлен: ${name.substring(0, 30)}...`);
        }

        // Выпадающие списки
        function showDropdown(rowIndex, searchTerm) {
            hideAllDropdowns();
            
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            dropdown.innerHTML = '';
            
            const matches = [];
            priceData.forEach(section => {
                section.items.forEach(item => {
                    if (item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        item.id.toString().includes(searchTerm)) {
                        matches.push(item);
                    }
                });
            });
            
            if (matches.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item';
                noResults.textContent = 'Ничего не найдено';
                dropdown.appendChild(noResults);
            } else {
                matches.slice(0, 10).forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'dropdown-item';
                    itemElement.innerHTML = `
                        <strong>${item.id}</strong>: ${item.name.substring(0, 50)}${item.name.length > 50 ? '...' : ''} (${item.unit}) - ${formatCurrency(item.price)}
                    `;
                    
                    itemElement.addEventListener('click', function() {
                        selectPriceItem(rowIndex, item);
                        hideDropdown(rowIndex);
                    });
                    
                    dropdown.appendChild(itemElement);
                });
            }
            
            dropdown.style.display = 'block';
        }

        function hideDropdown(rowIndex) {
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }

        function selectPriceItem(rowIndex, item) {
            const searchInput = document.querySelector(`.search-input[data-row="${rowIndex}"]`);
            const priceIdCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .price-id-cell`);
            const unitCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .unit-cell`);
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            
            if (searchInput && priceIdCell && unitCell && priceInput) {
                searchInput.value = item.name;
                priceIdCell.textContent = item.id;
                unitCell.textContent = item.unit;
                priceInput.value = item.price;
                
                estimateData[rowIndex].priceId = item.id;
                estimateData[rowIndex].name = item.name;
                estimateData[rowIndex].unit = item.unit;
                estimateData[rowIndex].price = item.price;
                estimateData[rowIndex].total = item.price * estimateData[rowIndex].quantity;
                estimateData[rowIndex].isMaterial = false;
                
                const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
                if (totalCell) {
                    totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
                }
                
                updateTotals();
                updateEstimateCounter();
            }
        }

        // Сохранение и загрузка
        function saveEstimate() {
            const estimateName = prompt('Введите название для сохранения сметы:', `Смета ${new Date().toLocaleDateString()}`);
            
            if (estimateName) {
                const filledData = estimateData.filter(row => row.priceId || row.name.trim() !== '');
                
                const estimateToSave = {
                    id: Date.now(),
                    name: estimateName,
                    date: new Date().toISOString(),
                    data: filledData,
                    totals: {
                        totalAmount: parseFloat(document.getElementById('totalAmount').textContent.replace(/\s/g, ''))
                    }
                };
                
                savedEstimates.push(estimateToSave);
                localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
                
                showNotification(`Смета "${estimateName}" сохранена`);
            }
        }

        function showLoadModal() {
            const listContainer = document.getElementById('savedEstimatesList');
            listContainer.innerHTML = '';
            
            if (savedEstimates.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666;">Нет сохраненных смет.</p>';
            } else {
                savedEstimates.forEach(estimate => {
                    const estimateElement = document.createElement('div');
                    estimateElement.className = 'dropdown-item';
                    estimateElement.style.cursor = 'pointer';
                    estimateElement.innerHTML = `
                        <strong>${estimate.name}</strong><br>
                        <small>${new Date(estimate.date).toLocaleDateString()}, 
                        ${estimate.data.length} позиций, 
                        Итого: ${formatCurrency(estimate.totals.totalAmount)}</small>
                        <button class="delete-saved" data-id="${estimate.id}" style="float: right; background: none; border: none; color: #e74c3c; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    estimateElement.addEventListener('click', function(e) {
                        if (!e.target.closest('.delete-saved')) {
                            loadEstimate(estimate.id);
                            document.getElementById('loadModal').style.display = 'none';
                        }
                    });
                    
                    const deleteBtn = estimateElement.querySelector('.delete-saved');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('Удалить эту сохраненную смету?')) {
                            deleteSavedEstimate(estimate.id);
                        }
                    });
                    
                    listContainer.appendChild(estimateElement);
                });
            }
            
            document.getElementById('loadModal').style.display = 'flex';
        }

        function loadEstimate(estimateId) {
            const estimate = savedEstimates.find(e => e.id === estimateId);
            
            if (estimate) {
                estimateData = Array(20).fill().map((_, i) => ({
                    id: i + 1,
                    priceId: "",
                    name: "",
                    unit: "",
                    price: 0,
                    quantity: 1,
                    total: 0,
                    notes: "",
                    isMaterial: false
                }));
                
                estimate.data.forEach((item, index) => {
                    if (index < 20) {
                        estimateData[index] = { ...item, id: index + 1 };
                    }
                });
                
                renderEstimateTable();
                updateTotals();
                updateEstimateCounter();
                showTab('estimate');
                showNotification(`Загружена смета: ${estimate.name}`);
            }
        }

        function deleteSavedEstimate(estimateId) {
            savedEstimates = savedEstimates.filter(e => e.id !== estimateId);
            localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
            showLoadModal();
        }

        // Печать
        function showPrintModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('estimateDate').value = today;
            
            const estimateCount = savedEstimates.length + 1;
            document.getElementById('estimateNumber').value = `СМ-${estimateCount.toString().padStart(3, '0')}`;
            
            document.getElementById('printModal').style.display = 'flex';
        }

        function generatePrint() {
            const clientName = document.getElementById('clientName').value || 'Клиент не указан';
            const estimateNumber = document.getElementById('estimateNumber').value;
            const estimateDate = document.getElementById('estimateDate').value;
            const notes = document.getElementById('notes').value;
            
            const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '');
            
            if (filledRows.length === 0) {
                alert('Смета пуста! Добавьте позиции перед печатью.');
                return;
            }
            
            const totalAmount = filledRows.reduce((sum, row) => sum + row.total, 0);
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Смета ${estimateNumber}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            margin: 0;
                            font-size: 14px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                        }
                        h1 {
                            margin: 0 0 10px 0;
                            font-size: 18px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 8px;
                            text-align: left;
                            font-size: 12px;
                        }
                        th {
                            background: #f0f0f0;
                            font-weight: bold;
                        }
                        .total {
                            text-align: right;
                            font-size: 16px;
                            font-weight: bold;
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 2px solid #000;
                        }
                        .notes {
                            margin-top: 20px;
                            padding: 10px;
                            background: #f9f9f9;
                            border-left: 4px solid #3498db;
                        }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>СМЕТА № ${estimateNumber}</h1>
                        <div>на электромонтажные работы</div>
                        <div><strong>Клиент:</strong> ${clientName} | <strong>Дата:</strong> ${new Date(estimateDate).toLocaleDateString('ru-RU')}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th width="5%">№</th>
                                <th width="10%">Код</th>
                                <th>Наименование</th>
                                <th width="8%">Ед.</th>
                                <th width="12%">Цена, руб.</th>
                                <th width="8%">Кол-во</th>
                                <th width="12%">Сумма, руб.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filledRows.map((row, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${row.priceId || ''}</td>
                                    <td>${row.name || ''}</td>
                                    <td>${row.unit || ''}</td>
                                    <td>${formatCurrency(row.price)}</td>
                                    <td>${row.quantity}</td>
                                    <td>${formatCurrency(row.total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        Итого: ${formatCurrency(totalAmount)} руб.
                    </div>
                    
                    ${notes ? `
                    <div class="notes">
                        <strong>Примечания:</strong><br>
                        ${notes.replace(/\n/g, '<br>')}
                    </div>
                    ` : ''}
                    
                    <div class="notes" style="margin-top: 20px; font-size: 11px;">
                        <strong>Примечание:</strong> Смета составлена с использованием приложения ЭлектроСмета<br>
                        Дата формирования: ${new Date().toLocaleString('ru-RU')}
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            // Для iOS используем другой метод
            if (isIOS) {
                // Открываем в новом окне
                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Даем время на загрузку
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                }
            } else {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }
            
            document.getElementById('printModal').style.display = 'none';
        }

        function printPriceList() {
            let printContent = '<h2>Прайс-лист электромонтажных работ ЧР</h2><style>body{font-family:Arial;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;}th{background:#f0f0f0;}</style><table>';
            
            priceData.forEach(section => {
                printContent += `<tr><th colspan="4">${section.section}</th></tr>`;
                section.items.forEach(item => {
                    printContent += `<tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${formatCurrency(item.price)}</td>
                    </tr>`;
                });
            });
            
            printContent += '</table>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            if (!isIOS) {
                printWindow.print();
            } else {
                // Для iOS просто показываем контент
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
            }
        }

        function saveAsPDF() {
            // Для iOS используем печать
            if (isIOS) {
                alert('Для сохранения в PDF на iOS используйте функцию печати и выберите "Сохранить как PDF"');
                showPrintModal();
                return;
            }
            
            showPrintModal();
        }

        // Вспомогательные функции
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function setupDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('estimateDate').value = today;
        }

        function showNotification(message) {
            // Создаем уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #2c3e50;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideDown 0.3s ease;
                max-width: 80%;
                text-align: center;
                word-break: break-word;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                    if (document.head.contains(style)) {
                        document.head.removeChild(style);
                    }
                }, 300);
            }, 2000);
        }

        // Для отладки
        console.log('Скрипт загружен');
    </script>
</body>
</html>
