// После объявления window.addEventListener('message', ...)
// Добавьте проверку сохраненного кода

// Проверяем, есть ли временный код в localStorage
const tempCode = localStorage.getItem('temp_auth_code');
const tempState = localStorage.getItem('temp_auth_state');

if (tempCode) {
    console.log('Найден сохраненный код авторизации');
    
    // Очищаем временное хранилище
    localStorage.removeItem('temp_auth_code');
    localStorage.removeItem('temp_auth_state');
    
    // Обрабатываем код как если бы пришло сообщение
    setTimeout(() => {
        // Имитируем сообщение
        const fakeEvent = {
            data: {
                type: 'auth_code',
                code: tempCode,
                state: tempState || 'base_auth'
            },
            origin: 'https://alivu.github.io'
        };
        
        // Вызываем обработчик
        const messageHandler = window.onmessage || 
            window.addEventListener('message', function handler(event) {
                if (event.data.type === 'auth_code') {
                    window.removeEventListener('message', handler);
                    // Здесь должен быть ваш код обработки кода
                    handleAuthCode(event.data.code, event.data.state);
                }
            });
        
        // Или просто обменяем код на токены напрямую
        exchangeCodeForTokens(tempCode, tempState);
        
    }, 500);
}

// Функция для обмена кода на токены
async function exchangeCodeForTokens(code, state) {
    const codeVerifier = localStorage.getItem('pkce_code_verifier');
    
    if (!codeVerifier) {
        console.error('Нет code verifier');
        return;
    }
    
    try {
        showNotification('⏳ Получение токенов...');
        
        const response = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                code: code,
                client_id: '1005885507362-vsplr1th18mhk2uj6prb2akump2c20tb.apps.googleusercontent.com',
                redirect_uri: 'https://alivu.github.io/electro-smeta/oauth-callback.html',
                grant_type: 'authorization_code',
                code_verifier: codeVerifier
            })
        });
        
        const tokens = await response.json();
        
        if (tokens.error) {
            throw new Error(tokens.error_description || tokens.error);
        }
        
        console.log('Токены получены:', tokens);
        
        // Сохраняем токены
        if (tokens.refresh_token) {
            localStorage.setItem('google_refresh_token', tokens.refresh_token);
        }
        
        sessionStorage.setItem('google_access_token', tokens.access_token);
        sessionStorage.setItem('google_token_expiry', Date.now() + tokens.expires_in * 1000);
        
        localStorage.removeItem('pkce_code_verifier');
        
        // Получаем информацию о пользователе
        const userResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { 'Authorization': `Bearer ${tokens.access_token}` }
        });
        
        const user = await userResponse.json();
        
        localStorage.setItem('google_user', JSON.stringify(user));
        localStorage.setItem('google_token', tokens.access_token);
        window.googleToken = tokens.access_token;
        
        updateGoogleUI(user);
        showNotification(`✅ Вход выполнен: ${user.email}`);
        
    } catch (error) {
        console.error('Ошибка получения токенов:', error);
        showNotification('❌ Ошибка авторизации: ' + error.message);
    }
}
